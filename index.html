<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reconcilia√ß√£o de Invent√°rio (com IA)</title>
    <!-- Carregando Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definindo a fonte padr√£o e ajustes visuais */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        textarea {
            resize: none;
            height: 250px; /* Altura reduzida para dar espa√ßo aos novos bot√µes */
            @apply shadow-inner;
        }
        /* Responsividade da tabela */
        @media (max-width: 640px) {
            .responsive-table th, .responsive-table td {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                font-size: 0.75rem; /* extra small */
            }
        }
        .table-container { max-height: 600px; } /* Altura m√°xima para rolagem na tabela */
        
        /* Estilo do loader da IA */
        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid #3498db;
            border-radius: 50%; width: 16px; height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Esmeralda (Com Tombo) */
                        'primary-dark': '#059669',
                        'secondary': '#8b5cf6', /* Violeta (Sem Tombo) */
                        'secondary-dark': '#7c3aed',
                        'inventario': '#3b82f6', /* Azul */
                        'sistema': '#f97316', /* Laranja */
                        'export': '#d946ef', /* F√∫csia */
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 border-b-4 border-primary pb-2 flex items-center">
            Sistema de Reconcilia√ß√£o de Invent√°rio (com IA) üìä‚ú®
        </h1>
        <p class="text-gray-600 mb-6">
            Cole os dados (TSV/CSV) para conciliar o estoque. O sistema agora separa a an√°lise de itens COM Tombo (usando IA para discrep√¢ncias) e itens SEM Tombo (por quantidade).
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Invent√°rio (Fonte) -->
            <div>
                <label for="list-inventario" class="block text-lg font-semibold text-inventario mb-2 flex items-center">
                    <span class="mr-2">üìã</span>
                    1. Dados do Invent√°rio (Fonte da Verdade)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Cabe√ßalho Esperado:** Unidade, Item, Tombo, Local, Estado de Conserva√ß√£o
                </p>
                <textarea id="list-inventario" class="w-full p-3 border border-inventario rounded-lg focus:ring-inventario focus:border-inventario transition duration-150" placeholder="Cole aqui os dados do Invent√°rio, incluindo o cabe√ßalho..."></textarea>
                <span id="count-inventario" class="text-sm text-gray-500 mt-1 block">Total de Itens no Invent√°rio: 0</span>
            </div>
            
            <!-- Sistema (Destino) -->
            <div>
                <label for="list-sistema" class="block text-lg font-semibold text-sistema mb-2 flex items-center">
                    <span class="mr-2">‚öôÔ∏è</span>
                    2. Dados do Sistema (Estoque Atual)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Cabe√ßalho Esperado:** Tipo, Tombamento, Descri√ß√£o, Unidade, Localiza√ß√£o, Estado, Origem da Doa√ß√£o, Observa√ß√£o, Fornecedor
                </p>
                <textarea id="list-sistema" class="w-full p-3 border border-sistema rounded-lg focus:ring-sistema focus:border-sistema transition duration-150" placeholder="Cole aqui os dados do Sistema, incluindo o cabe√ßalho..."></textarea>
                <span id="count-sistema" class="text-sm text-gray-500 mt-1 block">Total de Itens no Sistema: 0</span>
            </div>
        </div>

        <!-- NOVOS BOT√ïES DE A√á√ÉO -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
             <button onclick="reconcileInventory(true)" class="w-full px-6 py-3 bg-primary text-white font-bold text-lg rounded-xl shadow-lg hover:bg-primary-dark transition duration-300 transform hover:scale-[1.01]">
                1. Reconciliar Itens COM Tombo (Usar IA)
            </button>
             <button onclick="reconcileInventory(false)" class="w-full px-6 py-3 bg-secondary text-white font-bold text-lg rounded-xl shadow-lg hover:bg-secondary-dark transition duration-300 transform hover:scale-[1.01]">
                2. Analisar Itens SEM Tombo (por Quantidade)
            </button>
        </div>
        
        <!-- Mensagem de Erro da API -->
        <div id="api-error" class="hidden p-4 mb-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"></div>

        <!-- Container de Resultados - COM Tombo -->
        <div id="results-container-tombo" class="mt-12 hidden">
            
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">
                Relat√≥rio de Reconcilia√ß√£o (Itens COM Tombo)
            </h2>
            
            <!-- Filtro por Unidade (CRAS) -->
            <div id="unit-filter-container">
                <!-- Dropdown ser√° injetado aqui -->
            </div>

            <!-- Resumo -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-4 rounded-lg bg-blue-100 shadow-md">
                    <p class="text-3xl font-bold text-blue-700" id="total-inventario-final">0</p>
                    <p class="text-sm text-blue-600">Total Invent√°rio (Base)</p>
                </div>
                <div class="p-4 rounded-lg bg-green-100 shadow-md">
                    <p class="text-3xl font-bold text-green-700" id="total-adicionar">0</p>
                    <p class="text-sm text-green-600">A√ß√£o: Adicionar (Faltando no Sistema)</p>
                </div>
                <div class="p-4 rounded-lg bg-red-100 shadow-md">
                    <p class="text-3xl font-bold text-red-700" id="total-excluir">0</p>
                    <p class="text-sm text-red-600">A√ß√£o: Excluir (Sobrante no Sistema)</p>
                </div>
            </div>

            <!-- NOVO BLOCO: ITENS FALTANDO (ADICIONAR) -->
            <div id="missing-items-container" class="mt-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b-2 border-green-500 pb-1 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                    </svg>
                    Itens Faltando no Sistema (Para ADICIONAR) üü¢
                </h3>
                <p class="text-sm text-gray-600 mb-2">Estes itens est√£o no Invent√°rio Base, mas n√£o foram encontrados no Sistema. Eles devem ser adicionados ao estoque, no local listado do Invent√°rio (Lista 1).</p>
                <div class="overflow-x-auto rounded-lg shadow-xl">
                    <table class="min-w-full bg-white responsive-table">
                        <thead class="bg-green-100 border-b-2 border-green-300 sticky top-0">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Item (Descri√ß√£o)</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tombo</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Local Exato (Invent√°rio)</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unidade</th>
                            </tr>
                        </thead>
                        <tbody id="missing-items-body" class="divide-y divide-gray-200">
                            <!-- Itens faltantes ser√£o injetados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- FIM DO NOVO BLOCO -->


            <!-- Export Button -->
            <button onclick="exportCSV(true)" class="w-full md:w-auto px-6 py-2 bg-export text-white font-bold rounded-lg shadow-md hover:bg-fuchsia-700 transition duration-300 transform hover:scale-[1.01] mb-4 mt-8">
                Exportar Relat√≥rio CSV (Unidade Selecionada)
            </button>
            
            <!-- Tabela Principal de Resultados (Completa) -->
            <div class="overflow-x-auto rounded-lg shadow-xl table-container">
                <h3 class="text-lg font-bold text-gray-700 mb-2">Tabela de Reconcilia√ß√£o Detalhada (Itens COM Tombo)</h3>
                <table class="min-w-full bg-white responsive-table">
                    <thead class="bg-gray-200 border-b-2 border-gray-300 sticky top-0">
                        <tr>
                            <!-- Cabe√ßalho do Sistema + A√ß√£o -->
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">A√ß√£o Sugerida</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tombamento</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Localiza√ß√£o (Sis vs Inv)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unidade</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descri√ß√£o (Sis vs Inv)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Estado (Sis vs Inv)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Crit√©rio/Observa√ß√£o (e Verifica√ß√£o IA)</th>
                        </tr>
                    </thead>
                    <tbody id="results-body" class="divide-y divide-gray-200">
                        <!-- Resultados ser√£o injetados aqui -->
                    </tbody>
                </table>
            </div>

            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Observa√ß√£o Importante sobre a Contagem</h3>
                <p id="summary-text" class="text-yellow-700">Aguardando a an√°lise da unidade selecionada...</p>
            </div>
        </div>
        
        <!-- Container de Resultados - SEM Tombo -->
        <div id="results-container-no-tombo" class="mt-12 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-secondary pb-2">
                Relat√≥rio de Auditoria (Itens SEM Tombo)
            </h2>
            <p class="text-gray-600 mb-4">
                Este relat√≥rio agrupa itens sem tombo por Local e Descri√ß√£o para encontrar discrep√¢ncias de quantidade (Ex: "3 Cadeiras" vs "3 Cadeiras Brancas").
            </p>
            
            <!-- Export Button -->
            <button onclick="exportCSV(false)" class="w-full md:w-auto px-6 py-2 bg-export text-white font-bold rounded-lg shadow-md hover:bg-fuchsia-700 transition duration-300 transform hover:scale-[1.01] mb-4">
                Exportar Auditoria CSV
            </button>

            <div class="overflow-x-auto rounded-lg shadow-xl table-container mt-4">
                <table class="min-w-full bg-white responsive-table">
                    <thead class="bg-purple-100 border-b-2 border-purple-300 sticky top-0">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Local (Agrupado)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descri√ß√£o (Agrupada)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Qtd. Invent√°rio</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Qtd. Sistema</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Diferen√ßa (Inv - Sis)</th>
                        </tr>
                    </thead>
                    <tbody id="results-body-no-tombo" class="divide-y divide-gray-200">
                        <!-- Resultados da auditoria de quantidade ser√£o injetados aqui -->
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <script>
        // Global variables for storing and managing data
        let reconciledDataByUnit = {};
        let inventarioTotalByUnit = {};
        let noTomboAuditData = []; // Para a auditoria de quantidade

        // Mapeamento de colunas do Invent√°rio para o padr√£o do Sistema
        const INVENTARIO_MAP = {
            'Tombo': 'Tombamento',
            'Item': 'Descri√ß√£o',
            'Local': 'Localiza√ß√£o',
            'Estado de Conserva√ß√£o': 'Estado',
            'Unidade': 'Unidade'
        };

        const SISTEMA_HEADERS = [
            'Tipo', 'Tombamento', 'Descri√ß√£o', 'Unidade', 
            'Localiza√ß√£o', 'Estado', 'Origem da Doa√ß√£o', 
            'Observa√ß√£o', 'Fornecedor'
        ];
        
        // --- IN√çCIO: L√≥gica da API Gemini ---
        
        // Fun√ß√£o para exibir erros da API
        function showApiError(message) {
            const errorDiv = document.getElementById('api-error');
            errorDiv.textContent = `Erro na API: ${message}`;
            errorDiv.classList.remove('hidden');
        }

        // Fun√ß√£o para chamar a API Gemini
        async function verifyWithAI(button, descInv, descSis) {
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loader"></span> Verificando...';
            button.disabled = true;
            
            const apiKey = ""; // Deixe em branco, ser√° preenchido pelo ambiente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "Voc√™ √© um assistente de invent√°rio. Responda [SIM] se os dois itens a seguir parecem ser o mesmo objeto (mesmo que um seja mais detalhado), ou [N√ÉO] se parecem ser objetos fundamentalmente diferentes. Responda apenas [SIM] ou [N√ÉO].";
            const userQuery = `Item 1: "${descInv}"\nItem 2: "${descSis}"`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) {
                    throw new Error(`A API retornou o status ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text.trim().toUpperCase();

                if (text === '[SIM]') {
                    button.innerHTML = 'IA: ‚úÖ SIM';
                    button.className = button.className.replace('bg-blue-500', 'bg-green-600');
                } else if (text === '[N√ÉO]') {
                    button.innerHTML = 'IA: ‚ùå N√ÉO';
                    button.className = button.className.replace('bg-blue-500', 'bg-red-600');
                } else {
                    button.innerHTML = 'IA: ?';
                    throw new Error(`Resposta inesperada: ${text}`);
                }

            } catch (error) {
                console.error('Erro ao chamar a API Gemini:', error);
                showApiError(error.message);
                button.innerHTML = 'Erro na IA';
                button.disabled = false;
            }
        }
        // --- FIM: L√≥gica da API Gemini ---


        // Fun√ß√£o de normaliza√ß√£o simples para strings (remove acentos, min√∫sculas, espa√ßos extras)
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            return str
                .toLowerCase()
                .normalize("NFD") // Remove acentos
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, ' ') // Remove espa√ßos extras
                .replace(/-+/g, ' ') // remove tra√ßos
                .trim();
        }
        
        // Verifica se um item tem tombo (considerando S/T, 0, etc.)
        function hasTombo(tomboStr) {
            if (!tomboStr) return false;
            const norm = normalizeString(tomboStr);
            if (norm === '' || norm === 's/t' || norm === 'sem tombo' || norm === '0') {
                return false;
            }
            return true;
        }

        // Fun√ß√£o para detetar o separador (v√≠rgula, ponto e v√≠rgula, ou tab) e parsear os dados
        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            let separator = '\t'; // Tentativa padr√£o: Tab
            if (firstLine.includes(';')) {
                separator = ';';
            } else if (firstLine.includes(',')) {
                 // Conta a frequ√™ncia de cada separador na primeira linha
                const counts = { ',': (firstLine.match(/,/g) || []).length, ';': (firstLine.match(/;/g) || []).length, '\t': (firstLine.match(/\t/g) || []).length };
                
                // Escolhe o separador com maior contagem (se for maior que zero)
                if (counts[';'] > counts[','] && counts[';'] > counts['\t']) {
                    separator = ';';
                } else if (counts[','] > counts[';'] && counts[','] > counts['\t']) {
                    separator = ',';
                } else if (counts['\t'] === 0 && counts[','] === 0 && counts[';'] === 0) {
                     separator = ' ';
                }
            }


            const rawHeaders = lines[0].split(separator).map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length === rawHeaders.length) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        // Encontra o cabe√ßalho original (mantendo case)
                        const originalHeader = rawHeaders.find(h => normalizeString(h) === normalizeString(header));
                        item[originalHeader || header] = values[index];
                    });
                    data.push(item);
                }
            }
            return data;
        }

        // Fun√ß√£o principal de reconcilia√ß√£o (agora com seletor de modo)
        function reconcileInventory(runTomboWorkflow) {
            const listInventarioText = document.getElementById('list-inventario').value;
            const listSistemaText = document.getElementById('list-sistema').value;
            
            // Oculta ambos os resultados e erros
            document.getElementById('results-container-tombo').classList.add('hidden');
            document.getElementById('results-container-no-tombo').classList.add('hidden');
            document.getElementById('api-error').classList.add('hidden');
            
            if (!listInventarioText.trim() && !listSistemaText.trim()) {
                console.error('Por favor, cole os dados do Invent√°rio e do Sistema.');
                return;
            }

            const inventarioData = parseData(listInventarioText);
            const sistemaData = parseData(listSistemaText);
            
            document.getElementById('count-inventario').textContent = `Total de Itens no Invent√°rio: ${inventarioData.length}`;
            document.getElementById('count-sistema').textContent = `Total de Itens no Sistema: ${sistemaData.length}`;

            if (runTomboWorkflow) {
                runReconciliationTombo(inventarioData, sistemaData);
                document.getElementById('results-container-tombo').classList.remove('hidden');
            } else {
                runAuditNoTombo(inventarioData, sistemaData);
                document.getElementById('results-container-no-tombo').classList.remove('hidden');
            }
        }

        // --- FLUXO 1: Reconcilia√ß√£o de Itens COM Tombo ---
        function runReconciliationTombo(inventarioData, sistemaData) {
            // Limpar dados globais
            reconciledDataByUnit = {};
            inventarioTotalByUnit = {};
            
            // 2. Preparar Dicion√°rios Chave (Tombo/Tombamento)
            const inventarioMap = new Map();
            inventarioData.forEach(item => {
                if (hasTombo(item['Tombo'])) {
                    inventarioMap.set(normalizeString(item['Tombo']), item);
                }
            });
            
            const sistemaMap = new Map();
            sistemaData.forEach(item => {
                if (hasTombo(item['Tombamento'])) {
                    sistemaMap.set(normalizeString(item['Tombamento']), item);
                }
            });

            const allTombos = new Set([...inventarioMap.keys(), ...sistemaMap.keys()].filter(key => key && key !== ''));
            
            // 3. Reconcilia√ß√£o
            allTombos.forEach(tombo => {
                const itemInv = inventarioMap.get(tombo);
                const itemSis = sistemaMap.get(tombo);

                let action = 'OK';
                let sourceData = {};

                const unit = (itemInv && itemInv['Unidade']?.trim() || itemSis && itemSis['Unidade']?.trim() || 'Unidade Desconhecida');
                
                if (!reconciledDataByUnit[unit]) {
                    reconciledDataByUnit[unit] = { report: [], countAdicionar: 0, countExcluir: 0, totalInventario: 0 };
                }
                if (itemInv) {
                    inventarioTotalByUnit[unit] = (inventarioTotalByUnit[unit] || 0) + 1;
                }
                
                if (itemInv && itemSis) {
                    sourceData = itemSis;
                    
                    // (Req 3) Salva os dados do Invent√°rio (Lista 1) para compara√ß√£o lado-a-lado
                    sourceData['invLocal'] = itemInv['Local'] || '';
                    sourceData['invEstado'] = itemInv['Estado de Conserva√ß√£o'] || '';
                    sourceData['invDesc'] = itemInv['Item'] || '';

                    const localInv = normalizeString(itemInv['Local']);
                    const localSis = normalizeString(itemSis['Localiza√ß√£o']);
                    const estadoInv = normalizeString(itemInv['Estado de Conserva√ß√£o']);
                    const estadoSis = normalizeString(itemSis['Estado']);
                    const descInv = normalizeString(itemInv['Item']);
                    const descSis = normalizeString(itemSis['Descri√ß√£o']);
                    
                    const descSimilar = (descInv.includes(descSis) || descSis.includes(descInv));
                    let discrepancies = [];

                    if (!descSimilar) {
                        discrepancies.push(`Descri√ß√£o (Inv: '${itemInv['Item'] || ''}' / Sis: '${itemSis['Descri√ß√£o'] || ''}')`);
                    }
                    if (localInv !== localSis) {
                        discrepancies.push(`Local (Inv: '${itemInv['Local'] || ''}' / Sis: '${itemSis['Localiza√ß√£o'] || ''}')`);
                    }
                    if (estadoInv !== estadoSis) {
                         discrepancies.push(`Estado (Inv: '${itemInv['Estado de Conserva√ß√£o'] || ''}' / Sis: '${itemSis['Estado'] || ''}')`);
                    }

                    if (discrepancies.length > 0) {
                        action = 'ATEN√á√ÉO (Discrep√¢ncia)';
                        const justification = `DISCREP√ÇNCIA: ${discrepancies.join(' | ')}`;
                        sourceData['observacaoOriginal'] = justification; // (Req 2) Texto de crit√©rio
                        sourceData['descInv'] = itemInv['Item'] || ''; // Salva para o bot√£o da IA
                        sourceData['descSis'] = itemSis['Descri√ß√£o'] || ''; // Salva para o bot√£o da IA
                    }

                } else if (itemInv && !itemSis) {
                    action = 'ADICIONAR';
                    reconciledDataByUnit[unit].countAdicionar++;
                    sourceData = {};
                    for (const keyInv in INVENTARIO_MAP) {
                        const keySis = INVENTARIO_MAP[keyInv];
                        sourceData[keySis] = itemInv[keyInv] || '';
                    }
                    SISTEMA_HEADERS.forEach(h => { if (!sourceData[h]) sourceData[h] = ''; });
                    sourceData['Tipo'] = 'NOVO ITEM'; 
                    sourceData['Localiza√ß√£o'] = itemInv['Local'] || ''; 
                    // (Req 2) Texto de crit√©rio expl√≠cito
                    sourceData['observacaoOriginal'] = "Item encontrado no Invent√°rio (Lista 1) mas n√£o consta no Sistema (Lista 2).";
                    sourceData['Tombamento'] = itemInv['Tombo'] || '';

                } else if (!itemInv && itemSis) {
                    action = 'EXCLUIR';
                    reconciledDataByUnit[unit].countExcluir++;
                    sourceData = itemSis;
                    // (Req 2) Texto de crit√©rio expl√≠cito
                    sourceData['observacaoOriginal'] = "Item consta no Sistema (Lista 2) mas n√£o foi encontrado no Invent√°rio (Lista 1).";
                }

                reconciledDataByUnit[unit].report.push({
                    action: action, unit: unit, ...sourceData
                });
            });

            Object.keys(inventarioTotalByUnit).forEach(unit => {
                if (reconciledDataByUnit[unit]) {
                    reconciledDataByUnit[unit].totalInventario = inventarioTotalByUnit[unit];
                }
            });

            setupUnitFilter();
        }

        // --- FLUXO 2: Auditoria de Itens SEM Tombo ---
        function runAuditNoTombo(inventarioData, sistemaData) {
            const inventarioMap = new Map(); // Map<Local, Map<Descri√ß√£o, Qtd>>
            const sistemaMap = new Map();
            const allLocals = new Set();
            const allDescs = new Set();
            noTomboAuditData = []; // Limpa auditoria anterior

            // Processa Invent√°rio
            inventarioData.forEach(item => {
                if (!hasTombo(item['Tombo'])) {
                    const local = normalizeString(item['Local'] || 'Sem Local');
                    const desc = normalizeString(item['Item'] || 'Sem Descri√ß√£o');
                    allLocals.add(local);
                    allDescs.add(desc);
                    
                    const localMap = inventarioMap.get(local) || new Map();
                    localMap.set(desc, (localMap.get(desc) || 0) + 1);
                    inventarioMap.set(local, localMap);
                }
            });
            
            // Processa Sistema
            sistemaData.forEach(item => {
                 if (!hasTombo(item['Tombamento'])) {
                    const local = normalizeString(item['Localiza√ß√£o'] || 'Sem Local');
                    const desc = normalizeString(item['Descri√ß√£o'] || 'Sem Descri√ß√£o');
                    allLocals.add(local);
                    allDescs.add(desc);
                    
                    const localMap = sistemaMap.get(local) || new Map();
                    localMap.set(desc, (localMap.get(desc) || 0) + 1);
                    sistemaMap.set(local, localMap);
                }
            });

            // Gera o relat√≥rio de auditoria
            const resultsBody = document.getElementById('results-body-no-tombo');
            resultsBody.innerHTML = '';
            
            const sortedLocals = [...allLocals].sort();
            const sortedDescs = [...allDescs].sort();

            for (const local of sortedLocals) {
                for (const desc of sortedDescs) {
                    const qtdInv = inventarioMap.get(local)?.get(desc) || 0;
                    const qtdSis = sistemaMap.get(local)?.get(desc) || 0;
                    const diff = qtdInv - qtdSis;

                    if (qtdInv > 0 || qtdSis > 0) { // S√≥ mostra se houver item em pelo menos uma lista
                        const auditRow = {
                            local: local,
                            desc: desc,
                            qtdInv: qtdInv,
                            qtdSis: qtdSis,
                            diff: diff
                        };
                        noTomboAuditData.push(auditRow); // Salva para exporta√ß√£o
                        
                        let rowClass = 'bg-white';
                        let diffClass = 'text-gray-700';
                        if (diff > 0) {
                            rowClass = 'bg-green-50'; // Mais no Invent√°rio (Falta no Sistema)
                            diffClass = 'text-green-700 font-bold';
                        } else if (diff < 0) {
                            rowClass = 'bg-red-50'; // Menos no Invent√°rio (Sobra no Sistema)
                            diffClass = 'text-red-700 font-bold';
                        }

                        const row = document.createElement('tr');
                        row.className = `${rowClass} hover:bg-gray-100`;
                        row.innerHTML = `
                            <td class="p-3 font-medium text-gray-900">${local}</td>
                            <td class="p-3 text-sm text-gray-700">${desc}</td>
                            <td class="p-3 text-sm text-gray-700">${qtdInv}</td>
                            <td class="p-3 text-sm text-gray-700">${qtdSis}</td>
                            <td class="p-3 text-sm ${diffClass}">${diff > 0 ? '+' : ''}${diff}</td>
                        `;
                        resultsBody.appendChild(row);
                    }
                }
            }
        }


        // Fun√ß√£o para configurar o filtro de Unidades (CRAS)
        function setupUnitFilter() {
            const filterContainer = document.getElementById('unit-filter-container');
            filterContainer.innerHTML = '';
            
            const units = Object.keys(reconciledDataByUnit).sort((a, b) => a.localeCompare(b));
            
            if (units.length === 0) {
                filterContainer.innerHTML = '<p class="text-gray-500">Nenhuma Unidade com Tombo encontrado para an√°lise.</p>';
                return;
            }

            const selectHtml = `
                <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-3 mb-4 p-3 bg-indigo-50 rounded-xl shadow-md">
                    <label for="unit-selector" class="font-bold text-indigo-800 text-lg whitespace-nowrap">Filtrar por Unidade (CRAS):</label>
                    <select id="unit-selector" onchange="renderTomboReport(this.value)" class="p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full md:w-auto shadow-sm">
                        <option value="ALL">Mostrar Todas as Unidades (${units.length})</option>
                        ${units.map(unit => `<option value="${unit}">${unit}</option>`).join('')}
                    </select>
                </div>
            `;
            filterContainer.innerHTML = selectHtml;
            renderTomboReport('ALL');
        }


        // Fun√ß√£o para renderizar o relat√≥rio COM TOMBO
        function renderTomboReport(selectedUnit) {
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';
            
            let reportToRender = [];
            let currentTotalInventario = 0, currentCountAdicionar = 0, currentCountExcluir = 0;
            
            const unitsToProcess = selectedUnit === 'ALL' ? Object.keys(reconciledDataByUnit) : [selectedUnit];

            unitsToProcess.forEach(unit => {
                if (reconciledDataByUnit[unit]) {
                    reportToRender.push(...reconciledDataByUnit[unit].report);
                    currentTotalInventario += reconciledDataByUnit[unit].totalInventario;
                    currentCountAdicionar += reconciledDataByUnit[unit].countAdicionar;
                    currentCountExcluir += reconciledDataByUnit[unit].countExcluir;
                }
            });

            // 4. Ordena√ß√£o
            reportToRender.sort((a, b) => {
                const actionOrder = { 'ADICIONAR': 3, 'EXCLUIR': 2, 'ATEN√á√ÉO (Discrep√¢ncia)': 1, 'OK': 0 };
                const orderDiff = actionOrder[b.action] - actionOrder[a.action];
                if (orderDiff !== 0) return orderDiff;
                const unitA = a.unit?.trim().toLowerCase() || '';
                const unitB = b.unit?.trim().toLowerCase() || '';
                const unitDiff = unitA.localeCompare(unitB);
                if (unitDiff !== 0) return unitDiff;
                const localA = a.Localiza√ß√£o?.trim().toLowerCase() || '';
                const localB = b.Localiza√ß√£o?.trim().toLowerCase() || '';
                return localA.localeCompare(localB);
            });
            
            // Update summary
            document.getElementById('total-inventario-final').textContent = currentTotalInventario;
            document.getElementById('total-adicionar').textContent = currentCountAdicionar;
            document.getElementById('total-excluir').textContent = currentCountExcluir;
            
            // 5. Gera√ß√£o da Tabela Principal
            reportToRender.forEach(item => {
                const row = document.createElement('tr');
                let actionClass = 'bg-gray-50 text-gray-700';
                if (item.action === 'ADICIONAR') actionClass = 'bg-green-100 text-green-700 font-bold';
                else if (item.action === 'EXCLUIR') actionClass = 'bg-red-100 text-red-700 font-bold';
                else if (item.action.includes('ATEN√á√ÉO')) actionClass = 'bg-yellow-100 text-yellow-700 font-semibold';

                row.className = 'hover:bg-gray-50 transition duration-100';
                
                const tombamentoCell = item['Tombamento'] ? `<td class="p-3 font-medium text-gray-900">${item['Tombamento']}</td>` : '<td class="p-3 text-gray-500 italic">SEM TOMBO</td>';
                
                // (Req 1) Esta c√©lula √© preenchida mesmo no modo "ALL"
                const unidadeCell = `<td class="p-3 text-sm text-gray-700">${item['Unidade'] || item.unit || ''}</td>`;
                
                // (Req 3) Compara√ß√£o Lado-a-Lado para Localiza√ß√£o
                let localizacaoHtml = item['Localiza√ß√£o'] ? item['Localiza√ß√£o'] : '<i class="text-gray-500">SEM LOCAL</i>';
                if (item.action.includes('ATEN√á√ÉO') && item['invLocal'] !== undefined && normalizeString(item['Localiza√ß√£o']) !== normalizeString(item['invLocal'])) {
                    localizacaoHtml = `<div class='text-xs'><span class='font-bold text-red-700'>[Sis]:</span> ${item['Localiza√ß√£o']}</div><div class='text-xs'><span class='font-bold text-blue-700'>[Inv]:</span> ${item['invLocal']}</div>`;
                }
                const localizacaoCell = `<td class="p-3 font-medium">${localizacaoHtml}</td>`;

                // (Req 3) Compara√ß√£o Lado-a-Lado para Descri√ß√£o
                let descricaoHtml = item['Descri√ß√£o'] || '';
                if (item.action.includes('ATEN√á√ÉO') && item['invDesc'] !== undefined && normalizeString(item['Descri√ß√£o']) !== normalizeString(item['invDesc'])) {
                    descricaoHtml = `<div class='text-xs'><span class='font-bold text-red-700'>[Sis]:</span> ${item['Descri√ß√£o']}</div><div class='text-xs'><span class='font-bold text-blue-700'>[Inv]:</span> ${item['invDesc']}</div>`;
                }
                const descricaoCell = `<td class="p-3 text-sm text-gray-700">${descricaoHtml}</td>`;

                // (Req 3) Compara√ß√£o Lado-a-Lado para Estado
                let estadoHtml = item['Estado'] || '';
                if (item.action.includes('ATEN√á√ÉO') && item['invEstado'] !== undefined && normalizeString(item['Estado']) !== normalizeString(item['invEstado'])) {
                    estadoHtml = `<div class='text-xs'><span class='font-bold text-red-700'>[Sis]:</span> ${item['Estado']}</div><div class='text-xs'><span class='font-bold text-blue-700'>[Inv]:</span> ${item['invEstado']}</div>`;
                }
                const estadoCell = `<td class="p-3 text-sm text-gray-700">${estadoHtml}</td>`;

                
                // Bot√£o da IA
                let aiButton = '';
                if (item.action.includes('ATEN√á√ÉO') && item.observacaoOriginal && item.observacaoOriginal.includes('Descri√ß√£o')) {
                    // Escapa as descri√ß√µes para uso em HTML/JS
                    const descInvEsc = (item.descInv || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    const descSisEsc = (item.descSis || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    aiButton = `<button onclick="verifyWithAI(this, '${descInvEsc}', '${descSisEsc}')" class="ml-2 px-2 py-0.5 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all">Verificar com IA</button>`;
                }

                // (Req 2) Coluna Tipo/Observa√ß√£o/Crit√©rio
                const obsDetails = [item['Origem da Doa√ß√£o'], item['Fornecedor']].filter(d => d).join('; ');
                // Usa a 'observacaoOriginal' (com crit√©rio claro) ou a 'Observa√ß√£o' padr√£o
                const tipoObsContent = [item['Tipo'], obsDetails, item['observacaoOriginal'] || item['Observa√ß√£o']].filter(d => d).join(' | ');

                const tipoObsCell = `<td class="p-3 text-sm text-gray-600 rounded-r-lg">${tipoObsContent} ${aiButton}</td>`;

                row.innerHTML = `
                    <td class="p-3 font-semibold whitespace-nowrap ${actionClass} rounded-l-lg">${item.action}</td>
                    ${tombamentoCell}
                    ${localizacaoCell}
                    ${unidadeCell}
                    ${descricaoCell}
                    ${estadoCell}
                    ${tipoObsCell}
                `;
                resultsBody.appendChild(row);
            });

            // 6. Gera√ß√£o da Tabela de Itens Faltantes (ADICIONAR)
            const missingItemsBody = document.getElementById('missing-items-body');
            const missingItemsContainer = document.getElementById('missing-items-container');
            missingItemsBody.innerHTML = '';
            const missingItems = reportToRender.filter(item => item.action === 'ADICIONAR');

            if (missingItems.length > 0) {
                missingItemsContainer.classList.remove('hidden');
                missingItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-green-50 transition duration-100 bg-green-50';
                    row.innerHTML = `
                        <td class="p-3 font-medium text-gray-900">${item['Descri√ß√£o'] || ''}</td>
                        <td class="p-3 text-sm text-gray-700">${item['Tombamento'] || 'N/A'}</td>
                        <td class="p-3 text-sm text-gray-700 font-semibold text-green-700">${item['Localiza√ß√£o'] || 'N√£o Informado'}</td>
                        <td class="p-3 text-sm text-gray-700">${item['Unidade'] || item.unit || 'N/A'}</td>
                    `;
                    missingItemsBody.appendChild(row);
                });
            } else {
                missingItemsContainer.classList.add('hidden');
            }

            // 7. Update summary text
            let totalItemsReported = reportToRender.length;
            let inventarioDelta = currentCountAdicionar - currentCountExcluir;
            document.getElementById('summary-text').innerHTML = `
                <p>O relat√≥rio para **${selectedUnit === 'ALL' ? 'Todas as Unidades' : selectedUnit}** cont√©m **${totalItemsReported} itens √∫nicos (COM TOMBO)**.</p>
                <p>O Invent√°rio Base (COM TOMBO) da ${selectedUnit === 'ALL' ? '√°rea total' : selectedCras} possui **${currentTotalInventario}** itens. </p>
                <p>A diferen√ßa l√≠quida de itens (Adicionar - Excluir) √© de: <strong class="${inventarioDelta > 0 ? 'text-green-600' : inventarioDelta < 0 ? 'text-red-600' : 'text-gray-600'}">${inventarioDelta}</strong>.</p>
            `;
        }

        // Fun√ß√£o para exportar CSV (para ambos os modos)
        function exportCSV(exportTomboData) {
            let csvContent = '';
            let filename = '';

            if (exportTomboData) {
                // Exporta Relat√≥rio COM TOMBO
                const selector = document.getElementById('unit-selector');
                const selectedUnit = selector.value;
                let reportToRender = [];
                const unitsToProcess = selectedUnit === 'ALL' ? Object.keys(reconciledDataByUnit) : [selectedUnit];

                unitsToProcess.forEach(unit => {
                    if (reconciledDataByUnit[unit]) {
                        reconciledDataByUnit[unit].report.forEach(item => reportToRender.push(item));
                    }
                });
                
                reportToRender.sort((a, b) => { /* ... (mesma l√≥gica de ordena√ß√£o) ... */ });

                const headers = ['A√ß√£o Sugerida', ...SISTEMA_HEADERS, 'Crit√©rio/Justificativa'];
                csvContent = headers.join(';') + '\n'; 
                
                reportToRender.forEach(item => {
                    const values = [];
                    values.push(item.action);
                    SISTEMA_HEADERS.forEach(header => {
                        let value = (item[header] || '').replace(/;/g, ',').replace(/\n/g, ' ').trim();
                        values.push(value);
                    });
                    // Adiciona a justificativa separadamente
                    values.push((item.observacaoOriginal || '').replace(/;/g, ',').replace(/\n/g, ' ').trim());
                    csvContent += values.join(';') + '\n';
                });
                
                const unitName = selectedUnit === 'ALL' ? 'Geral' : selectedUnit.replace(/[^a-zA-Z0-9]/g, '_');
                filename = `Reconciliacao_COM_Tombo_${unitName}.csv`;

            } else {
                // Exporta Relat√≥rio SEM TOMBO
                const headers = ['Local', 'Descricao', 'Qtd_Inventario', 'Qtd_Sistema', 'Diferenca'];
                csvContent = headers.join(';') + '\n';
                
                noTomboAuditData.forEach(item => {
                    const values = [
                        item.local.replace(/;/g, ','),
                        item.desc.replace(/;/g, ','),
                        item.qtdInv,
                        item.qtdSis,
                        item.diff
                    ];
                    csvContent += values.join(';') + '\n';
                });
                filename = `Auditoria_SEM_Tombo.csv`;
            }

            // L√≥gica de Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                console.error("Download is not supported in this browser.");
            }
        }

        // Adiciona listener para atualizar a contagem enquanto digita/cola
        function setupCountListeners() {
            document.getElementById('list-inventario').addEventListener('input', () => {
                 const data = parseData(document.getElementById('list-inventario').value);
                 document.getElementById('count-inventario').textContent = `Total de Itens no Invent√°rio: ${data.length}`;
            });
            document.getElementById('list-sistema').addEventListener('input', () => {
                 const data = parseData(document.getElementById('list-sistema').value);
                 document.getElementById('count-sistema').textContent = `Total de Itens no Sistema: ${data.length}`;
            });
        }
        window.onload = setupCountListeners;

    </script>
</body>
</html>

