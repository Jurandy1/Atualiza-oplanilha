<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Quantidade - Sistema com Vincula√ß√£o Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        textarea {
            height: 250px; 
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .progress-bar {
            position: relative;
            height: 8px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 9999px;
        }

        .modal {
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #059669;
        }

        .search-box {
            transition: all 0.3s ease;
        }

        .search-box:focus-within {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            background: #1f2937;
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulse-warning {
            animation: pulse-warning 2s ease-in-out infinite;
        }

        .divergence-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            /* Remove pulse-warning for minor badges, keep only for cards */
        }

        @media (max-width: 640px) {
            textarea {
                height: 180px;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .highlight {
            background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        .item-divergent {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }

        .item-match {
            border-left: 4px solid #22c55e;
        }

        .item-only-inv {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
        }

        .item-only-sys {
            border-left: 4px solid #f97316;
            background: linear-gradient(90deg, rgba(249, 115, 22, 0.1) 0%, transparent 100%);
        }

        /* NOVOS ESTILOS PARA VINCULA√á√ÉO */
        .linking-mode {
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.1) 0%, transparent 100%);
            border: 2px dashed #9333ea !important;
        }

        .item-selected {
            background: #ddd6fe !important;
            border: 3px solid #9333ea !important;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
            transform: scale(1.02);
        }

        .item-linked {
            border-left: 4px solid #9333ea;
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.2) 0%, transparent 100%);
        }

        .link-badge {
            background: linear-gradient(135deg, #9333ea 0%, #c084fc 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            box-shadow: 0 2px 4px rgba(147, 51, 234, 0.3);
        }

        @keyframes link-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .link-active {
            animation: link-pulse 1s ease-in-out infinite;
        }

        /* Tabela de relat√≥rio */
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th, .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8rem; /* Fonte menor para caber mais colunas */
        }

        .report-table th {
            background: #f3f4f6;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.7rem; /* Fonte menor para caber mais colunas */
            color: #374151;
            position: sticky; /* Fixa o cabe√ßalho ao rolar */
            top: 0;
            z-index: 10;
        }

        .report-table tr:hover {
            background: #f9fafb;
        }

        /* Novo estilo para Local Linking */
        .location-link-mode {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
            border: 2px dashed #3b82f6 !important;
        }

        .location-selected {
            background: #dbeafe !important;
            border: 3px solid #3b82f6 !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            transform: scale(1.02);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981',
                        'primary-dark': '#059669',
                        'inventario': '#3b82f6',
                        'sistema': '#f97316',
                        'export': '#d946ef',
                        'success': '#22c55e',
                        'warning': '#f59e0b',
                        'danger': '#ef4444',
                        'link': '#9333ea',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-white text-lg font-semibold">Processando dados...</p>
            <p class="text-gray-300 text-sm mt-2">Isso pode levar alguns segundos</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-2xl fade-in">
        <!-- Header -->
        <div class="mb-8 border-b-4 border-primary pb-4">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2 flex items-center gap-3">
                <span class="text-5xl">üìä</span>
                Analisador com Vincula√ß√£o Inteligente
            </h1>
            <p class="text-gray-600 text-lg">
                Sistema avan√ßado que permite vincular itens e locais com nomes diferentes
            </p>
            <div class="mt-3 flex flex-wrap gap-2">
                <span class="status-badge bg-green-100 text-green-700">‚úì Compara√ß√£o Autom√°tica</span>
                <span class="status-badge bg-blue-100 text-blue-700">‚úì Filtros Avan√ßados</span>
                <span class="status-badge bg-purple-100 text-purple-700">‚úì Vincula√ß√£o Inteligente</span>
                <span class="status-badge bg-red-100 text-red-700">‚úì Detec√ß√£o de Diverg√™ncias</span>
            </div>
        </div>

        <!-- Gerenciador de Vincula√ß√µes -->
        <div class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl border-2 border-purple-300">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold text-purple-800 flex items-center gap-2">
                        <span class="text-2xl">üîó</span>
                        <span>Gerenciador de Vincula√ß√µes</span>
                    </h3>
                    <p class="text-sm text-purple-600 mt-1">Vincule locais e itens com nomes diferentes</p>
                </div>
                <button onclick="toggleLinkManager()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition">
                    Ver V√≠nculos (<span id="link-count">0</span>)
                </button>
            </div>
            <div class="flex gap-3">
                <button onclick="clearAllLinks()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition text-sm">
                    üóëÔ∏è Limpar Todas
                </button>
                <button onclick="exportLinks()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition text-sm">
                    üì• Exportar
                </button>
                <button onclick="importLinks()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition text-sm">
                    üì§ Importar
                </button>
            </div>
        </div>

        <!-- Contadores -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-blue-600 mb-1">INVENT√ÅRIO</p>
                        <p id="count-inventario" class="text-3xl font-bold text-blue-700">0</p>
                        <p class="text-xs text-blue-600 mt-1">linhas carregadas</p>
                    </div>
                    <div class="text-5xl opacity-20">üìã</div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-xl border-2 border-orange-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-orange-600 mb-1">SISTEMA</p>
                        <p id="count-sistema" class="text-3xl font-bold text-orange-700">0</p>
                        <p class="text-xs text-orange-600 mt-1">linhas carregadas</p>
                    </div>
                    <div class="text-5xl opacity-20">‚öôÔ∏è</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Invent√°rio -->
            <div class="group">
                <label for="list-inventario" class="block text-lg font-bold text-inventario mb-3 flex items-center gap-2">
                    <span class="text-2xl">üìã</span>
                    <span>Dados do Invent√°rio</span>
                    <span class="tooltip text-gray-400 cursor-help text-sm" data-tooltip="Cole dados com: Unidade, Local, Item, Tombo e outros campos completos.">‚ÑπÔ∏è</span>
                </label>
                <div class="relative">
                    <textarea 
                        id="list-inventario" 
                        class="w-full p-4 border-2 border-inventario rounded-xl focus:ring-2 focus:ring-inventario focus:border-inventario transition duration-150 custom-scrollbar" 
                        placeholder="Cole os dados do Invent√°rio incluindo cabe√ßalho. (Campos importantes: Unidade, Local, Item, Tombo)"
                        aria-label="Dados do Invent√°rio"
                    ></textarea>
                    <div class="absolute top-2 right-2">
                        <button onclick="clearTextarea('list-inventario')" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-lg text-xs font-semibold transition">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sistema -->
            <div class="group">
                <label for="list-sistema" class="block text-lg font-bold text-sistema mb-3 flex items-center gap-2">
                    <span class="text-2xl">‚öôÔ∏è</span>
                    <span>Dados do Sistema</span>
                    <span class="tooltip text-gray-400 cursor-help text-sm" data-tooltip="Cole dados com: Unidade, Localiza√ß√£o, Descri√ß√£o, Tombamento e outros campos completos.">‚ÑπÔ∏è</span>
                </label>
                <div class="relative">
                    <textarea 
                        id="list-sistema" 
                        class="w-full p-4 border-2 border-sistema rounded-xl focus:ring-2 focus:ring-sistema focus:border-sistema transition duration-150 custom-scrollbar" 
                        placeholder="Cole os dados do Sistema incluindo cabe√ßalho. (Campos importantes: Unidade, Localiza√ß√£o, Descri√ß√£o, Tombamento)"
                        aria-label="Dados do Sistema"
                    ></textarea>
                    <div class="absolute top-2 right-2">
                        <button onclick="clearTextarea('list-sistema')" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-lg text-xs font-semibold transition">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√£o de A√ß√£o -->
        <div class="mb-8">
             <button 
                onclick="runMasterCount()" 
                class="w-full px-8 py-4 bg-gradient-to-r from-primary to-primary-dark text-white font-bold text-xl rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center gap-3"
             >
                <span class="text-2xl">üöÄ</span>
                <span>Analisar Contagem de Itens por Local</span>
             </button>
        </div>
        
        <!-- Container de Resultados -->
        <div id="results-container" class="mt-12 hidden fade-in">
            <div class="mb-6 p-6 bg-gradient-to-r from-primary to-primary-dark rounded-xl text-white">
                <h2 id="report-title" class="text-3xl font-bold mb-2 flex items-center gap-3">
                    <span class="text-4xl">üìà</span>
                    <span>Relat√≥rio de Auditoria de Quantidade</span>
                </h2>
                <p class="text-green-100">An√°lise completa com vincula√ß√µes aplicadas</p>
            </div>

            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div id="filter-container" class="hidden">
                    <label for="unit-filter" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        üè¢ Filtrar por Unidade (Divergente)
                    </label>
                    <select 
                        id="unit-filter" 
                        class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition duration-150 bg-white font-semibold" 
                        onchange="filterResultCards(this.value)"
                    >
                        <option value="all_divergent">üåê Todas as Unidades Divergentes</option>
                    </select>
                </div>

                <div id="search-container" class="hidden">
                    <label for="local-search" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        üîç Buscar Local
                    </label>
                    <div class="search-box relative">
                        <input 
                            type="text" 
                            id="local-search" 
                            class="w-full p-3 pl-10 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition duration-150" 
                            placeholder="Digite o nome do local..."
                            oninput="searchLocal(this.value)"
                        />
                        <span class="absolute left-3 top-3.5 text-gray-400 text-xl">üîé</span>
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-wrap gap-3 mb-6">
                 <!-- REQ 1: Novo bot√£o para Vincula√ß√£o de Local -->
                <button 
                    onclick="toggleLocalLinkingMode()" 
                    id="local-link-mode-btn" 
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] flex items-center gap-2"
                >
                    <span class="text-xl">üó∫Ô∏è</span>
                    <span>Ativar V√≠nculo de Local</span>
                </button>
                <button 
                    onclick="generateFinalReport()" 
                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white font-bold rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] flex items-center gap-2"
                >
                    <span class="text-xl">üìã</span>
                    <span>Relat√≥rio Final por Unidade</span>
                </button>
                <button 
                    onclick="exportCSV()" 
                    class="px-6 py-3 bg-gradient-to-r from-export to-fuchsia-600 text-white font-bold rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] flex items-center gap-2"
                >
                    <span class="text-xl">üì•</span>
                    <span>Exportar CSV de Auditoria</span>
                </button>
            </div>
            
            <!-- Resumo -->
            <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl">üìã</span>
                        <span class="status-badge bg-blue-200 text-blue-700">Fonte</span>
                    </div>
                    <div class="text-4xl font-black text-blue-600 mb-2" id="summary-inv">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Total Itens (Invent√°rio)</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-blue-500" id="progress-inv" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="p-6 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl">‚öôÔ∏è</span>
                        <span class="status-badge bg-orange-200 text-orange-700">Atual</span>
                    </div>
                    <div class="text-4xl font-black text-orange-600 mb-2" id="summary-sis">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Total Itens (Sistema)</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-orange-500" id="progress-sis" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="p-6 bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl" id="diff-icon">üìä</span>
                        <span class="status-badge bg-gray-200 text-gray-700" id="diff-status">An√°lise</span>
                    </div>
                    <div class="text-4xl font-black text-gray-700 mb-2" id="summary-diff">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Diferen√ßa L√≠quida</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-gray-500" id="progress-diff" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Cards de Discrep√¢ncia (Modo Lista Agrupada - REQ 5) -->
            <div class="mb-4">
                <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <span class="text-3xl">‚ö†Ô∏è</span>
                    <span>Discrep√¢ncias Encontradas</span>
                    <span id="discrepancy-count" class="ml-auto bg-red-100 text-red-700 px-4 py-1 rounded-full font-bold text-sm">0</span>
                </h3>
                <p class="text-gray-600 mb-4">Clique nos cards para visualizar e vincular itens</p>
            </div>
            
            <p id="no-discrepancy-message" class="text-center p-8 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-200 hidden">
                <span class="text-6xl mb-4 block">üéâ</span>
                <span class="text-2xl font-bold text-green-700 block mb-2">Perfeito!</span>
                <span class="text-gray-600">Nenhuma discrep√¢ncia encontrada</span>
            </p>
            
            <div id="discrepancy-cards-container" class="grid grid-cols-1 gap-6">
                <!-- Conte√∫do agora renderizado como lista agrupada por unidade -->
            </div>
        </div>
    </div>

    <!-- MODAL DE VINCULA√á√ÉO -->
    <div id="item-details-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeModal()">
        <div class="modal-content bg-white w-full max-w-6xl rounded-2xl shadow-2xl transform scale-95" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="flex justify-between items-center border-b-2 border-gray-200 p-6 bg-gradient-to-r from-primary to-primary-dark text-white rounded-t-2xl">
                <div>
                    <h2 id="modal-title" class="text-3xl font-bold">Detalhes dos Itens</h2>
                    <p id="modal-subtitle" class="text-green-100 mt-1"></p>
                </div>
                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            
            <!-- Modo de Vincula√ß√£o -->
            <div id="linking-info" class="px-6 pt-4 pb-2 bg-purple-50 border-b-2 border-purple-200 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl link-active">üîó</span>
                        <div>
                            <p class="font-bold text-purple-800">Modo de Vincula√ß√£o Ativo</p>
                            <!-- REQ 3: Mensagem din√¢mica -->
                            <p class="text-sm text-purple-600">Selecione 1 item do Invent√°rio e 1 do Sistema para vincular</p>
                        </div>
                    </div>
                    <button onclick="cancelLinking()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition">
                        ‚úñ Cancelar
                    </button>
                </div>
            </div>

            <!-- Controles -->
            <div class="px-6 pt-4 pb-2">
                <div class="flex gap-3 mb-3">
                    <button onclick="toggleLinkingMode()" id="link-mode-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <span>üîó</span>
                        <span>Ativar Modo Vincula√ß√£o de Tombo</span>
                    </button>
                    <button onclick="reanalyzeWithLinks()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <span>üîÑ</span>
                        <span>Reanalisar com V√≠nculos</span>
                    </button>
                </div>
            </div>

            <!-- Legenda -->
            <div class="px-6 pb-2">
                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <span>üîç</span>
                        <span>LEGENDA (Itens Restantes):</span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                            <span class="font-semibold">Qtd Diferente</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                            <span class="font-semibold">S√≥ Invent√°rio</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
                            <span class="font-semibold">S√≥ Sistema</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-purple-500 rounded-full"></span>
                            <span class="font-semibold">Vinculado</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span class="font-semibold">Correto</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Busca -->
            <div class="px-6 pb-4">
                <div class="search-box relative">
                    <input 
                        type="text" 
                        id="modal-search" 
                        class="w-full p-3 pl-10 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition" 
                        placeholder="üîé Buscar item..."
                        oninput="searchModalItems(this.value)"
                    />
                    <span class="absolute left-3 top-3.5 text-gray-400 text-xl">üîç</span>
                </div>
            </div>
            
            <!-- Listas -->
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[50vh] overflow-y-auto custom-scrollbar">
                <div class="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                    <h3 id="modal-inv-title" class="text-xl font-bold text-inventario mb-3 flex items-center gap-2">
                        <span class="text-2xl">üìã</span>
                        <span>Invent√°rio (0)</span>
                    </h3>
                    <ul id="modal-inv-list" class="space-y-2 text-sm text-gray-700">
                    </ul>
                </div>
                
                <div class="bg-orange-50 rounded-xl p-5 border-2 border-orange-200">
                    <h3 id="modal-sis-title" class="text-xl font-bold text-sistema mb-3 flex items-center gap-2">
                        <span class="text-2xl">‚öôÔ∏è</span>
                        <span>Sistema (0)</span>
                    </h3>
                    <ul id="modal-sis-list" class="space-y-2 text-sm text-gray-700">
                    </ul>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span class="font-semibold">Vincula√ß√µes ativas:</span> <span id="modal-link-count">0</span>
                </div>
                <button 
                    onclick="closeModal()" 
                    class="px-8 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-xl hover:from-gray-700 hover:to-gray-800 transition duration-200 shadow-lg"
                >
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL GERENCIADOR DE LINKS -->
    <div id="link-manager-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeLinkManager()">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl transform scale-95 max-h-[80vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b-2 border-purple-200 p-6 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-t-2xl">
                <div>
                    <h2 class="text-3xl font-bold">üîó Vincula√ß√µes Salvas</h2>
                    <p class="text-purple-100 mt-1">Gerencie todos os v√≠nculos entre locais e itens</p>
                </div>
                <button onclick="closeLinkManager()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar" style="max-height: calc(80vh - 180px);">
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">V√≠nculos de Localiza√ß√£o</h3>
                <div id="local-link-list-container" class="mb-6 space-y-2">
                    <!-- Lista de V√≠nculos de Local ser√° preenchida dinamicamente -->
                </div>
                
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">V√≠nculos de Tombo/Item (Inst√¢ncias)</h3>
                <div id="item-link-list-container">
                    <!-- Lista de V√≠nculos de Item ser√° preenchida dinamicamente -->
                </div>
            </div>
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl">
                <button onclick="closeLinkManager()" class="px-8 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-xl transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL RELAT√ìRIO FINAL -->
    <div id="final-report-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeFinalReport()">
        <div class="modal-content bg-white w-full max-w-6xl rounded-2xl shadow-2xl transform scale-95" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b-2 border-purple-200 p-6 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-t-2xl">
                <div>
                    <h2 class="text-3xl font-bold">üìã Relat√≥rio Final por Unidade</h2>
                    <p class="text-purple-100 mt-1">Itens faltantes ap√≥s aplicar todas as vincula√ß√µes</p>
                </div>
                <button onclick="closeFinalReport()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            <div class="p-6">
                <button onclick="exportFinalReport()" class="mb-4 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                    <span>üì•</span>
                    <span>Exportar Relat√≥rio Final (CSV)</span>
                </button>
                <div id="final-report-content" class="overflow-y-auto custom-scrollbar" style="max-height: calc(90vh - 250px);">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
            </div>
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl">
                <button onclick="closeFinalReport()" class="px-8 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-xl transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LOCAL LINKING (REQ 1 - MODO AUDITORIA) -->
     <div id="local-linking-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeLocalLinkingModal()">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl transform scale-95" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="flex justify-between items-center border-b-2 border-gray-200 p-6 bg-gradient-to-r from-inventario to-blue-700 text-white rounded-t-2xl">
                <div>
                    <h2 class="text-3xl font-bold">üó∫Ô∏è Auditoria de Local (Garantia)</h2>
                    <p class="text-blue-100 mt-1">Confirme ou corrija o mapeamento entre locais de diferentes bases.</p>
                </div>
                <button onclick="closeLocalLinkingModal()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>

            <!-- Filtro de Unidade (REQ 1) -->
            <div class="px-6 pt-4 pb-2">
                <label for="local-unit-filter" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                    üè¢ Selecione a Unidade para Auditar
                </label>
                <select 
                    id="local-unit-filter" 
                    class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-inventario focus:border-inventario transition duration-150 bg-white font-semibold" 
                    onchange="setupLocalLinkingModal(this.value)"
                >
                    <option value="none">Selecione a Unidade</option>
                </select>
            </div>

            <!-- Listas de Locais (REQ 1: Modo Auditoria) -->
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[50vh] overflow-y-auto custom-scrollbar">
                <div class="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                    <!-- REQ 1: Contador de Locais -->
                    <h3 class="text-xl font-bold text-inventario mb-3 flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            <span class="text-2xl">üìã</span>
                            <span>Invent√°rio (Origem)</span>
                        </span>
                        <span id="inv-local-count" class="bg-blue-300 text-blue-900 px-3 py-1 rounded-full text-sm font-bold">0 Locais</span>
                    </h3>
                    <ul id="local-inv-list" class="space-y-2 text-sm text-gray-700">
                        <li class="text-gray-500 italic p-3">Selecione uma unidade para carregar os locais.</li>
                    </ul>
                </div>
                
                <div class="bg-orange-50 rounded-xl p-5 border-2 border-orange-200">
                    <!-- REQ 1: Contador de Locais -->
                    <h3 class="text-xl font-bold text-sistema mb-3 flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            <span class="text-2xl">‚öôÔ∏è</span>
                            <span>Sistema (Destino)</span>
                        </span>
                        <span id="sis-local-count" class="bg-orange-300 text-orange-900 px-3 py-1 rounded-full text-sm font-bold">0 Locais</span>
                    </h3>
                    <ul id="local-sis-list" class="space-y-2 text-sm text-gray-700">
                        <li class="text-gray-500 italic p-3">Selecione um local √† esquerda para auditar o mapeamento, ou clique em um local aqui para definir um novo destino.</li>
                    </ul>
                </div>
            </div>
            
            <!-- Controles de A√ß√£o (REQ 1) -->
            <div class="p-6 border-t border-gray-200 bg-gray-50">
                <div id="local-linking-action-panel" class="flex flex-col gap-3">
                    <p id="current-local-status" class="text-lg font-bold text-gray-800 text-center">Selecione um local do Invent√°rio para auditar.</p>
                    
                    <div class="flex flex-wrap gap-3 justify-center">
                        <button 
                            id="btn-confirm-local"
                            onclick="confirmLocalLink()" 
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition"
                            disabled
                        >
                            ‚úÖ Confirmar V√≠nculo
                        </button>
                        <button 
                            id="btn-remove-local"
                            onclick="removeLocalLink()" 
                            class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition"
                            disabled
                        >
                            üóëÔ∏è Remover V√≠nculo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl flex justify-between items-center">
                <button onclick="reanalyzeWithLinks()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition">
                    üîÑ Reanalisar e Fechar
                </button>
                <button 
                    onclick="closeLocalLinkingModal()" 
                    class="px-8 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-xl hover:from-gray-700 hover:to-gray-800 transition duration-200 shadow-lg"
                >
                    Fechar
                </button>
            </div>
        </div>
    </div>


    <script>
        // === VARI√ÅVEIS GLOBAIS ===
        let auditData = [];
        let globalInventarioData = []; 
        let globalSistemaData = [];    
        let uniqueUnits = new Set();
        let discrepancyDetails = new Map(); 
        let currentSearchTerm = '';
        
        // VINCULA√á√ÉO DE ITEM/TOMBO (AGORA RASTREIA POR INSTANCE ID √öNICO)
        // itemLinks: Map<compositeKey, Map<invInstanceId, sisInstanceId>>
        let itemLinks = new Map(); 
        let itemLinkingMode = false;
        let selectedInvItem = null; // Agora armazena o instanceId
        let selectedSysItem = null; // Agora armazena o instanceId
        let currentCompositeKey = '';

        // VINCULA√á√ÉO DE LOCAL (REQ 1)
        let locationLinks = new Map(); // Map<compositeKeyInv, compositeKeySis>
        let locationLinkingMode = false;
        let currentAuditedInvKey = null; // Apenas o local do Invent√°rio sendo auditado
        let allUniqueLocations = { inv: new Map(), sis: new Map() }; // Mapa global de todos os locais √∫nicos para o modal
        let autoMapSuggestions = new Map(); // Cache para sugest√µes de auto-map

        // Cabe√ßalhos de exporta√ß√£o final (definidos pelo usu√°rio)
        const FINAL_HEADERS = ['Tipo', 'Tombamento', 'Descri√ß√£o', 'Unidade', 'Quantidade', 'Localiza√ß√£o', 'Estado', 'Origem da Doa√ß√£o', 'Observa√ß√£o', 'Fornecedor'];

        // Colunas chave para busca nos dados
        const COLUMNS = {
            INV: {
                UNIT: 'unidade',
                LOCAL: 'local',
                ITEM: 'item',
                ID: 'tombo',
                STATE: 'estado de conserva√ß√£o' // CORRIGIDO: Mapeia para a chave exata
            },
            SIS: {
                UNIT: 'unidade',
                LOCAL: 'localiza√ß√£o', // CORRIGIDO: Mapeia para a chave exata
                ITEM: 'descri√ß√£o',    // CORRIGIDO: Mapeia para a chave exata
                ID: 'tombamento',
                STATE: 'estado'
            }
        };

        // Carrega links do localStorage
        function loadLinksFromStorage() {
            const storedItem = localStorage.getItem('itemLinks');
            const storedLocal = localStorage.getItem('locationLinks'); 

            if (storedItem) {
                try {
                    // Item Links: Estrutura Map<compositeKey, Map<invInstanceId, sisInstanceId>>
                    const parsed = JSON.parse(storedItem);
                    itemLinks = new Map(Object.entries(parsed).map(([key, val]) => [key, new Map(Object.entries(val))]));
                } catch (e) {
                    console.error('Erro ao carregar links de item:', e);
                }
            }
             if (storedLocal) {
                try {
                    locationLinks = new Map(Object.entries(JSON.parse(storedLocal)));
                } catch (e) {
                    console.error('Erro ao carregar links de local:', e);
                }
            }

            updateLinkCount();
        }

        // Salva links no localStorage
        function saveLinksToStorage() {
            // Item Links: Converte Map<compositeKey, Map<invInstanceId, sisInstanceId>> para Objeto
            const itemObj = {};
            itemLinks.forEach((value, key) => {
                itemObj[key] = Object.fromEntries(value);
            });
            localStorage.setItem('itemLinks', JSON.stringify(itemObj));
            
            localStorage.setItem('locationLinks', JSON.stringify(Object.fromEntries(locationLinks)));

            updateLinkCount();
        }

        // Atualiza contador de links
        function updateLinkCount() {
            let total = 0;
            itemLinks.forEach(map => total += map.size);
            
            total += locationLinks.size; 

            document.getElementById('link-count').textContent = total;
            document.getElementById('modal-link-count').textContent = total;
        }

        // === FUN√á√ïES B√ÅSICAS GLOBAIS (CORRIGIDO ERRO DE REFER√äNCIA) ===
        
        function showCustomConfirm(message, onConfirm) {
            // Implementa√ß√£o da fun√ß√£o showCustomConfirm
            const existingConfirm = document.getElementById('custom-confirm');
            if (existingConfirm) existingConfirm.remove();
            
            const confirmDiv = document.createElement('div');
            confirmDiv.id = 'custom-confirm';
            confirmDiv.className = 'modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300';
            
            confirmDiv.innerHTML = `
                <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl transform scale-95 transition-all duration-300 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">${message}</h3>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-btn-no" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg transition">
                            Cancelar
                        </button>
                        <button id="confirm-btn-yes" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition">
                            Confirmar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
            
            const modalContent = confirmDiv.querySelector('.modal-content');
            
            setTimeout(() => {
                confirmDiv.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            const closeConfirm = () => {
                confirmDiv.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => confirmDiv.remove(), 300);
            };
            
            document.getElementById('confirm-btn-yes').onclick = () => {
                onConfirm();
                closeConfirm();
            };
            document.getElementById('confirm-btn-no').onclick = closeConfirm;
        }

        function showCustomAlert(message) {
            // Implementa√ß√£o da fun√ß√£o showCustomAlert
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300';
            
            alertDiv.innerHTML = `
                <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl transform scale-95 transition-all duration-300 p-6">
                    <p class="text-gray-700 whitespace-pre-line mb-6">${message}</p>
                    <div class="flex justify-end">
                        <button id="alert-btn-ok" class="px-8 py-2 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg transition">
                            OK
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            const modalContent = alertDiv.querySelector('.modal-content');
            
            setTimeout(() => {
                alertDiv.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            const closeAlert = () => {
                alertDiv.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => alertDiv.remove(), 300);
            };
            
            document.getElementById('alert-btn-ok').onclick = closeAlert;
        }

        
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            // APLICA TRIM e remove acentos e substitui pontua√ß√µes por espa√ßo, e espa√ßos m√∫ltiplos por um √∫nico espa√ßo
            return str
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[-/.,;:()]/g, ' ') // Substitui pontua√ß√µes por espa√ßo
                .replace(/\s+/g, ' ')
                .trim(); // Garante que n√£o h√° espa√ßos iniciais/finais ap√≥s a limpeza
        }

        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            
            // 1. Prioriza tabula√ß√£o (copiar de planilha)
            const separators = {
                '\t': (firstLine.match(/\t/g) || []).length,
                ';': (firstLine.match(/;/g) || []).length,
                ',': (firstLine.match(/,/g) || []).length,
                '|': (firstLine.match(/\|/g) || []).length
            };
            
            let separator = '\t'; // Default to tab
            let maxCount = separators['\t'];

            // Se a tabula√ß√£o n√£o for o separador mais comum, encontra o mais comum.
            Object.keys(separators).forEach(sep => {
                if (separators[sep] > maxCount) {
                    maxCount = separators[sep];
                    separator = sep;
                }
            });
            
            if (maxCount === 0) {
                 // Se n√£o encontrou separador, a primeira linha inteira ser√° o cabe√ßalho.
                 // Isso for√ßar√° o erro de valida√ß√£o de colunas se os dados n√£o estiverem formatados.
            }
            
            const rawHeaders = lines[0].split(separator).map(h => h.trim()).filter(h => h.length > 0);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length >= rawHeaders.length && values.some(v => v !== '')) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        // Garante que se o valor estiver faltando, ele seja uma string vazia, n√£o undefined
                        item[header] = values[index] !== undefined ? values[index] : '';
                    });
                    data.push(item);
                }
            }
            
            return data;
        }

        function clearTextarea(id) {
            document.getElementById(id).value = '';
            updateDataCount();
        }

        function showLoading(show = true) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                setTimeout(() => overlay.classList.add('hidden'), 500);
            }
        }

        function updateDataCount() {
            const invTextarea = document.getElementById('list-inventario');
            const sistemaTextarea = document.getElementById('list-sistema');
            
            const invLines = invTextarea.value.trim().split('\n').filter(Boolean).length;
            const sisLines = sisTextarea.value.trim().split('\n').filter(Boolean).length;
            
            const invCount = Math.max(0, invLines - 1);
            const sisCount = Math.max(0, sisLines - 1);
            
            document.getElementById('count-inventario').textContent = invCount;
            document.getElementById('count-sistema').textContent = sisCount;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Fun√ß√£o antiga groupItems removida/n√£o mais necess√°ria para renderModalLists

        // === FUN√á√ïES DO GERENCIADOR DE LINKS (CORRE√á√ÉO DE BUGS DE LIMPEZA/DELETAR/EXPORTAR/IMPORTAR) ===

        function clearAllLinks() {
            showCustomConfirm("Tem certeza que deseja limpar TODAS as vincula√ß√µes de Itens e Locais salvas? Isso n√£o pode ser desfeito.", () => {
                itemLinks = new Map();
                locationLinks = new Map();
                saveLinksToStorage();
                updateLinkCount();
                closeLinkManager();
                // A fun√ß√£o `closeLinkManager` garante que o modal estar√° fechado.
                showCustomAlert("‚úÖ Todas as vincula√ß√µes foram removidas. Execute a An√°lise para atualizar o relat√≥rio.");
            });
        }
        
        function exportLinks() {
            const dataToExport = {
                // Converte Map<compositeKey, Map<invInstanceId, sisInstanceId>> para Objeto aninhado para exporta√ß√£o JSON
                itemLinks: Object.fromEntries([...itemLinks].map(([key, map]) => [key, Object.fromEntries(map)])),
                locationLinks: Object.fromEntries(locationLinks)
            };
            
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vinculos_auditoria.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showCustomAlert('üì• V√≠nculos exportados como vinculos_auditoria.json');
        }

        function importLinks() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        let linksLoaded = 0;
                        
                        if (data.itemLinks) {
                            // Item Links: Converte Objeto aninhado de volta para Map<compositeKey, Map<invInstanceId, sisInstanceId>>
                            itemLinks = new Map(Object.entries(data.itemLinks).map(([key, val]) => {
                                linksLoaded += Object.keys(val).length;
                                return [key, new Map(Object.entries(val))];
                            }));
                        } else {
                            itemLinks = new Map();
                        }
                        
                        if (data.locationLinks) {
                            locationLinks = new Map(Object.entries(data.locationLinks));
                            linksLoaded += locationLinks.size;
                        } else {
                            locationLinks = new Map();
                        }
                        
                        saveLinksToStorage();
                        updateLinkCount();
                        
                        if (linksLoaded > 0) {
                            showCustomAlert(`üì§ ${linksLoaded} v√≠nculos importados com sucesso! Execute a An√°lise para aplicar no relat√≥rio.`);
                        } else {
                            showCustomAlert(`‚ÑπÔ∏è Nenhum v√≠nculo encontrado no arquivo importado. As vincula√ß√µes atuais foram limpas.`);
                        }

                    } catch (error) {
                        showCustomAlert(`‚ùå Erro ao processar o arquivo JSON: O arquivo pode estar corrompido ou no formato incorreto. Erro: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }
        
        // Fun√ß√£o para remover um √∫nico link (chamada do Gerenciador de Links)
        function removeLink(type, key1) {
            // type: 'item|compositeKey' ou 'LOCAL_LINK'
            // key1: invInstanceId (para item) ou invKey (para local)

            if (type.startsWith('item|')) {
                const compositeKey = type.split('|')[1];
                if (itemLinks.has(compositeKey)) {
                    const locationLinksMap = itemLinks.get(compositeKey); // Map<invInstanceId, sisInstanceId>
                    // key1 √© o invInstanceId
                    locationLinksMap.delete(key1); 
                    if (locationLinksMap.size === 0) {
                        itemLinks.delete(compositeKey);
                    }
                }
            } else if (type === 'LOCAL_LINK') {
                // key1 √© o invKey
                locationLinks.delete(key1);
            }

            saveLinksToStorage();
            updateLinkManagerDisplay(); // Atualiza o modal de gerenciamento
            showCustomAlert('üóëÔ∏è V√≠nculo removido com sucesso! Execute a An√°lise para atualizar o relat√≥rio.');
        }

        // === AN√ÅLISE PRINCIPAL ===
        
        async function runMasterCount() {
            showLoading(true);
            document.getElementById('results-container').classList.add('hidden');
            await new Promise(resolve => setTimeout(resolve), 100);
            
            try {
                globalInventarioData = parseData(document.getElementById('list-inventario').value);
                globalSistemaData = parseData(document.getElementById('list-sistema').value);
                
                if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                    showCustomAlert("‚ö†Ô∏è Por favor, cole os dados antes de analisar.");
                    showLoading(false);
                    return;
                }

                await processAuditData();
                
                document.getElementById('results-container').classList.remove('hidden');
                document.getElementById('filter-container').classList.remove('hidden');
                document.getElementById('search-container').classList.remove('hidden');
                
                populateUnitFilter(); 
                document.getElementById('unit-filter').value = 'all_divergent';
                document.getElementById('local-search').value = '';
                
                filterResultCards('all_divergent');
                showLoading(false);
                
                setTimeout(() => {
                    document.getElementById('results-container').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
                
            } catch (error) { 
                console.error('Erro:', error);
                showCustomAlert(`‚ùå Erro ao processar: ${error.message}`);
                showLoading(false);
            }
        }

        function findColumn(headers, key) {
             // Normaliza a chave buscada para compara√ß√£o
             const normalizedKey = normalizeString(key);
             
             // 1. Tenta encontrar a chave exata (mesmo com case-insensibilidade/acentos)
             let found = headers.find(h => normalizeString(h) === normalizedKey);
             if (found) return found;
             
             // 2. Se n√£o encontrou, busca a coluna que contenha a palavra-chave (mais robusto)
             found = headers.find(h => normalizeString(h).includes(normalizedKey));
             if (found) return found;
             
             // 3. Busca a chave que o usu√°rio pode ter colado de forma compacta (ex: 'Localizacao' em 'TipoTombamentoLocalizacao')
             // Esta √© uma busca arriscada, mas necess√°ria para dados mal formatados
             if (normalizedKey.length > 0) {
                for (const header of headers) {
                    const normalizedHeader = normalizeString(header);
                    if (normalizedHeader.includes(normalizedKey)) {
                         return header;
                    }
                }
             }

             return null;
        }

        // Processa dados e aplica Vincula√ß√£o de Local (REQ 1)
        async function processAuditData() {
            const inventarioMap = new Map();
            const sistemaMap = new Map();
            const allCompositeKeys = new Set();
            discrepancyDetails.clear();
            
            const invHeader = globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : [];
            const sisHeader = globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : [];
            
            const invUnitCol = findColumn(invHeader, COLUMNS.INV.UNIT);
            const invLocalCol = findColumn(invHeader, COLUMNS.INV.LOCAL);
            const invItemCol = findColumn(invHeader, COLUMNS.INV.ITEM);
            const invIdCol = findColumn(invHeader, COLUMNS.INV.ID);     
            const invStateCol = findColumn(invHeader, COLUMNS.INV.STATE); 
            
            const sisUnitCol = findColumn(sisHeader, COLUMNS.SIS.UNIT);
            const sisLocalCol = findColumn(sisHeader, COLUMNS.SIS.LOCAL);
            const sisItemCol = findColumn(sisHeader, COLUMNS.SIS.ITEM);
            const sisIdCol = findColumn(sisHeader, COLUMNS.SIS.ID);     
            const sisStateCol = findColumn(sisHeader, COLUMNS.SIS.STATE); 
            
            // 1. Valida√ß√£o de Colunas
            if (globalInventarioData.length > 0 && !invLocalCol) throw new Error(`Coluna 'Local' (${COLUMNS.INV.LOCAL}) n√£o encontrada no Invent√°rio. Cabe√ßalhos encontrados: [${invHeader.join(', ')}]`);
            if (globalInventarioData.length > 0 && !invIdCol) throw new Error(`Coluna 'Tombo' (${COLUMNS.INV.ID}) n√£o encontrada no Invent√°rio. Cabe√ßalhos encontrados: [${invHeader.join(', ')}]`);
            if (globalSistemaData.length > 0 && !sisLocalCol) throw new Error(`Coluna 'Localiza√ß√£o' (${COLUMNS.SIS.LOCAL}) n√£o encontrada no Sistema. Cabe√ßalhos encontrados: [${sisHeader.join(', ')}]`);
            if (globalSistemaData.length > 0 && !sisIdCol) throw new Error(`Coluna 'Tombamento' (${COLUMNS.SIS.ID}) n√£o encontrada no Sistema. Cabe√ßalhos encontrados: [${sisHeader.join(', ')}]`);


            // 2. Pr√©-coleta de Locais √önicos (para o Modal de Local Linking)
            allUniqueLocations = { inv: new Map(), sis: new Map() };
            
            globalInventarioData.forEach(item => {
                const unidade = invUnitCol ? (item[invUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                const local = invLocalCol ? (item[invLocalCol] || 'Sem Local').trim() : 'Sem Local';
                // CRIA A CHAVE NORMALIZADA (UNIFICANDO AS DUPLICA√á√ïES)
                const key = `${normalizeString(unidade)}|${normalizeString(local)}`;
                if (local !== 'Sem Local' && !allUniqueLocations.inv.has(key)) {
                    allUniqueLocations.inv.set(key, { unit: unidade, local: local, key: key });
                }
            });
            globalSistemaData.forEach(item => {
                const unidade = sisUnitCol ? (item[sisUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                const local = sisLocalCol ? (item[sisLocalCol] || 'Sem Local').trim() : 'Sem Local';
                 // CRIA A CHAVE NORMALIZADA (UNIFICANDO AS DUPLICA√á√ïES)
                const key = `${normalizeString(unidade)}|${normalizeString(local)}`;
                if (local !== 'Sem Local' && !allUniqueLocations.sis.has(key)) {
                    allUniqueLocations.sis.set(key, { unit: unidade, local: local, key: key });
                }
            });


            // 3. Processamento e Aplica√ß√£o de V√≠nculos de Local
            globalInventarioData.forEach(item => {
                const unidade = invUnitCol ? normalizeString(item[invUnitCol] || 'sem unidade') : 'sem unidade';
                const local = invLocalCol ? (item[invLocalCol] || 'sem local').trim() : 'sem local';
                
                const invCompositeKey = `${unidade}|${normalizeString(local)}`;
                const mappedSisCompositeKey = locationLinks.get(invCompositeKey);
                
                // A chave de compara√ß√£o √© a chave do sistema mapeada, ou a pr√≥pria chave do invent√°rio (se n√£o houver link)
                const compositeKey = mappedSisCompositeKey || invCompositeKey;
                
                const localOriginal = local; 
                const itemId = invIdCol ? (item[invIdCol] || `Item sem Tombo Inv-${Math.random()}`).trim() : `Item sem Tombo Inv-${Math.random()}`;
                
                allCompositeKeys.add(compositeKey);
                
                if (!inventarioMap.has(compositeKey)) {
                    inventarioMap.set(compositeKey, { 
                        count: 0, 
                        items: [],
                        originalUnit: item[invUnitCol] || 'Sem Unidade', 
                        originalLocal: localOriginal || 'Sem Local',
                        actualInvKey: invCompositeKey
                    });
                }
                const data = inventarioMap.get(compositeKey);
                data.count++;
                
                // BUG FIX 2: Adiciona um ID de inst√¢ncia √∫nico para permitir vincula√ß√£o granular
                data.items.push({ 
                    instanceId: `inv-${Date.now()}-${data.count}-${Math.floor(Math.random() * 10000)}`, // Novo ID de inst√¢ncia
                    itemId: itemId, 
                    data: item, 
                    description: invItemCol ? (item[invItemCol] || `Item sem Descri√ß√£o - ${itemId}`).trim() : `Item sem Descri√ß√£o - ${itemId}`,
                    state: invStateCol ? (item[invStateCol] || '-').trim() : '-' 
                });
            });
            
            globalSistemaData.forEach(item => {
                const unidade = sisUnitCol ? normalizeString(item[sisUnitCol] || 'sem unidade') : 'sem unidade';
                const local = sisLocalCol ? (item[sisLocalCol] || 'sem local').trim() : 'sem local'; 
                const compositeKey = `${unidade}|${normalizeString(local)}`;
                
                const localOriginal = local; 
                const itemId = sisIdCol ? (item[sisIdCol] || `Item sem Tombo Sis-${Math.random()}`).trim() : `Item sem Tombo Sis-${Math.random()}`;

                allCompositeKeys.add(compositeKey);

                if (!sistemaMap.has(compositeKey)) {
                    sistemaMap.set(compositeKey, { 
                        count: 0, 
                        items: [],
                        originalUnit: item[sisUnitCol] || 'Sem Unidade', 
                        originalLocal: localOriginal || 'Sem Local' ,
                        actualSisKey: compositeKey
                    });
                }
                const data = sistemaMap.get(compositeKey);
                
                data.count++;
                
                // BUG FIX 2: Adiciona um ID de inst√¢ncia √∫nico para permitir vincula√ß√£o granular
                data.items.push({ 
                    instanceId: `sis-${Date.now()}-${data.count}-${Math.floor(Math.random() * 10000)}`, // Novo ID de inst√¢ncia
                    itemId: itemId, 
                    data: item,
                    description: sisItemCol ? (item[sisItemCol] || `Item sem Descri√ß√£o - ${itemId}`).trim() : `Item sem Descri√ß√£o - ${itemId}`,
                    state: sisStateCol ? (item[sisStateCol] || '-').trim() : '-' 
                });
            });

            const sortedKeys = [...allCompositeKeys].sort();

            // 4. Auditoria de Diverg√™ncias (REQ 4: Locais sem diverg√™ncia n√£o s√£o adicionados)
            auditData = [];
            for (const compositeKey of sortedKeys) {
                if (compositeKey === "sem unidade|sem local") continue;

                const invData = inventarioMap.get(compositeKey) || { count: 0, items: [], originalUnit: '', originalLocal: '', actualInvKey: '' };
                const sisData = sistemaMap.get(compositeKey) || { count: 0, items: [], originalUnit: '', originalLocal: '', actualSisKey: '' };
                
                if (invData.count === 0 && sisData.count === 0) continue;


                const qtdInv = invData.count;
                const qtdSis = sisData.count;
                const diff = qtdInv - qtdSis;

                let hasQuantityDivergence = diff !== 0;
                let hasTombamentoDivergence = false;

                // CRITICAL FIX: Filtra IDs "S/T" ou vazios da verifica√ß√£o de duplicidade de Tombo.
                const invIdsForCheck = new Set(invData.items
                    .map(i => normalizeString(i.itemId))
                    .filter(id => id !== 's t' && id !== ''));
                const sisIdsForCheck = new Set(sisData.items
                    .map(i => normalizeString(i.itemId))
                    .filter(id => id !== 's t' && id !== ''));


                const invIds = new Set(invData.items.map(i => normalizeString(i.itemId)));
                const sisIds = new Set(sisData.items.map(i => normalizeString(i.itemId)));

                if (qtdInv > 0 || qtdSis > 0) {
                    let invOnly = [...invIds].some(id => !sisIds.has(id));
                    let sisOnly = [...sisIds].some(id => !invIds.has(id));
                    
                    if (qtdInv === qtdSis && [...invIds].length !== [...sisIds].length) {
                         hasTombamentoDivergence = true;
                    } else if (invOnly || sisOnly) {
                         hasTombamentoDivergence = true;
                    }
                }
                
                if (hasQuantityDivergence || hasTombamentoDivergence) {
                    const auditRow = {
                        key: compositeKey,
                        unidade: invData.originalUnit || sisData.originalUnit,
                        local: invData.originalLocal || sisData.originalLocal,
                        originalUnit: invData.originalUnit || sisData.originalUnit,
                        originalLocal: invData.originalLocal || sisData.originalLocal,
                        // BUG FIX 1: Adiciona chave de unidade normalizada para filtragem
                        // CORRIGIDO: Utiliza a chave armazenada em invData.actualInvKey, ou a chave composta se for item S√ì do Sistema.
                        normalizedUnitKey: (invData.actualInvKey || compositeKey).split('|')[0], 
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    };
                    auditData.push(auditRow);
                    
                    discrepancyDetails.set(compositeKey, {
                        unidade: auditRow.originalUnit,
                        normalizedUnitKey: auditRow.normalizedUnitKey, // BUG FIX 1
                        local: auditRow.originalLocal,
                        invItems: invData.items.sort((a, b) => a.itemId.localeCompare(b.itemId)), 
                        sisItems: sisData.items.sort((a, b) => a.itemId.localeCompare(b.itemId)),  
                        hasQuantityDivergence: hasQuantityDivergence,
                        hasTombamentoDivergence: hasTombamentoDivergence,
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    });
                }
            }
        }

        // REQ 3: Popula filtro com APENAS unidades que cont√™m diverg√™ncia
        function populateUnitFilter() {
            // BUG FIX 1: Usa chave normalizada para garantir unicidade
            const uniqueNormalizedUnits = new Map(); // Map<normalizedKey, originalName>
            const filterSelect = document.getElementById('unit-filter');
            
            discrepancyDetails.forEach(details => {
                const normalizedKey = details.normalizedUnitKey;
                // Usa o nome original (n√£o normalizado) para a exibi√ß√£o no dropdown
                if (!uniqueNormalizedUnits.has(normalizedKey)) {
                     uniqueNormalizedUnits.set(normalizedKey, details.unidade);
                } else {
                     // Caso haja nomes originais diferentes para a mesma chave normalizada, 
                     // mantemos o primeiro encontrado (o mais representativo).
                }
            });

            uniqueNormalizedUnits.delete('');
            uniqueNormalizedUnits.delete('sem unidade');

            filterSelect.innerHTML = ''; 

            const allOption = document.createElement('option');
            allOption.value = "all_divergent";
            allOption.textContent = "üåê Todas as Unidades Divergentes";
            filterSelect.appendChild(allOption);
            
            // Filtra pelo nome normalizado, mas exibe o nome original
            const sortedKeys = [...uniqueNormalizedUnits.keys()].sort();
            sortedKeys.forEach(normKey => {
                const originalName = uniqueNormalizedUnits.get(normKey);
                const option = document.createElement('option');
                option.value = normKey; // O valor √© a chave normalizada
                option.textContent = `üè¢ ${originalName.toUpperCase()}`;
                filterSelect.appendChild(option);
            });
        }

        // REQ 4: S√≥ exibe cards para locais com diverg√™ncia
        function filterResultCards(selectedUnit) {
            const cardsContainer = document.getElementById('discrepancy-cards-container');
            const noDiscrepancyMsg = document.getElementById('no-discrepancy-message');
            cardsContainer.innerHTML = '';
            
            let totalInv = 0;
            let totalSis = 0;

            // BUG FIX 1: Filtra pela chave normalizada
            const filteredAuditData = (selectedUnit === 'all_divergent') 
                ? auditData 
                : auditData.filter(item => item.normalizedUnitKey === selectedUnit);

            for (const item of filteredAuditData) {
                totalInv += item.qtdInv;
                totalSis += item.qtdSis;
            }
            
            const searchFilteredEntries = [...discrepancyDetails.entries()].filter(([key, details]) => {
                // BUG FIX 1: Filtra pela chave normalizada
                const matchesUnit = selectedUnit === 'all_divergent' || details.normalizedUnitKey === selectedUnit;
                
                const matchesSearch = currentSearchTerm 
                    ? normalizeString(details.local).includes(normalizeString(currentSearchTerm)) ||
                      normalizeString(details.unidade).includes(normalizeString(currentSearchTerm))
                    : true;
                    
                return matchesUnit && matchesSearch;
            });

            const discrepancyCount = searchFilteredEntries.length;
            
            const groupedDetails = new Map();
            searchFilteredEntries.forEach(([key, details]) => {
                // BUG FIX 1: Agrupa pela chave normalizada
                const unitKey = details.normalizedUnitKey; 
                const unitName = details.unidade; // Nome original para exibi√ß√£o
                
                if (!groupedDetails.has(unitKey)) {
                    groupedDetails.set(unitKey, { name: unitName, items: [] });
                }
                groupedDetails.get(unitKey).items.push({key, details});
            });

            if (discrepancyCount > 0) {
                const sortedKeys = [...groupedDetails.keys()].sort();
                
                sortedKeys.forEach(unitKey => {
                    const unitGroup = groupedDetails.get(unitKey);
                    const unitSection = document.createElement('div');
                    unitSection.className = 'mb-8 border-b border-gray-200 pb-4 fade-in';
                    unitSection.innerHTML = `
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-3xl">üè¢</span>
                            <span>${unitGroup.name}</span> <!-- Exibe o nome original -->
                            <span class="ml-auto bg-primary text-white px-3 py-1 rounded-full text-sm">${unitGroup.items.length} locais com diverg√™ncia</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Cards here -->
                        </div>
                    `;
                    const cardsSubContainer = unitSection.querySelector('.grid');
                    
                    unitGroup.items.forEach(entry => {
                        const card = createDiscrepancyCard(entry.details, entry.key);
                        cardsSubContainer.appendChild(card);
                    });
                    
                    cardsContainer.appendChild(unitSection);
                });

                noDiscrepancyMsg.classList.add('hidden');
            } else {
                 // REQ 2: Exibir mensagem de conclus√£o destacada
                cardsContainer.innerHTML = `
                    <div class="p-8 bg-gradient-to-r from-green-50 to-emerald-100 rounded-xl border-4 border-green-400 shadow-xl">
                        <span class="text-6xl mb-4 block text-center">‚úÖ</span>
                        <span class="text-2xl font-bold text-green-700 block mb-2 text-center">AUDITORIA CONCLU√çDA</span>
                        <span class="text-gray-600 block text-center">Nenhuma discrep√¢ncia pendente encontrada ap√≥s a aplica√ß√£o de todos os v√≠nculos.</span>
                    </div>
                `;
                noDiscrepancyMsg.classList.add('hidden'); // Oculta a mensagem gen√©rica
            }

            updateSummaryUI(totalInv, totalSis, totalInv - totalSis);
            document.getElementById('discrepancy-count').textContent = discrepancyCount;
            
            const unitText = selectedUnit === 'all_divergent' ? 'Todas as Unidades Divergentes' : discrepancyDetails.values().next().value?.unidade.toUpperCase() || 'RELAT√ìRIO GERAL';
            document.getElementById('report-title').innerHTML = `
                <span class="text-4xl">üìà</span>
                <span>Relat√≥rio: ${unitText}</span>
            `;
        }

        // Cria card com aviso de diverg√™ncia combinada
        function createDiscrepancyCard(details, compositeKey) {
            const item = details;
            
            let cardClass = 'bg-white border-gray-300';
            let diffClass = 'text-gray-700';
            let borderColor = 'border-gray-300';
            let icon = 'üìä';
            let divergenceWarning = '';

            if (item.hasQuantityDivergence && item.hasTombamentoDivergence) {
                // Diverg√™ncia de Quantidade e Tombo
                cardClass = 'bg-gradient-to-br from-red-100 to-red-200 border-red-400';
                diffClass = 'text-red-600';
                borderColor = 'border-red-500';
                icon = 'üî•';
                divergenceWarning = '<span class="status-badge bg-red-200 text-red-800 pulse-warning">‚ö†Ô∏è Qtd. e Tombo Divergentes</span>';
            } else if (item.hasQuantityDivergence) { 
                // Diverg√™ncia de Quantidade
                cardClass = item.diff > 0 ? 'bg-gradient-to-br from-red-50 to-red-100 border-red-300' : 'bg-gradient-to-br from-orange-50 to-orange-100 border-orange-300';
                diffClass = item.diff > 0 ? 'text-red-600' : 'text-orange-600';
                borderColor = item.diff > 0 ? 'border-red-400' : 'border-orange-400';
                icon = item.diff > 0 ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'; 
                divergenceWarning = '<span class="status-badge bg-red-200 text-red-800 pulse-warning">‚ö†Ô∏è Qtd. Divergente</span>';
            } else if (item.hasTombamentoDivergence) {
                // Diverg√™ncia de Tombamento (Qtd OK)
                cardClass = 'bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-300';
                diffClass = 'text-gray-700';
                borderColor = 'border-yellow-400';
                icon = 'üîÑ'; 
                divergenceWarning = '<span class="status-badge bg-yellow-200 text-yellow-800">‚ö†Ô∏è Tombo Divergente (Qtd. OK)</span>';
            }
            
            const diffText = `${item.diff > 0 ? '+' : ''}${item.diff}`;
            
            const card = document.createElement('button');
            card.className = `p-6 border-2 rounded-xl shadow-lg text-left transition-all card-hover ${cardClass} ${borderColor}`;
            card.setAttribute('onclick', `openModal('${compositeKey}')`); 
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${item.local}</h3>
                        <p class="text-sm text-gray-600 font-semibold">üè¢ ${item.unidade}</p>
                    </div>
                    <div class="text-4xl">${icon}</div>
                </div>
                <div class="mb-4">${divergenceWarning}</div>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black text-blue-600">${item.qtdInv}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">INVENT√ÅRIO</div>
                    </div>
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black text-orange-600">${item.qtdSis}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">SISTEMA</div>
                    </div>
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black ${diffClass}">${diffText}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">DIFEREN√áA</div>
                    </div>
                </div>
            `;
            return card;
        }

        function updateSummaryUI(totalInv, totalSis, totalDiff) {
            document.getElementById('summary-inv').textContent = totalInv;
            document.getElementById('summary-sis').textContent = totalSis;
            document.getElementById('summary-diff').textContent = `${totalDiff > 0 ? '+' : ''}${totalDiff}`;
            
            const diffIcon = document.getElementById('diff-icon');
            const diffStatus = document.getElementById('diff-status');
            const diffBar = document.getElementById('progress-diff');
            
            if (totalDiff > 0) {
                diffIcon.textContent = 'üìâ';
                diffStatus.textContent = 'Falta Sistema';
                diffStatus.className = 'status-badge bg-red-200 text-red-700';
                diffBar.className = 'progress-fill bg-red-500';
            } else if (totalDiff < 0) {
                diffIcon.textContent = 'üìà';
                diffStatus.textContent = 'Sobra Sistema';
                diffStatus.className = 'status-badge bg-orange-200 text-orange-700';
                diffBar.className = 'progress-fill bg-orange-500';
            } else {
                diffIcon.textContent = '‚úÖ';
                diffStatus.textContent = 'Equil√≠brio';
                diffStatus.className = 'status-badge bg-green-200 text-green-700';
                diffBar.className = 'progress-fill bg-green-500';
            }
            
            const maxValue = Math.max(totalInv, totalSis, 1);
            document.getElementById('progress-inv').style.width = `${(totalInv / maxValue) * 100}%`;
            document.getElementById('progress-sis').style.width = `${(totalSis / maxValue) * 100}%`;
            
            const diffPercent = Math.abs(totalDiff) / maxValue * 100;
            diffBar.style.width = `${diffPercent}%`;
        }

        const searchLocal = debounce((searchTerm) => {
            currentSearchTerm = searchTerm;
            const selectedUnit = document.getElementById('unit-filter').value;
            filterResultCards(selectedUnit);
        }, 300);

        // === SISTEMA DE VINCULA√á√ÉO DE ITEM/TOMBO ===

        function toggleLinkingMode() {
            itemLinkingMode = !itemLinkingMode;
            const btn = document.getElementById('link-mode-btn');
            const info = document.getElementById('linking-info');
            
            if (itemLinkingMode) {
                btn.innerHTML = '<span>‚úñ</span><span>Desativar Vincula√ß√£o</span>';
                btn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition flex items-center gap-2';
                info.classList.remove('hidden');
                selectedInvItem = null;
                selectedSysItem = null;
            } else {
                btn.innerHTML = '<span>üîó</span><span>Ativar Modo Vincula√ß√£o de Tombo</span>';
                btn.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2';
                info.classList.add('hidden');
                cancelLinking();
                return;
            }
            
            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                 renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
            }
        }

        function cancelLinking() {
            selectedInvItem = null;
            selectedSysItem = null;
            itemLinkingMode = false;
            document.getElementById('linking-info').classList.add('hidden');
            const btn = document.getElementById('link-mode-btn');
            btn.innerHTML = '<span>üîó</span><span>Ativar Modo Vincula√ß√£o de Tombo</span>';
            btn.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2';
            
            document.querySelectorAll('.item-selected').forEach(el => el.classList.remove('item-selected'));

            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                 renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
            }
        }

        // Fun√ß√£o para selecionar item - AGORA USA O INSTANCE ID √öNICO
        function selectItemForLinking(event, instanceId, isInventory) {
            if (!itemLinkingMode) return;
            
            event.stopPropagation(); 
            
            const clickedLi = event.target.closest('li');
            if (!clickedLi) return;

            // BUG FIX 2: Usa instanceId para rastreamento
            if (isInventory) {
                selectedInvItem = instanceId;
                document.querySelectorAll('#modal-inv-list .item-selected').forEach(el => el.classList.remove('item-selected'));
                clickedLi.classList.add('item-selected');
            } else {
                selectedSysItem = instanceId;
                document.querySelectorAll('#modal-sis-list .item-selected').forEach(el => el.classList.remove('item-selected'));
                clickedLi.classList.add('item-selected');
            }
            
            if (selectedInvItem && selectedSysItem) {
                // BUG FIX 2: Passa instanceIds para a cria√ß√£o do link
                createItemLink(selectedInvItem, selectedSysItem);
            }
        }

        // Cria link e melhora efeito de escolha (itens somem)
        function createItemLink(invInstanceId, sysInstanceId) { // Agora usa Instance IDs
            if (!itemLinks.has(currentCompositeKey)) {
                itemLinks.set(currentCompositeKey, new Map());
            }
            
            const locationLinksMap = itemLinks.get(currentCompositeKey); // Renomeada para evitar conflito
            // BUG FIX 2: Linka os IDs de Inst√¢ncia, n√£o os IDs de Tombo
            locationLinksMap.set(invInstanceId, sysInstanceId);
            
            saveLinksToStorage();
            
            // Reseta sele√ß√£o
            selectedInvItem = null;
            selectedSysItem = null;
            document.querySelectorAll('.item-selected').forEach(el => el.classList.remove('item-selected'));
            
            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                // Obt√©m o Tombo ID para o alerta (Melhor UX)
                const invTombo = details.invItems.find(i => i.instanceId === invInstanceId)?.itemId || invInstanceId;
                const sysTombo = details.sisItems.find(i => i.instanceId === sysInstanceId)?.itemId || sysInstanceId;
                
                // Renderiza novamente a lista para remover os itens vinculados
                renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
                
                // Checa se a lista ficou vazia ap√≥s o link
                const invListCount = document.getElementById('modal-inv-list').querySelectorAll('li').length;
                const sisListCount = document.getElementById('modal-sis-list').querySelectorAll('li').length;
                
                if (invListCount === 0 && sisListCount === 0) {
                    showCustomAlert('‚úÖ V√≠nculo criado e diverg√™ncia resolvida! Reanalisando a tabela...');
                    closeModal();
                    runMasterCount(); // Re-run master count to remove the card from the main screen
                    return;
                }

                // Exibe alerta padr√£o (melhorado para mostrar o Tombo ID e a natureza do link)
                showCustomAlert(`‚úÖ V√≠nculo criado!\nüìã Invent√°rio Tombo: ${invTombo}\n‚öôÔ∏è Sistema Tombamento: ${sysTombo}`);
            }
        }

        function openModal(compositeKey) {
            const details = discrepancyDetails.get(compositeKey);
            if (!details) return;

            currentModalData = details;
            currentCompositeKey = compositeKey;

            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');

            document.getElementById('modal-title').textContent = `üìç ${details.local}`;
            document.getElementById('modal-search').value = '';
            
            renderModalLists(details.invItems, details.sisItems);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-100');
                modalContent.classList.add('scale-95');
            }, 10);
        }

        // Renderiza listas exibindo CADA INST√ÇNCIA e filtrando itens vinculados
        function renderModalLists(rawInvItems, rawSisItems, searchTerm = '') {
            const invList = document.getElementById('modal-inv-list');
            const sisList = document.getElementById('modal-sis-list');
            
            // Mapa de links de inst√¢ncia para este local (Map<invInstanceId, sisInstanceId>)
            const locationItemLinks = itemLinks.get(currentCompositeKey) || new Map();
            
            // Cria um Set de todas as Inv Instance IDs que foram vinculadas (para remover)
            const linkedInvIds = new Set(locationItemLinks.keys());
            // Cria um Set de todas as Sis Instance IDs que foram vinculadas (para remover)
            const linkedSisIds = new Set(locationItemLinks.values());

            // BUG FIX 2: Filtra itens que J√Å FORAM VINCULADOS (usando instanceId)
            const filteredInvItems = rawInvItems
                .filter(item => !linkedInvIds.has(item.instanceId)) 
                .filter(item => !searchTerm || normalizeString(item.itemId).includes(normalizeString(searchTerm)) || normalizeString(item.description).includes(normalizeString(searchTerm)));
            
            const filteredSisItems = rawSisItems
                .filter(item => !linkedSisIds.has(item.instanceId)) 
                .filter(item => !searchTerm || normalizeString(item.itemId).includes(normalizeString(searchTerm)) || normalizeString(item.description).includes(normalizeString(searchTerm)));
                
            // L√≥gica para detectar duplicidade de Tombo nos itens RESTANTES
            const countTomboInv = new Map();
            filteredInvItems.forEach(item => countTomboInv.set(item.itemId, (countTomboInv.get(item.itemId) || 0) + 1));
            const countTomboSis = new Map();
            filteredSisItems.forEach(item => countTomboSis.set(item.itemId, (countTomboSis.get(item.itemId) || 0) + 1));

            // T√≠tulos
            document.getElementById('modal-inv-title').innerHTML = `
                <span class="text-2xl">üìã</span>
                <span>Invent√°rio (${filteredInvItems.length} item(s) restante(s))</span>
            `;
            document.getElementById('modal-sis-title').innerHTML = `
                <span class="text-2xl">‚öôÔ∏è</span>
                <span>Sistema (${filteredSisItems.length} item(s) restante(s))</span>
            `;

            // Renderiza Invent√°rio - AGORA ITERA SOBRE CADA INST√ÇNCIA
            invList.innerHTML = '';
            if (filteredInvItems.length === 0) {
                invList.innerHTML = '<li class="text-gray-500 italic p-3 bg-white rounded-lg">Nenhum item restante.</li>';
            } else {
                filteredInvItems.forEach((itemData, index) => {
                    const { instanceId, itemId, description, state } = itemData;
                    
                    const li = document.createElement('li');
                    li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition item-only-inv ${itemLinkingMode ? 'linking-mode cursor-pointer' : ''}`;
                    if (itemLinkingMode) {
                        li.setAttribute('onclick', `selectItemForLinking(event, '${instanceId.replace(/'/g, "\\'")}', true)`);
                    }
                    
                    // L√≥gica de exibi√ß√£o da duplica√ß√£o (por item ID)
                    const tomboCount = countTomboInv.get(itemId);
                    const isST = normalizeString(itemId) === 's t' || normalizeString(itemId) === '';
                    
                    let badgeText;
                    if (isST) {
                        badgeText = `‚ö†Ô∏è SEM ID (Tombo: ${itemId})`;
                    } else if (tomboCount > 1) {
                        badgeText = `‚ö†Ô∏è DUPLICIDADE DE TOMBO (${itemId}) - ${tomboCount} Inst√¢ncias`;
                    } else {
                        badgeText = `A VINCULAR (Tombo: ${itemId})`;
                    }

                    li.innerHTML = `
                        <div class="flex items-center gap-3 mb-2">
                            <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">${index + 1}</span>
                            <span class="flex-1 font-medium">${description}</span>
                        </div>
                        <div class="ml-9 flex flex-wrap gap-2 items-center">
                            <span class="text-xs font-semibold text-gray-700">Estado: ${state}</span>
                            <span class="divergence-badge bg-blue-200 text-blue-800 border border-blue-400">${badgeText}</span>
                        </div>
                    `;
                    invList.appendChild(li);
                });
            }

            // Renderiza Sistema - AGORA ITERA SOBRE CADA INST√ÇNCIA
            sisList.innerHTML = '';
            if (filteredSisItems.length === 0) {
                sisList.innerHTML = '<li class="text-gray-500 italic p-3 bg-white rounded-lg">Nenhum item restante.</li>';
            } else {
                filteredSisItems.forEach((itemData, index) => {
                    const { instanceId, itemId, description, state } = itemData;
                    
                    const li = document.createElement('li');
                    li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition item-only-sys ${itemLinkingMode ? 'linking-mode cursor-pointer' : ''}`;
                    if (itemLinkingMode) {
                         li.setAttribute('onclick', `selectItemForLinking(event, '${instanceId.replace(/'/g, "\\'")}', false)`);
                    }
                    
                    // L√≥gica de exibi√ß√£o da duplica√ß√£o (por item ID)
                    const tomboCount = countTomboSis.get(itemId);
                    const isST = normalizeString(itemId) === 's t' || normalizeString(itemId) === '';

                    let badgeText;
                    if (isST) {
                        badgeText = `‚ö†Ô∏è SEM ID (Tombamento: ${itemId})`;
                    } else if (tomboCount > 1) {
                        badgeText = `‚ö†Ô∏è DUPLICIDADE DE TOMBAMENTO (${itemId}) - ${tomboCount} Inst√¢ncias`;
                    } else {
                        badgeText = `A VINCULAR (Tombamento: ${itemId})`;
                    }

                    li.innerHTML = `
                        <div class="flex items-center gap-3 mb-2">
                            <span class="flex-shrink-0 w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs font-bold">${index + 1}</span>
                            <span class="flex-1 font-medium">${description}</span>
                        </div>
                        <div class="ml-9 flex flex-wrap gap-2 items-center">
                            <span class="text-xs font-semibold text-gray-700">Estado: ${state}</span>
                            <span class="divergence-badge bg-orange-200 text-orange-800 border border-orange-400">${badgeText}</span>
                        </div>
                    `;
                    sisList.appendChild(li);
                });
            }

            // Atualiza subt√≠tulo do modal (REQ 3, 4)
            const details = discrepancyDetails.get(currentCompositeKey);
            let subtitle = `üè¢ ${details.unidade}`;
            let linkingMessage = 'Selecione 1 item do Invent√°rio e 1 do Sistema para vincular';
            
            if (details.hasQuantityDivergence && details.hasTombamentoDivergence) {
                subtitle += ' | üö® Qtd. e Tombo Divergentes';
            } else if (details.hasQuantityDivergence) {
                subtitle += ' | ‚ö†Ô∏è Diverg√™ncia de Quantidade';
            } else if (details.hasTombamentoDivergence) {
                subtitle += ' | üîÑ Diverg√™ncia de Tombo (Qtd. OK)';
                linkingMessage = 'Esse local n√£o tem diverg√™ncia de quantidade. Vincule os IDs soltos (Tombo/Tombamento) para finalizar a liga√ß√£o.'; 
            }
            
            document.getElementById('modal-subtitle').textContent = subtitle;
            document.getElementById('linking-info').querySelector('p').textContent = linkingMessage;
        }

        const searchModalItems = debounce((searchTerm) => {
            renderModalLists(currentModalData.invItems, currentModalData.sisItems, searchTerm);
        }, 300);

        function closeModal() {
            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                cancelLinking();
            }, 300);
        }

        // === VINCULA√á√ÉO DE LOCAL (REQ 1 - MODO AUDITORIA) ===

        // BUGFIX: Pr√©-processa os locais antes de abrir o modal
        async function toggleLocalLinkingMode() {
            // 1. Carrega os dados das textareas
            globalInventarioData = parseData(document.getElementById('list-inventario').value);
            globalSistemaData = parseData(document.getElementById('list-sistema').value);

            if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                showCustomAlert("‚ö†Ô∏è Por favor, cole os dados do Invent√°rio e Sistema antes de vincular locais.");
                return;
            }

            try {
                // 2. Re-popula allUniqueLocations (l√≥gica que tamb√©m existe em processAuditData)
                allUniqueLocations = { inv: new Map(), sis: new Map() };
                
                const invHeader = globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : [];
                const sisHeader = globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : [];
                
                const invUnitCol = findColumn(invHeader, COLUMNS.INV.UNIT);
                const invLocalCol = findColumn(invHeader, COLUMNS.INV.LOCAL);
                const sisUnitCol = findColumn(sisHeader, COLUMNS.SIS.UNIT);
                const sisLocalCol = findColumn(sisHeader, COLUMNS.SIS.LOCAL);

                // Valida√ß√£o
                if (globalInventarioData.length > 0 && !invLocalCol) throw new Error("Coluna 'Local' (Invent√°rio) n√£o encontrada.");
                if (globalSistemaData.length > 0 && !sisLocalCol) throw new Error("Coluna 'Localiza√ß√£o' (Sistema) n√£o encontrada.");

                globalInventarioData.forEach(item => {
                    const unidade = invUnitCol ? (item[invUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                    const local = invLocalCol ? (item[invLocalCol] || 'Sem Local').trim() : 'Sem Local';
                    // CRIA A CHAVE NORMALIZADA
                    const key = `${normalizeString(unidade)}|${normalizeString(local)}`;
                    if (local !== 'Sem Local' && !allUniqueLocations.inv.has(key)) {
                        allUniqueLocations.inv.set(key, { unit: unidade, local: local, key: key });
                    }
                });
                globalSistemaData.forEach(item => {
                    const unidade = sisUnitCol ? (item[sisUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                    const local = sisLocalCol ? (item[sisLocalCol] || 'Sem Local').trim() : 'Sem Local';
                    // CRIA A CHAVE NORMALIZADA
                    const key = `${normalizeString(unidade)}|${normalizeString(local)}`;
                    if (local !== 'Sem Local' && !allUniqueLocations.sis.has(key)) {
                        allUniqueLocations.sis.set(key, { unit: unidade, local: local, key: key });
                    }
                });

            } catch (error) {
                showCustomAlert(`‚ùå Erro ao pr√©-processar locais: ${error.message}`);
                return;
            }

            // 3. Inicializa e popula o modal
            setupLocalLinkingModal('none'); // Chama com 'none' para popular o filtro de unidade
            
            const modal = document.getElementById('local-linking-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            locationLinkingMode = true; // Ativa modo
            currentAuditedInvKey = null;
            document.getElementById('local-unit-filter').value = 'none'; // Reseta o filtro

            // Popula o filtro de unidades para o modal de Vincula√ß√£o
            const unitFilter = document.getElementById('local-unit-filter');
            unitFilter.innerHTML = '<option value="none">Selecione a Unidade</option>';
            const unitsMap = new Map();
            allUniqueLocations.inv.forEach(loc => unitsMap.set(normalizeString(loc.unit), loc.unit));
            allUniqueLocations.sis.forEach(loc => unitsMap.set(normalizeString(loc.unit), loc.unit));
            
            [...unitsMap.keys()].sort().forEach(normUnit => {
                if (normUnit !== 'sem unidade') {
                    const option = document.createElement('option');
                    // O TEXTO vis√≠vel ser√° o nome original (melhor guess) e o VALUE ser√° o nome normalizado (chave de busca)
                    const originalUnitName = unitsMap.get(normUnit);
                    
                    option.value = normUnit; // O VALOR √© a chave normalizada
                    option.textContent = `üè¢ ${originalUnitName}`;
                    unitFilter.appendChild(option);
                }
            });


            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        // REQ 1: Popula o modal de auditoria de local
        function setupLocalLinkingModal(selectedUnit) {
            const invList = document.getElementById('local-inv-list');
            const sisList = document.getElementById('local-sis-list');
            const invCountSpan = document.getElementById('inv-local-count');
            const sisCountSpan = document.getElementById('sis-local-count');
            
            autoMapSuggestions = new Map();
            
            if (selectedUnit === 'none') {
                invList.innerHTML = '<li class="text-gray-500 italic p-3">Selecione uma unidade para carregar os locais.</li>';
                sisList.innerHTML = '<li class="text-gray-500 italic p-3">Selecione uma unidade.</li>';
                invCountSpan.textContent = '0 Locais';
                sisCountSpan.textContent = '0 Locais';
                return;
            }
            
            invList.innerHTML = '';
            sisList.innerHTML = '';
            currentAuditedInvKey = null;
            document.getElementById('current-local-status').textContent = 'Selecione um local do Invent√°rio para auditar.';
            document.getElementById('btn-confirm-local').disabled = true;
            document.getElementById('btn-remove-local').disabled = true;


            // 2. Filtra locais pela unidade selecionada
            // selectedUnit √© a chave normalizada (ex: "unidade x")
            const normalizedUnit = selectedUnit; 
            
            const filteredInv = [...allUniqueLocations.inv.values()]
                .filter(loc => loc.key.startsWith(normalizedUnit + '|'))
                .sort((a, b) => a.local.localeCompare(b.local));
                
            const filteredSis = [...allUniqueLocations.sis.values()]
                .filter(loc => loc.key.startsWith(normalizedUnit + '|'))
                .sort((a, b) => a.local.localeCompare(b.local));
            
            // 3. Auto-mapeamento (sugest√£o)
            autoMapSuggestions = autoMapLocations(filteredInv, filteredSis);

            // 4. Renderiza lista de Invent√°rio (Origem)
            const remainingInv = filteredInv.filter(loc => !locationLinks.has(loc.key)); // Filtra locais j√° mapeados (Origem)

            // NOVO: 5. Filtra locais de Sistema (Destino) que J√Å foram vinculados
            const linkedSisKeys = new Set([...locationLinks.values()]);
            const remainingSis = filteredSis.filter(loc => !linkedSisKeys.has(loc.key)); // Filtra locais j√° mapeados (Destino)

            // REQ 1: Atualiza contadores para exibir os "restantes"
            invCountSpan.textContent = `${remainingInv.length} Locais restantes`;
            sisCountSpan.textContent = `${remainingSis.length} Locais restantes`;

            if (remainingInv.length === 0) {
                 invList.innerHTML = '<li class="text-gray-500 italic p-3">Todos os locais desta unidade foram auditados e vinculados.</li>';
            } else {
                remainingInv.forEach(loc => {
                    const li = document.createElement('li');
                    li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition cursor-pointer location-link-mode`;
                    li.setAttribute('onclick', `selectLocalForAuditing(event, '${loc.key.replace(/'/g, "\\'")}')`);
                    li.dataset.key = loc.key; 
                    
                    const linkedSisKey = locationLinks.get(loc.key); 
                    const suggestedSisKey = autoMapSuggestions.get(loc.key);
                    let badge = '';
                    let targetName = 'Sem Mapeamento';
                    
                    if (linkedSisKey) {
                        // N√£o deve chegar aqui se o filtro estiver correto
                    } else if (suggestedSisKey) {
                         targetName = allUniqueLocations.sis.get(suggestedSisKey)?.local || 'Desconhecido';
                         badge = `<span class="status-badge bg-yellow-200 text-yellow-800 ml-2">Sugest√£o: ${targetName}</span>`;
                    } else {
                         badge = `<span class="status-badge bg-gray-200 text-gray-700 ml-2">Sem V√≠nculo</span>`;
                    }
                    
                    // REQ 2: Exibe o local mapeado/sugerido ao lado do local de origem (na mesma caixa)
                    li.innerHTML = `
                        <div class="font-semibold text-base">${loc.local}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            Destino: <span class="font-bold text-gray-700">${targetName}</span>
                        </div>
                        <div class="mt-1">${badge}</div>
                    `;
                    invList.appendChild(li);
                });
            }

            // 6. Renderiza lista de Sistema (Destino) - AGORA S√ì MOSTRA OS RESTANTES
             if (remainingSis.length === 0) {
                 sisList.innerHTML = '<li class="text-gray-500 italic p-3">Todos os locais do Sistema desta unidade foram mapeados como destino.</li>';
            } else {
                remainingSis.forEach(loc => {
                    const li = document.createElement('li');
                    li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition cursor-pointer`;
                    li.setAttribute('onclick', `selectLocalForMapping(event, '${loc.key.replace(/'/g, "\\'")}')`);
                    li.dataset.key = loc.key; 
                    
                    li.innerHTML = `
                        <div class="font-semibold">${loc.local}</div>
                        <div class="text-xs text-gray-500">üè¢ ${loc.unit}</div>
                    `;
                    sisList.appendChild(li);
                });
            }
        }

        // Tenta encontrar a melhor correspond√™ncia
        function autoMapLocations(invLocs, sisLocs) {
            const suggestions = new Map();
            const sisNormMap = new Map(sisLocs.map(loc => [normalizeString(loc.local), loc.key]));

            invLocs.forEach(invLoc => {
                const normInv = normalizeString(invLoc.local);
                if (sisNormMap.has(normInv)) {
                    // Mapeamento exato (sugest√£o forte)
                    suggestions.set(invLoc.key, sisNormMap.get(normInv));
                }
            });
            return suggestions;
        }

        // REQ 1: Clica no local do Invent√°rio (Esquerda) para auditar
        function selectLocalForAuditing(event, invKey) {
            currentAuditedInvKey = invKey;
            
            // 1. Remove sele√ß√£o anterior de AMBAS as listas
            document.querySelectorAll('#local-linking-modal .location-selected').forEach(el => el.classList.remove('location-selected'));
            
            // 2. Seleciona o item do invent√°rio
            const invLi = event.target.closest('li');
            invLi.classList.add('location-selected');

            const statusText = document.getElementById('current-local-status');
            const btnConfirm = document.getElementById('btn-confirm-local');
            const btnRemove = document.getElementById('btn-remove-local');

            const invLoc = allUniqueLocations.inv.get(invKey);
            statusText.textContent = `Auditando: ${invLoc.local}`;
            
            // 3. Habilita bot√µes
            btnConfirm.disabled = false;
            btnRemove.disabled = !locationLinks.has(invKey); // S√≥ remove se j√° houver um link salvo

            // 4. Tenta destacar a sugest√£o ou o link salvo no Sistema (Direita)
            const linkedSisKey = locationLinks.get(invKey) || autoMapSuggestions.get(invKey);
            
            if (linkedSisKey) {
                const sisLi = document.querySelector(`#local-sis-list li[data-key="${linkedSisKey.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"]`);
                if (sisLi) {
                    sisLi.classList.add('location-selected');
                }
            }
        }
        
        // REQ 1: Clica no local do Sistema (Direita) para mapear
        function selectLocalForMapping(event, sisKey) {
             const sisLi = event.target.closest('li');
             
             // S√≥ permite sele√ß√£o se um local de invent√°rio estiver sendo auditado
             if (!currentAuditedInvKey) return; 

             // Remove sele√ß√£o anterior (apenas na lista do sistema)
             document.querySelectorAll('#local-sis-list .location-selected').forEach(el => el.classList.remove('location-selected'));
             
             sisLi.classList.add('location-selected');

            // Atualiza o status
            const statusText = document.getElementById('current-local-status');
            const invLoc = allUniqueLocations.inv.get(currentAuditedInvKey);
            const sisLoc = allUniqueLocations.sis.get(sisKey);
            statusText.textContent = `Pronto para VINCULAR: ${invLoc.local} ‚ûî ${sisLoc.local}`;
        }

        // REQ 1: Confirma o v√≠nculo (clicando no bot√£o "Confirmar")
        function confirmLocalLink() {
            if (!currentAuditedInvKey) {
                showCustomAlert("‚ö†Ô∏è Selecione um local do Invent√°rio primeiro.");
                return;
            }
            
            const selectedSisElement = document.querySelector('#local-sis-list .location-selected');
            const sisKeyToLink = selectedSisElement ? selectedSisElement.dataset.key : null;

            if (!sisKeyToLink) {
                 showCustomAlert("‚ö†Ô∏è Selecione um local do Sistema (destino) para vincular.");
                 return;
            }

            createLocationLink(currentAuditedInvKey, sisKeyToLink);
        }

        function createLocationLink(invKey, sisKey) {
            locationLinks.set(invKey, sisKey);
            saveLinksToStorage();
            
            const invLoc = allUniqueLocations.inv.get(invKey);
            const sisLoc = allUniqueLocations.sis.get(sisKey);
            
            showCustomAlert(`‚úÖ V√≠nculo de Local criado/confirmado!\nüìã ${invLoc.local} ‚ûî ‚öôÔ∏è ${sisLoc.local}`);
            
            // REQ 1: Atualiza a lista no modal para refletir o novo link (sumir o local)
            setupLocalLinkingModal(document.getElementById('local-unit-filter').value);
            // Reseta o painel de status
            currentAuditedInvKey = null;
            document.getElementById('current-local-status').textContent = 'Selecione um local do Invent√°rio para auditar.';
            document.getElementById('btn-confirm-local').disabled = true;
            document.getElementById('btn-remove-local').disabled = true;
        }

        // REQ 1: Remove o v√≠nculo
        function removeLocalLink() {
            if (!currentAuditedInvKey) {
                showCustomAlert("‚ö†Ô∏è Selecione um local do Invent√°rio primeiro.");
                return;
            }

            if (!locationLinks.has(currentAuditedInvKey)) {
                 showCustomAlert("‚ÑπÔ∏è Este local n√£o possui v√≠nculo salvo para remover.");
                 return;
            }

            locationLinks.delete(currentAuditedInvKey);
            saveLinksToStorage();
            
            const invLoc = allUniqueLocations.inv.get(currentAuditedInvKey);
            showCustomAlert(`‚úÖ V√≠nculo removido para: ${invLoc.local}`);

            // REQ 1: Atualiza a lista no modal
            setupLocalLinkingModal(document.getElementById('local-unit-filter').value);
            // Reseta o painel de status
            currentAuditedInvKey = null;
            document.getElementById('current-local-status').textContent = 'Selecione um local do Invent√°rio para auditar.';
            document.getElementById('btn-confirm-local').disabled = true;
            document.getElementById('btn-remove-local').disabled = true;
        }

        function closeLocalLinkingModal() {
            currentAuditedInvKey = null;
            const modal = document.getElementById('local-linking-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        // === GERENCIADOR DE LINKS ===

        function toggleLinkManager() {
            const modal = document.getElementById('link-manager-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            updateLinkManagerDisplay();
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeLinkManager() {
            const modal = document.getElementById('link-manager-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function updateLinkManagerDisplay() {
            const itemContainer = document.getElementById('item-link-list-container');
            const localContainer = document.getElementById('local-link-list-container');
            
            itemContainer.innerHTML = '';
            localContainer.innerHTML = '';
            
            // Item Links
            if (itemLinks.size === 0) {
                itemContainer.innerHTML = '<p class="text-center text-gray-500 italic p-4">Nenhuma vincula√ß√£o de item criada</p>';
            } else {
                itemLinks.forEach((links, compositeKey) => {
                    // Nota: O Tombo ID n√£o est√° armazenado no link, apenas o Instance ID.
                    // Isso ser√° um desafio, mas o Instance ID garante a funcionalidade.
                    const [unidade, local] = compositeKey.split('|');
                    
                    const section = document.createElement('div');
                    section.className = 'mb-4 p-3 bg-purple-50 rounded-xl border border-purple-200';
                    section.innerHTML = `<h4 class="font-bold text-sm text-purple-800 mb-2">üìç ${local.toUpperCase()} (${unidade.toUpperCase()})</h4><div class="space-y-1"></div>`;
                    
                    const listContainer = section.querySelector('.space-y-1');
                    
                    links.forEach((sysInstanceId, invInstanceId) => {
                        const linkItem = document.createElement('div');
                        linkItem.className = 'flex items-center justify-between bg-white p-2 rounded-lg shadow-sm text-xs';
                        // Exibe os IDs de inst√¢ncia para fins de depura√ß√£o
                        linkItem.innerHTML = `
                            <div class="flex-1">
                                <span class="font-semibold text-blue-700">Inv Instance ID: ${invInstanceId}</span>
                                <span class="mx-1 text-purple-600">üîó</span>
                                <span class="font-semibold text-orange-700">Sis Instance ID: ${sysInstanceId}</span>
                            </div>
                            <button onclick="removeLink('item|${compositeKey}', '${invInstanceId.replace(/'/g, "\\'")}')" class="px-2 py-0.5 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                                üóëÔ∏è
                            </button>
                        `;
                        listContainer.appendChild(linkItem);
                    });
                    
                    itemContainer.appendChild(section);
                });
            }
            
            // Local Links
            if (locationLinks.size === 0) {
                localContainer.innerHTML = '<p class="text-center text-gray-500 italic p-4">Nenhuma vincula√ß√£o de local criada</p>';
            } else {
                locationLinks.forEach((sysKey, invKey) => {
                    const [invUnit, invLocal] = invKey.split('|');
                    const [sysUnit, sysLocal] = sysKey.split('|');

                    const linkItem = document.createElement('div');
                    linkItem.className = 'flex items-center justify-between bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm';
                    linkItem.innerHTML = `
                        <div class="flex-1 text-sm">
                            <span class="font-bold text-blue-700">Inv: ${invLocal.toUpperCase()} (${invUnit.toUpperCase()})</span>
                            <span class="mx-2 text-blue-600">üó∫Ô∏è VINCULADO A</span>
                            <span class="font-bold text-orange-700">Sis: ${sysLocal.toUpperCase()} (${sysUnit.toUpperCase()})</span>
                        </div>
                        <button onclick="removeLink('LOCAL_LINK', '${invKey.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold transition">
                            üóëÔ∏è
                        </button>
                    `;
                    localContainer.appendChild(linkItem);
                });
            }
            
            updateLinkCount();
        }

        // === INICIALIZA√á√ÉO ===
        
        function setupDataListeners() {
            const inventarioTextarea = document.getElementById('list-inventario');
            const sistemaTextarea = document.getElementById('list-sistema');
            
            const debouncedUpdate = debounce(updateDataCount, 300);
            
            inventarioTextarea.addEventListener('input', debouncedUpdate);
            sistemaTextarea.addEventListener('input', debouncedUpdate);
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Fecha modais abertos
                    closeModal();
                    closeLinkManager();
                    closeFinalReport();
                    closeLocalLinkingModal();
                    
                    const confirmModal = document.getElementById('custom-confirm');
                    if(confirmModal) confirmModal.remove();
                    
                    const alertModal = document.getElementById('custom-alert');
                    if(alertModal) alertModal.remove();
                }
                
                if (e.ctrlKey && e.key === 'Enter') {
                    runMasterCount();
                }
            });
            
            // Carrega links salvos
            loadLinksFromStorage();
        }

        window.onload = () => {
            setupDataListeners();
            console.log('üöÄ Sistema com Vincula√ß√£o Inteligente carregado!');
        };
    </script>
</body>
</html>
