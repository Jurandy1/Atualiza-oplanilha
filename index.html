<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reconcilia칞칚o de Invent치rio</title>
    <!-- Carregando Tailwind CSS para estiliza칞칚o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definindo a fonte padr칚o e ajustes visuais */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        textarea {
            resize: none;
            height: 300px;
            @apply shadow-inner;
        }
        /* Responsividade da tabela */
        @media (max-width: 640px) {
            .responsive-table th, .responsive-table td {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                font-size: 0.75rem; /* extra small */
            }
        }
        .table-container { max-height: 600px; } /* Altura m치xima para rolagem na tabela */
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Esmeralda */
                        'primary-dark': '#059669',
                        'inventario': '#3b82f6', /* Azul */
                        'sistema': '#f97316', /* Laranja */
                        'export': '#8b5cf6', /* Violeta */
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 border-b-4 border-primary pb-2 flex items-center">
            Sistema de Reconcilia칞칚o de Invent치rio (Consolidado) 游늵
        </h1>
        <p class="text-gray-600 mb-6">
            Cole os dados diretamente das suas planilhas (Tab-Separated/TSV ou CSV) para conciliar o estoque. O sistema usar치 o **Tombo/Tombamento** como chave e agrupar치 por **Unidade** (CRAS).
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Invent치rio (Fonte) -->
            <div>
                <label for="list-inventario" class="block text-lg font-semibold text-inventario mb-2 flex items-center">
                    <span class="mr-2">游늶</span>
                    1. Dados do Invent치rio (Fonte da Verdade)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Cabe칞alho Esperado:** Unidade, Item, Tombo, Local, Estado de Conserva칞칚o
                </p>
                <textarea id="list-inventario" class="w-full p-3 border border-inventario rounded-lg focus:ring-inventario focus:border-inventario transition duration-150" placeholder="Cole aqui os dados do Invent치rio, incluindo o cabe칞alho..."></textarea>
                <span id="count-inventario" class="text-sm text-gray-500 mt-1 block">Total de Itens no Invent치rio: 0</span>
            </div>
            
            <!-- Sistema (Destino) -->
            <div>
                <label for="list-sistema" class="block text-lg font-semibold text-sistema mb-2 flex items-center">
                    <span class="mr-2">丘뙖잺</span>
                    2. Dados do Sistema (Estoque Atual)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Cabe칞alho Esperado:** Tipo, Tombamento, Descri칞칚o, Unidade, Localiza칞칚o, Estado, Origem da Doa칞칚o, Observa칞칚o, Fornecedor
                </p>
                <textarea id="list-sistema" class="w-full p-3 border border-sistema rounded-lg focus:ring-sistema focus:border-sistema transition duration-150" placeholder="Cole aqui os dados do Sistema, incluindo o cabe칞alho..."></textarea>
                <span id="count-sistema" class="text-sm text-gray-500 mt-1 block">Total de Itens no Sistema: 0</span>
            </div>
        </div>

        <button onclick="reconcileInventory()" class="w-full px-6 py-3 bg-primary text-white font-bold text-xl rounded-xl shadow-lg hover:bg-primary-dark transition duration-300 transform hover:scale-[1.01]">
            Realizar Reconcilia칞칚o e Gerar Relat칩rio
        </button>

        <!-- Container de Resultados -->
        <div id="results-container" class="mt-12 hidden">
            
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">
                Relat칩rio Final de Reconcilia칞칚o (Padr칚o Sistema)
            </h2>
            
            <!-- Filtro por Unidade (CRAS) -->
            <div id="unit-filter-container">
                <!-- Dropdown ser치 injetado aqui -->
            </div>

            <!-- Resumo -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-4 rounded-lg bg-blue-100 shadow-md">
                    <p class="text-3xl font-bold text-blue-700" id="total-inventario-final">0</p>
                    <p class="text-sm text-blue-600">Total Invent치rio (Base)</p>
                </div>
                <div class="p-4 rounded-lg bg-green-100 shadow-md">
                    <p class="text-3xl font-bold text-green-700" id="total-adicionar">0</p>
                    <p class="text-sm text-green-600">A칞칚o: Adicionar (Faltando no Sistema)</p>
                </div>
                <div class="p-4 rounded-lg bg-red-100 shadow-md">
                    <p class="text-3xl font-bold text-red-700" id="total-excluir">0</p>
                    <p class="text-sm text-red-600">A칞칚o: Excluir (Sobrante no Sistema)</p>
                </div>
            </div>

            <!-- NOVO BLOCO: ITENS FALTANDO (ADICIONAR) -->
            <div id="missing-items-container" class="mt-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b-2 border-green-500 pb-1 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                    </svg>
                    Itens Faltando no Sistema (Para ADICIONAR) 游릭
                </h3>
                <p class="text-sm text-gray-600 mb-2">Estes itens est칚o no Invent치rio Base, mas n칚o foram encontrados no Sistema. Eles devem ser adicionados ao estoque, no local listado do Invent치rio (Lista 1).</p>
                <div class="overflow-x-auto rounded-lg shadow-xl">
                    <table class="min-w-full bg-white responsive-table">
                        <thead class="bg-green-100 border-b-2 border-green-300 sticky top-0">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Item (Descri칞칚o)</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tombo</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Local Exato (Invent치rio)</th>
                                <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unidade</th>
                            </tr>
                        </thead>
                        <tbody id="missing-items-body" class="divide-y divide-gray-200">
                            <!-- Itens faltantes ser칚o injetados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- FIM DO NOVO BLOCO -->


            <!-- Export Button -->
            <button onclick="exportCSV()" class="w-full md:w-auto px-6 py-2 bg-export text-white font-bold rounded-lg shadow-md hover:bg-violet-700 transition duration-300 transform hover:scale-[1.01] mb-4 mt-8">
                Exportar Relat칩rio CSV (Unidade Selecionada)
            </button>
            
            <!-- Tabela Principal de Resultados (Completa) -->
            <div class="overflow-x-auto rounded-lg shadow-xl table-container">
                <h3 class="text-lg font-bold text-gray-700 mb-2">Tabela de Reconcilia칞칚o Detalhada (Todos os Itens)</h3>
                <table class="min-w-full bg-white responsive-table">
                    <thead class="bg-gray-200 border-b-2 border-gray-300 sticky top-0">
                        <tr>
                            <!-- Cabe칞alho do Sistema + A칞칚o -->
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">A칞칚o Sugerida</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tombamento</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Localiza칞칚o</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unidade</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descri칞칚o (Item)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Estado</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Tipo/Observa칞칚o</th>
                        </tr>
                    </thead>
                    <tbody id="results-body" class="divide-y divide-gray-200">
                        <!-- Resultados ser칚o injetados aqui -->
                    </tbody>
                </table>
            </div>

            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Observa칞칚o Importante sobre a Contagem</h3>
                <p id="summary-text" class="text-yellow-700">Aguardando a an치lise da unidade selecionada...</p>
            </div>
        </div>
        
    </div>

    <script>
        // Global variables for storing and managing data
        let reconciledDataByUnit = {};
        let inventarioTotalByUnit = {};

        // Mapeamento de colunas do Invent치rio para o padr칚o do Sistema
        const INVENTARIO_MAP = {
            'Tombo': 'Tombamento',
            'Item': 'Descri칞칚o',
            'Local': 'Localiza칞칚o',
            'Estado de Conserva칞칚o': 'Estado',
            'Unidade': 'Unidade'
        };

        const SISTEMA_HEADERS = [
            'Tipo', 'Tombamento', 'Descri칞칚o', 'Unidade', 
            'Localiza칞칚o', 'Estado', 'Origem da Doa칞칚o', 
            'Observa칞칚o', 'Fornecedor'
        ];

        // Fun칞칚o para detetar o separador (v칤rgula, ponto e v칤rgula, ou tab) e parsear os dados
        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            let separator = '\t'; // Tentativa padr칚o: Tab
            if (firstLine.includes(';')) {
                separator = ';';
            } else if (firstLine.includes(',')) {
                 // Conta a frequ칡ncia de cada separador na primeira linha
                const counts = { ',': (firstLine.match(/,/g) || []).length, ';': (firstLine.match(/;/g) || []).length, '\t': (firstLine.match(/\t/g) || []).length };
                
                // Escolhe o separador com maior contagem (se for maior que zero)
                if (counts[';'] > counts[','] && counts[';'] > counts['\t']) {
                    separator = ';';
                } else if (counts[','] > counts[';'] && counts[','] > counts['\t']) {
                    separator = ',';
                } else if (counts['\t'] === 0 && counts[','] === 0 && counts[';'] === 0) {
                     // Caso n칚o haja separador, assume espa칞o
                     separator = ' ';
                }
            }


            const rawHeaders = lines[0].split(separator).map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length === rawHeaders.length) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        item[header] = values[index];
                    });
                    data.push(item);
                }
            }
            return data;
        }

        // Fun칞칚o principal de reconcilia칞칚o
        function reconcileInventory() {
            const listInventarioText = document.getElementById('list-inventario').value;
            const listSistemaText = document.getElementById('list-sistema').value;
            const resultsContainer = document.getElementById('results-container');

            resultsContainer.classList.add('hidden');
            
            if (!listInventarioText.trim() && !listSistemaText.trim()) {
                console.error('Por favor, cole os dados do Invent치rio e do Sistema.');
                return;
            }

            // 1. Parsear os dados
            const inventarioData = parseData(listInventarioText);
            const sistemaData = parseData(listSistemaText);
            
            // Atualizar contagens
            document.getElementById('count-inventario').textContent = `Total de Itens no Invent치rio: ${inventarioData.length}`;
            document.getElementById('count-sistema').textContent = `Total de Itens no Sistema: ${sistemaData.length}`;
            
            // Limpar dados globais
            reconciledDataByUnit = {};
            inventarioTotalByUnit = {};
            
            // 2. Preparar Dicion치rios Chave (Tombo/Tombamento)
            const inventarioMap = new Map(inventarioData.map(item => [item['Tombo']?.trim(), item]));
            const sistemaMap = new Map(sistemaData.map(item => [item['Tombamento']?.trim(), item]));

            const allTombos = new Set([...inventarioMap.keys(), ...sistemaMap.keys()].filter(key => key && key !== ''));
            
            // 3. Reconcilia칞칚o
            allTombos.forEach(tombo => {
                const itemInv = inventarioMap.get(tombo);
                const itemSis = sistemaMap.get(tombo);

                let action = 'OK';
                let sourceData = {};

                // Determinar a Unidade (Prioridade: Invent치rio > Sistema)
                const unit = (itemInv && itemInv['Unidade']?.trim() || itemSis && itemSis['Unidade']?.trim() || 'Unidade Desconhecida');
                
                // Inicializar a estrutura de dados da Unidade
                if (!reconciledDataByUnit[unit]) {
                    reconciledDataByUnit[unit] = {
                        report: [],
                        countAdicionar: 0,
                        countExcluir: 0,
                        totalInventario: 0
                    };
                }

                if (itemInv) {
                    // Contagem de itens no invent치rio para o resumo da unidade
                    inventarioTotalByUnit[unit] = (inventarioTotalByUnit[unit] || 0) + 1;
                }
                
                if (itemInv && itemSis) {
                    // Item existe em ambos: Checagem de discrep칙ncia
                    const localInv = itemInv['Local']?.trim().toLowerCase() || '';
                    const localSis = itemSis['Localiza칞칚o']?.trim().toLowerCase() || '';
                    const estadoInv = itemInv['Estado de Conserva칞칚o']?.trim().toLowerCase() || '';
                    const estadoSis = itemSis['Estado']?.trim().toLowerCase() || '';
                    
                    sourceData = itemSis; // Usa dados do Sistema como base
                    if (localInv !== localSis || estadoInv !== estadoSis) {
                        action = 'ATEN칂츾O (Local/Estado Diferente)';
                        // ADICIONA A JUSTIFICATIVA COMPLETA (O PORQU칅 DA ATEN칂츾O)
                        const invLocal = itemInv['Local'] || 'N칚o Informado';
                        const invEstado = itemInv['Estado de Conserva칞칚o'] || 'N칚o Informado';
                        
                        sourceData['Observa칞칚o'] = sourceData['Observa칞칚o'] ? 
                            `${sourceData['Observa칞칚o']} | DISCREP츽NCIA: Inv Local="${invLocal}", Inv Estado="${invEstado}"` : 
                            `DISCREP츽NCIA: Inv Local="${invLocal}", Inv Estado="${invEstado}"`;
                        
                        // Garante que a localiza칞칚o do sistema 칠 usada, mas o item 칠 marcado
                        sourceData['Localiza칞칚o'] = itemSis['Localiza칞칚o'] || invLocal; // Prioriza o local do sistema
                    }

                } else if (itemInv && !itemSis) {
                    // Item no Invent치rio, mas FALTA no Sistema -> ADICIONAR
                    action = 'ADICIONAR';
                    reconciledDataByUnit[unit].countAdicionar++;
                    // Cria um item no padr칚o SISTEMA a partir do INVENT츼RIO
                    sourceData = {};
                    for (const keyInv in INVENTARIO_MAP) {
                        const keySis = INVENTARIO_MAP[keyInv];
                        sourceData[keySis] = itemInv[keyInv] || '';
                    }
                    // Preenche dados vazios para as colunas extras do SISTEMA
                    SISTEMA_HEADERS.forEach(h => {
                        if (!sourceData[h]) sourceData[h] = '';
                    });
                    sourceData['Tipo'] = 'NOVO ITEM'; 
                    // Garante que a localiza칞칚o do invent치rio seja usada, 칠 a informa칞칚o crucial
                    sourceData['Localiza칞칚o'] = itemInv['Local'] || ''; 
                    sourceData['Observa칞칚o'] = `A칞칚o: ADICIONAR. Baseado em Invent치rio. Local: ${itemInv['Local'] || ''}`;

                } else if (!itemInv && itemSis) {
                    // Item no Sistema, mas SOBRA no Invent치rio -> EXCLUIR
                    action = 'EXCLUIR';
                    reconciledDataByUnit[unit].countExcluir++;
                    sourceData = itemSis; // Usa dados do Sistema
                    sourceData['Observa칞칚o'] = sourceData['Observa칞칚o'] ? `[EXCLUIR] ${sourceData['Observa칞칚o']}` : '[EXCLUIR] Item n칚o encontrado no Invent치rio Base.';
                }

                // Adicionar o resultado ao relat칩rio final da Unidade
                reconciledDataByUnit[unit].report.push({
                    action: action,
                    unit: unit,
                    ...sourceData
                });
            });

            // Finaliza o total de invent치rio de cada unidade
            Object.keys(inventarioTotalByUnit).forEach(unit => {
                if (reconciledDataByUnit[unit]) {
                    reconciledDataByUnit[unit].totalInventario = inventarioTotalByUnit[unit];
                }
            });

            // 4. Setup Unit Filter and Initial Render
            setupUnitFilter();
            resultsContainer.classList.remove('hidden');
        }

        // Fun칞칚o para configurar o filtro de Unidades (CRAS)
        function setupUnitFilter() {
            const filterContainer = document.getElementById('unit-filter-container');
            filterContainer.innerHTML = '';
            
            const units = Object.keys(reconciledDataByUnit).sort((a, b) => a.localeCompare(b));
            
            if (units.length === 0) {
                filterContainer.innerHTML = '<p class="text-gray-500">Nenhuma Unidade com Tombo encontrado para an치lise.</p>';
                return;
            }

            const selectHtml = `
                <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-3 mb-4 p-3 bg-indigo-50 rounded-xl shadow-md">
                    <label for="unit-selector" class="font-bold text-indigo-800 text-lg whitespace-nowrap">Filtrar por Unidade (CRAS):</label>
                    <select id="unit-selector" onchange="renderReport(this.value)" class="p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 w-full md:w-auto shadow-sm">
                        <option value="ALL">Mostrar Todas as Unidades (${units.length})</option>
                        ${units.map(unit => `<option value="${unit}">${unit}</option>`).join('')}
                    </select>
                </div>
            `;
            filterContainer.innerHTML = selectHtml;
            
            // Renderiza o relat칩rio completo (ALL) inicialmente, como o usu치rio solicitou
            renderReport('ALL');
        }


        // Fun칞칚o para renderizar o relat칩rio para a(s) unidade(s) selecionada(s)
        function renderReport(selectedUnit) {
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';
            
            let reportToRender = [];
            let currentTotalInventario = 0;
            let currentCountAdicionar = 0;
            let currentCountExcluir = 0;
            
            const unitsToProcess = selectedUnit === 'ALL' ? Object.keys(reconciledDataByUnit) : [selectedUnit];

            unitsToProcess.forEach(unit => {
                if (reconciledDataByUnit[unit]) {
                    reportToRender.push(...reconciledDataByUnit[unit].report);
                    currentTotalInventario += reconciledDataByUnit[unit].totalInventario;
                    currentCountAdicionar += reconciledDataByUnit[unit].countAdicionar;
                    currentCountExcluir += reconciledDataByUnit[unit].countExcluir;
                }
            });

            // 4. Ordena칞칚o: A칞칚o (ADICIONAR > EXCLUIR > ATEN칂츾O > OK) > Unidade > Localiza칞칚o
            reportToRender.sort((a, b) => {
                const actionOrder = { 'ADICIONAR': 3, 'EXCLUIR': 2, 'ATEN칂츾O (Local/Estado Diferente)': 1, 'OK': 0 };
                
                const orderDiff = actionOrder[b.action] - actionOrder[a.action];
                if (orderDiff !== 0) return orderDiff;

                // 2췈 crit칠rio: Unidade (para agrupar no modo ALL)
                const unitA = a.unit?.trim().toLowerCase() || '';
                const unitB = b.unit?.trim().toLowerCase() || '';
                const unitDiff = unitA.localeCompare(unitB);
                if (unitDiff !== 0) return unitDiff;

                // 3췈 crit칠rio: Localiza칞칚o
                const localA = a.Localiza칞칚o?.trim().toLowerCase() || '';
                const localB = b.Localiza칞칚o?.trim().toLowerCase() || '';
                return localA.localeCompare(localB);
            });
            
            // Update summary panel
            document.getElementById('total-inventario-final').textContent = currentTotalInventario;
            document.getElementById('total-adicionar').textContent = currentCountAdicionar;
            document.getElementById('total-excluir').textContent = currentCountExcluir;
            
            // 5. Gera칞칚o da Tabela Principal (Rendering rows)
            reportToRender.forEach(item => {
                const row = document.createElement('tr');
                let actionClass = 'bg-gray-50 text-gray-700';
                if (item.action === 'ADICIONAR') {
                    actionClass = 'bg-green-100 text-green-700 font-bold';
                } else if (item.action === 'EXCLUIR') {
                    actionClass = 'bg-red-100 text-red-700 font-bold';
                } else if (item.action.includes('ATEN칂츾O')) {
                    actionClass = 'bg-yellow-100 text-yellow-700 font-semibold';
                }

                row.className = 'hover:bg-gray-50 transition duration-100';
                
                const tombamentoCell = item['Tombamento'] ? `<td class="p-3 font-medium text-gray-900">${item['Tombamento']}</td>` : '<td class="p-3 text-gray-500 italic">SEM TOMBO</td>';
                
                // Destaque para o Localiza칞칚o para ADICIONAR/ATEN칂츾O
                let localizacaoClass = 'text-gray-800';
                if (item.action !== 'OK') {
                    localizacaoClass = 'text-blue-700 font-bold';
                }
                const localizacaoCell = item['Localiza칞칚o'] ? `<td class="p-3 font-medium ${localizacaoClass}">${item['Localiza칞칚o']}</td>` : '<td class="p-3 text-gray-500 italic">SEM LOCAL</td>';
                
                const unidadeCell = `<td class="p-3 text-sm text-gray-700">${item['Unidade'] || item.unit || ''}</td>`;
                const descricaoCell = `<td class="p-3 text-sm text-gray-700">${item['Descri칞칚o'] || ''}</td>`;
                const estadoCell = `<td class="p-3 text-sm text-gray-700">${item['Estado'] || ''}</td>`;
                
                // Coluna Tipo/Observa칞칚o: junta Tipo, Origem Doa칞칚o, Fornecedor e Observa칞칚o (com a justificativa da Discrep칙ncia)
                const obsDetails = [item['Origem da Doa칞칚o'], item['Fornecedor']].filter(d => d).join('; ');
                const tipoObsContent = [item['Tipo'], obsDetails, item['Observa칞칚o']].filter(d => d).join(' | ');

                const tipoObsCell = `<td class="p-3 text-sm text-gray-600 rounded-r-lg">${tipoObsContent}</td>`;

                row.innerHTML = `
                    <td class="p-3 font-semibold whitespace-nowrap ${actionClass} rounded-l-lg">${item.action}</td>
                    ${tombamentoCell}
                    ${localizacaoCell}
                    ${unidadeCell}
                    ${descricaoCell}
                    ${estadoCell}
                    ${tipoObsCell}
                `;
                resultsBody.appendChild(row);
            });

            // 6. Gera칞칚o da Tabela de Itens Faltantes (ADICIONAR)
            const missingItemsBody = document.getElementById('missing-items-body');
            const missingItemsContainer = document.getElementById('missing-items-container');
            missingItemsBody.innerHTML = '';

            const missingItems = reportToRender.filter(item => item.action === 'ADICIONAR');

            if (missingItems.length > 0) {
                missingItemsContainer.classList.remove('hidden');
                missingItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-green-50 transition duration-100 bg-green-50';
                    
                    row.innerHTML = `
                        <td class="p-3 font-medium text-gray-900">${item['Descri칞칚o'] || ''}</td>
                        <td class="p-3 text-sm text-gray-700">${item['Tombamento'] || 'N/A'}</td>
                        <td class="p-3 text-sm text-gray-700 font-semibold text-green-700">${item['Localiza칞칚o'] || 'N칚o Informado'}</td>
                        <td class="p-3 text-sm text-gray-700">${item['Unidade'] || item.unit || 'N/A'}</td>
                    `;
                    missingItemsBody.appendChild(row);
                });
            } else {
                missingItemsContainer.classList.add('hidden');
            }


            // 7. Update summary text
            let totalItemsReported = reportToRender.length;
            let inventarioDelta = currentCountAdicionar - currentCountExcluir;
            
            document.getElementById('summary-text').innerHTML = `
                <p>O relat칩rio para **${selectedUnit === 'ALL' ? 'Todas as Unidades' : selectedUnit}** cont칠m **${totalItemsReported} itens 칰nicos** (OK + ADICIONAR + EXCLUIR). </p>
                <p>O Invent치rio Base da ${selectedUnit === 'ALL' ? '치rea total' : selectedUnit} possui **${currentTotalInventario}** itens. </p>
                <p>A diferen칞a l칤quida de itens (Adicionar - Excluir) 칠 de: <strong class="${inventarioDelta > 0 ? 'text-green-600' : inventarioDelta < 0 ? 'text-red-600' : 'text-gray-600'}">${inventarioDelta}</strong>. 칄 a quantidade que falta ajustar para o estoque bater.</p>
            `;
        }

        // Fun칞칚o para exportar o relat칩rio atual (filtrado ou completo) como CSV
        function exportCSV() {
            const selector = document.getElementById('unit-selector');
            const selectedUnit = selector.value;
            
            let reportToRender = [];
            const unitsToProcess = selectedUnit === 'ALL' ? Object.keys(reconciledDataByUnit) : [selectedUnit];

            unitsToProcess.forEach(unit => {
                if (reconciledDataByUnit[unit]) {
                    reconciledDataByUnit[unit].report.forEach(item => {
                         reportToRender.push(item);
                    });
                }
            });
            
            // Ordena칞칚o (garantir que a exporta칞칚o siga a ordem da tela)
            reportToRender.sort((a, b) => {
                const actionOrder = { 'ADICIONAR': 3, 'EXCLUIR': 2, 'ATEN칂츾O (Local/Estado Diferente)': 1, 'OK': 0 };
                
                const orderDiff = actionOrder[b.action] - actionOrder[a.action];
                if (orderDiff !== 0) return orderDiff;

                const unitA = a.unit?.trim().toLowerCase() || '';
                const unitB = b.unit?.trim().toLowerCase() || '';
                const unitDiff = unitA.localeCompare(unitB);
                if (unitDiff !== 0) return unitDiff;

                const localA = a.Localiza칞칚o?.trim().toLowerCase() || '';
                const localB = b.Localiza칞칚o?.trim().toLowerCase() || '';
                return localA.localeCompare(localB);
            });


            // Define CSV headers (A칞칚o + SISTEMA_HEADERS)
            const headers = ['A칞칚o Sugerida', ...SISTEMA_HEADERS];
            
            let csvContent = headers.join(';') + '\n'; // Usa ponto e v칤rgula como separador
            
            reportToRender.forEach(item => {
                const values = [];
                values.push(item.action); // A칞칚o Sugerida
                SISTEMA_HEADERS.forEach(header => {
                    let value = (item[header] || '').replace(/;/g, ',').replace(/\n/g, ' ').trim(); // Sanitiza valor
                    values.push(value);
                });
                csvContent += values.join(';') + '\n';
            });
            
            const unitName = selectedUnit === 'ALL' ? 'Geral' : selectedUnit.replace(/[^a-zA-Z0-9]/g, '_');
            const filename = `Reconciliacao_Inventario_${unitName}.csv`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                console.error("Download is not supported in this browser.");
            }
        }

        // Adiciona listener para atualizar a contagem enquanto digita/cola
        function setupCountListeners() {
            document.getElementById('list-inventario').addEventListener('input', () => {
                 const data = parseData(document.getElementById('list-inventario').value);
                 document.getElementById('count-inventario').textContent = `Total de Itens no Invent치rio: ${data.length}`;
            });
            document.getElementById('list-sistema').addEventListener('input', () => {
                 const data = parseData(document.getElementById('list-sistema').value);
                 document.getElementById('count-sistema').textContent = `Total de Itens no Sistema: ${data.length}`;
            });
        }
        window.onload = setupCountListeners;

    </script>
</body>
</html>
