<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Quantidade - Sistema com Vincula√ß√£o Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        textarea {
            height: 250px; 
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .progress-bar {
            position: relative;
            height: 8px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 9999px;
        }

        .modal {
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #059669;
        }

        .search-box {
            transition: all 0.3s ease;
        }

        .search-box:focus-within {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            background: #1f2937;
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulse-warning {
            animation: pulse-warning 2s ease-in-out infinite;
        }

        .divergence-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            animation: pulse-warning 2s ease-in-out infinite;
        }

        @media (max-width: 640px) {
            textarea {
                height: 180px;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .highlight {
            background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        .item-divergent {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }

        .item-match {
            border-left: 4px solid #22c55e;
        }

        .item-only-inv {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
        }

        .item-only-sys {
            border-left: 4px solid #f97316;
            background: linear-gradient(90deg, rgba(249, 115, 22, 0.1) 0%, transparent 100%);
        }

        /* NOVOS ESTILOS PARA VINCULA√á√ÉO */
        .linking-mode {
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.1) 0%, transparent 100%);
            border: 2px dashed #9333ea !important;
        }

        .item-selected {
            background: #ddd6fe !important;
            border: 3px solid #9333ea !important;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
            transform: scale(1.02);
        }

        .item-linked {
            border-left: 4px solid #9333ea;
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.2) 0%, transparent 100%);
        }

        .link-badge {
            background: linear-gradient(135deg, #9333ea 0%, #c084fc 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            box-shadow: 0 2px 4px rgba(147, 51, 234, 0.3);
        }

        @keyframes link-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .link-active {
            animation: link-pulse 1s ease-in-out infinite;
        }

        /* Tabela de relat√≥rio */
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th, .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8rem; /* Fonte menor para caber mais colunas */
        }

        .report-table th {
            background: #f3f4f6;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.7rem; /* Fonte menor para caber mais colunas */
            color: #374151;
            position: sticky; /* Fixa o cabe√ßalho ao rolar */
            top: 0;
            z-index: 10;
        }

        .report-table tr:hover {
            background: #f9fafb;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981',
                        'primary-dark': '#059669',
                        'inventario': '#3b82f6',
                        'sistema': '#f97316',
                        'export': '#d946ef',
                        'success': '#22c55e',
                        'warning': '#f59e0b',
                        'danger': '#ef4444',
                        'link': '#9333ea',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-white text-lg font-semibold">Processando dados...</p>
            <p class="text-gray-300 text-sm mt-2">Isso pode levar alguns segundos</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-2xl fade-in">
        <!-- Header -->
        <div class="mb-8 border-b-4 border-primary pb-4">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2 flex items-center gap-3">
                <span class="text-5xl">üìä</span>
                Analisador com Vincula√ß√£o Inteligente
            </h1>
            <p class="text-gray-600 text-lg">
                Sistema avan√ßado que permite vincular itens com nomes diferentes
            </p>
            <div class="mt-3 flex flex-wrap gap-2">
                <span class="status-badge bg-green-100 text-green-700">‚úì Compara√ß√£o Autom√°tica</span>
                <span class="status-badge bg-blue-100 text-blue-700">‚úì Filtros Avan√ßados</span>
                <span class="status-badge bg-purple-100 text-purple-700">‚úì Vincula√ß√£o Inteligente</span>
                <span class="status-badge bg-red-100 text-red-700">‚úì Detec√ß√£o de Diverg√™ncias</span>
            </div>
        </div>

        <!-- Gerenciador de Vincula√ß√µes -->
        <div class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl border-2 border-purple-300">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold text-purple-800 flex items-center gap-2">
                        <span class="text-2xl">üîó</span>
                        <span>Gerenciador de Vincula√ß√µes</span>
                    </h3>
                    <p class="text-sm text-purple-600 mt-1">Vincule itens com nomes diferentes que s√£o a mesma coisa</p>
                </div>
                <button onclick="toggleLinkManager()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition">
                    Ver Vincula√ß√µes (<span id="link-count">0</span>)
                </button>
            </div>
            <div class="flex gap-3">
                <button onclick="clearAllLinks()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition text-sm">
                    üóëÔ∏è Limpar Todas
                </button>
                <button onclick="exportLinks()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition text-sm">
                    üì• Exportar
                </button>
                <button onclick="importLinks()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition text-sm">
                    üì§ Importar
                </button>
            </div>
        </div>

        <!-- Contadores -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-blue-600 mb-1">INVENT√ÅRIO</p>
                        <p id="count-inventario" class="text-3xl font-bold text-blue-700">0</p>
                        <p class="text-xs text-blue-600 mt-1">linhas carregadas</p>
                    </div>
                    <div class="text-5xl opacity-20">üìã</div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-xl border-2 border-orange-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-orange-600 mb-1">SISTEMA</p>
                        <p id="count-sistema" class="text-3xl font-bold text-orange-700">0</p>
                        <p class="text-xs text-orange-600 mt-1">linhas carregadas</p>
                    </div>
                    <div class="text-5xl opacity-20">‚öôÔ∏è</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Invent√°rio -->
            <div class="group">
                <label for="list-inventario" class="block text-lg font-bold text-inventario mb-3 flex items-center gap-2">
                    <span class="text-2xl">üìã</span>
                    <span>Dados do Invent√°rio</span>
                    <span class="tooltip text-gray-400 cursor-help text-sm" data-tooltip="Cole dados com: Unidade, Local, Item, Tombo e outros campos completos.">‚ÑπÔ∏è</span>
                </label>
                <div class="relative">
                    <textarea 
                        id="list-inventario" 
                        class="w-full p-4 border-2 border-inventario rounded-xl focus:ring-2 focus:ring-inventario focus:border-inventario transition duration-150 custom-scrollbar" 
                        placeholder="Cole os dados do Invent√°rio incluindo cabe√ßalho. (Campos importantes: Unidade, Local, Item, Tombo)"
                        aria-label="Dados do Invent√°rio"
                    ></textarea>
                    <div class="absolute top-2 right-2">
                        <button onclick="clearTextarea('list-inventario')" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-lg text-xs font-semibold transition">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sistema -->
            <div class="group">
                <label for="list-sistema" class="block text-lg font-bold text-sistema mb-3 flex items-center gap-2">
                    <span class="text-2xl">‚öôÔ∏è</span>
                    <span>Dados do Sistema</span>
                    <span class="tooltip text-gray-400 cursor-help text-sm" data-tooltip="Cole dados com: Unidade, Localiza√ß√£o, Descri√ß√£o, Tombamento e outros campos completos.">‚ÑπÔ∏è</span>
                </label>
                <div class="relative">
                    <textarea 
                        id="list-sistema" 
                        class="w-full p-4 border-2 border-sistema rounded-xl focus:ring-2 focus:ring-sistema focus:border-sistema transition duration-150 custom-scrollbar" 
                        placeholder="Cole os dados do Sistema incluindo cabe√ßalho. (Campos importantes: Unidade, Localiza√ß√£o, Descri√ß√£o, Tombamento)"
                        aria-label="Dados do Sistema"
                    ></textarea>
                    <div class="absolute top-2 right-2">
                        <button onclick="clearTextarea('list-sistema')" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-lg text-xs font-semibold transition">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√£o de A√ß√£o -->
        <div class="mb-8">
             <button 
                onclick="runMasterCount()" 
                class="w-full px-8 py-4 bg-gradient-to-r from-primary to-primary-dark text-white font-bold text-xl rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center gap-3"
             >
                <span class="text-2xl">üöÄ</span>
                <span>Analisar Contagem de Itens por Local</span>
             </button>
        </div>
        
        <!-- Container de Resultados -->
        <div id="results-container" class="mt-12 hidden fade-in">
            <div class="mb-6 p-6 bg-gradient-to-r from-primary to-primary-dark rounded-xl text-white">
                <h2 id="report-title" class="text-3xl font-bold mb-2 flex items-center gap-3">
                    <span class="text-4xl">üìà</span>
                    <span>Relat√≥rio de Auditoria de Quantidade</span>
                </h2>
                <p class="text-green-100">An√°lise completa com vincula√ß√µes aplicadas</p>
            </div>

            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div id="filter-container" class="hidden">
                    <label for="unit-filter" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        üè¢ Filtrar por Unidade (Divergente)
                    </label>
                    <select 
                        id="unit-filter" 
                        class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition duration-150 bg-white font-semibold" 
                        onchange="filterResultCards(this.value)"
                    >
                        <option value="all_divergent">üåê Todas as Unidades Divergentes</option>
                    </select>
                </div>

                <div id="search-container" class="hidden">
                    <label for="local-search" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        üîç Buscar Local
                    </label>
                    <div class="search-box relative">
                        <input 
                            type="text" 
                            id="local-search" 
                            class="w-full p-3 pl-10 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition duration-150" 
                            placeholder="Digite o nome do local..."
                            oninput="searchLocal(this.value)"
                        />
                        <span class="absolute left-3 top-3.5 text-gray-400 text-xl">üîé</span>
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button 
                    onclick="generateFinalReport()" 
                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white font-bold rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] flex items-center gap-2"
                >
                    <span class="text-xl">üìã</span>
                    <span>Relat√≥rio Final por Unidade</span>
                </button>
                <button 
                    onclick="exportCSV()" 
                    class="px-6 py-3 bg-gradient-to-r from-export to-fuchsia-600 text-white font-bold rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] flex items-center gap-2"
                >
                    <span class="text-xl">üì•</span>
                    <span>Exportar CSV de Auditoria</span>
                </button>
            </div>
            
            <!-- Resumo -->
            <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl">üìã</span>
                        <span class="status-badge bg-blue-200 text-blue-700">Fonte</span>
                    </div>
                    <div class="text-4xl font-black text-blue-600 mb-2" id="summary-inv">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Total Itens (Invent√°rio)</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-blue-500" id="progress-inv" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="p-6 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl">‚öôÔ∏è</span>
                        <span class="status-badge bg-orange-200 text-orange-700">Atual</span>
                    </div>
                    <div class="text-4xl font-black text-orange-600 mb-2" id="summary-sis">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Total Itens (Sistema)</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-orange-500" id="progress-sis" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="p-6 bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl" id="diff-icon">üìä</span>
                        <span class="status-badge bg-gray-200 text-gray-700" id="diff-status">An√°lise</span>
                    </div>
                    <div class="text-4xl font-black text-gray-700 mb-2" id="summary-diff">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Diferen√ßa L√≠quida</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-gray-500" id="progress-diff" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Cards de Discrep√¢ncia (Modo Lista Agrupada - REQ 5) -->
            <div class="mb-4">
                <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <span class="text-3xl">‚ö†Ô∏è</span>
                    <span>Discrep√¢ncias Encontradas</span>
                    <span id="discrepancy-count" class="ml-auto bg-red-100 text-red-700 px-4 py-1 rounded-full font-bold text-sm">0</span>
                </h3>
                <p class="text-gray-600 mb-4">Clique nos cards para visualizar e vincular itens</p>
            </div>
            
            <p id="no-discrepancy-message" class="text-center p-8 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-200 hidden">
                <span class="text-6xl mb-4 block">üéâ</span>
                <span class="text-2xl font-bold text-green-700 block mb-2">Perfeito!</span>
                <span class="text-gray-600">Nenhuma discrep√¢ncia encontrada</span>
            </p>
            
            <div id="discrepancy-cards-container" class="grid grid-cols-1 gap-6">
                <!-- Conte√∫do agora renderizado como lista agrupada por unidade -->
            </div>
        </div>
    </div>

    <!-- MODAL DE VINCULA√á√ÉO -->
    <div id="item-details-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeModal()">
        <div class="modal-content bg-white w-full max-w-6xl rounded-2xl shadow-2xl transform scale-95" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="flex justify-between items-center border-b-2 border-gray-200 p-6 bg-gradient-to-r from-primary to-primary-dark text-white rounded-t-2xl">
                <div>
                    <h2 id="modal-title" class="text-3xl font-bold">Detalhes dos Itens</h2>
                    <p id="modal-subtitle" class="text-green-100 mt-1"></p>
                </div>
                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            
            <!-- Modo de Vincula√ß√£o -->
            <div id="linking-info" class="px-6 pt-4 pb-2 bg-purple-50 border-b-2 border-purple-200 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl link-active">üîó</span>
                        <div>
                            <p class="font-bold text-purple-800">Modo de Vincula√ß√£o Ativo</p>
                            <!-- REQ 3: Mensagem din√¢mica -->
                            <p class="text-sm text-purple-600">Selecione 1 item do Invent√°rio e 1 do Sistema para vincular</p>
                        </div>
                    </div>
                    <button onclick="cancelLinking()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition">
                        ‚úñ Cancelar
                    </button>
                </div>
            </div>

            <!-- Controles -->
            <div class="px-6 pt-4 pb-2">
                <div class="flex gap-3 mb-3">
                    <button onclick="toggleLinkingMode()" id="link-mode-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <span>üîó</span>
                        <span>Ativar Modo Vincula√ß√£o</span>
                    </button>
                    <button onclick="reanalyzeWithLinks()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <span>üîÑ</span>
                        <span>Reanalisar com V√≠nculos</span>
                    </button>
                </div>
            </div>

            <!-- Legenda -->
            <div class="px-6 pb-2">
                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <span>üîç</span>
                        <span>LEGENDA (Itens Restantes):</span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                            <span class="font-semibold">Qtd Diferente</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                            <span class="font-semibold">S√≥ Invent√°rio</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
                            <span class="font-semibold">S√≥ Sistema</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-purple-500 rounded-full"></span>
                            <span class="font-semibold">Vinculado</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span class="font-semibold">Correto</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Busca -->
            <div class="px-6 pb-4">
                <div class="search-box relative">
                    <input 
                        type="text" 
                        id="modal-search" 
                        class="w-full p-3 pl-10 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition" 
                        placeholder="üîé Buscar item..."
                        oninput="searchModalItems(this.value)"
                    />
                    <span class="absolute left-3 top-3.5 text-gray-400 text-xl">üîç</span>
                </div>
            </div>
            
            <!-- Listas -->
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[50vh] overflow-y-auto custom-scrollbar">
                <div class="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                    <h3 id="modal-inv-title" class="text-xl font-bold text-inventario mb-3 flex items-center gap-2">
                        <span class="text-2xl">üìã</span>
                        <span>Invent√°rio (0)</span>
                    </h3>
                    <ul id="modal-inv-list" class="space-y-2 text-sm text-gray-700">
                    </ul>
                </div>
                
                <div class="bg-orange-50 rounded-xl p-5 border-2 border-orange-200">
                    <h3 id="modal-sis-title" class="text-xl font-bold text-sistema mb-3 flex items-center gap-2">
                        <span class="text-2xl">‚öôÔ∏è</span>
                        <span>Sistema (0)</span>
                    </h3>
                    <ul id="modal-sis-list" class="space-y-2 text-sm text-gray-700">
                    </ul>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span class="font-semibold">Vincula√ß√µes ativas:</span> <span id="modal-link-count">0</span>
                </div>
                <button 
                    onclick="closeModal()" 
                    class="px-8 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-xl hover:from-gray-700 hover:to-gray-800 transition duration-200 shadow-lg"
                >
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL GERENCIADOR DE LINKS -->
    <div id="link-manager-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeLinkManager()">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl transform scale-95 max-h-[80vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b-2 border-purple-200 p-6 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-t-2xl">
                <div>
                    <h2 class="text-3xl font-bold">üîó Vincula√ß√µes Salvas</h2>
                    <p class="text-purple-100 mt-1">Gerencie todos os v√≠nculos entre itens</p>
                </div>
                <button onclick="closeLinkManager()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar" style="max-height: calc(80vh - 180px);">
                <div id="link-list-container">
                    <!-- Lista ser√° preenchida dinamicamente -->
                </div>
            </div>
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl">
                <button onclick="closeLinkManager()" class="px-8 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-xl transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL RELAT√ìRIO FINAL -->
    <div id="final-report-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeFinalReport()">
        <div class="modal-content bg-white w-full max-w-6xl rounded-2xl shadow-2xl transform scale-95 max-h-[90vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b-2 border-purple-200 p-6 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-t-2xl">
                <div>
                    <h2 class="text-3xl font-bold">üìã Relat√≥rio Final por Unidade</h2>
                    <p class="text-purple-100 mt-1">Itens faltantes ap√≥s aplicar todas as vincula√ß√µes</p>
                </div>
                <button onclick="closeFinalReport()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            <div class="p-6">
                <button onclick="exportFinalReport()" class="mb-4 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                    <span>üì•</span>
                    <span>Exportar Relat√≥rio Final (CSV)</span>
                </button>
                <div id="final-report-content" class="overflow-y-auto custom-scrollbar" style="max-height: calc(90vh - 250px);">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
            </div>
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl">
                <button onclick="closeFinalReport()" class="px-8 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-xl transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        // === VARI√ÅVEIS GLOBAIS ===
        let auditData = [];
        let globalInventarioData = []; // Armazena a linha completa do Invent√°rio
        let globalSistemaData = [];    // Armazena a linha completa do Sistema
        let uniqueUnits = new Set();
        let discrepancyDetails = new Map(); 
        let currentSearchTerm = '';
        
        // NOVO: Sistema de Vincula√ß√£o
        let itemLinks = new Map(); 
        let linkingMode = false;
        let selectedInvItem = null;
        let selectedSysItem = null;
        let currentCompositeKey = '';
        
        // Cabe√ßalhos de exporta√ß√£o final (definidos pelo usu√°rio)
        const FINAL_HEADERS = ['Tipo', 'Tombamento', 'Descri√ß√£o', 'Unidade', 'Quantidade', 'Localiza√ß√£o', 'Estado', 'Origem da Doa√ß√£o', 'Observa√ß√£o', 'Fornecedor'];

        // Colunas chave para busca nos dados
        const COLUMNS = {
            INV: {
                UNIT: 'unidade',
                LOCAL: 'local',
                ITEM: 'item',
                ID: 'tombo' 
            },
            SIS: {
                UNIT: 'unidade',
                LOCAL: 'localizacao',
                ITEM: 'descricao',
                ID: 'tombamento'
            }
        };

        // Carrega links do localStorage
        function loadLinksFromStorage() {
            const stored = localStorage.getItem('itemLinks');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    itemLinks = new Map(Object.entries(parsed).map(([key, val]) => [key, new Map(Object.entries(val))]));
                    updateLinkCount();
                } catch (e) {
                    console.error('Erro ao carregar links:', e);
                }
            }
        }

        // Salva links no localStorage
        function saveLinksToStorage() {
            const obj = {};
            itemLinks.forEach((value, key) => {
                obj[key] = Object.fromEntries(value);
            });
            localStorage.setItem('itemLinks', JSON.stringify(obj));
            updateLinkCount();
        }

        // Atualiza contador de links
        function updateLinkCount() {
            let total = 0;
            itemLinks.forEach(map => total += map.size);
            document.getElementById('link-count').textContent = total;
            document.getElementById('modal-link-count').textContent = total;
        }

        // === FUN√á√ïES B√ÅSICAS ===
        
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            return str
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[-/.,;:()]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            
            const separators = {
                '\t': (firstLine.match(/\t/g) || []).length,
                ';': (firstLine.match(/;/g) || []).length,
                ',': (firstLine.match(/,/g) || []).length,
                '|': (firstLine.match(/\|/g) || []).length
            };
            
            const separator = Object.keys(separators).reduce((a, b) => 
                separators[a] > separators[b] ? a : b
            );

            if (separators[separator] === 0) return [];

            const rawHeaders = lines[0].split(separator).map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length === rawHeaders.length && values.some(v => v !== '')) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        item[header] = values[index];
                    });
                    data.push(item);
                }
            }
            
            return data;
        }

        function clearTextarea(id) {
            document.getElementById(id).value = '';
            updateDataCount();
        }

        function showLoading(show = true) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                setTimeout(() => overlay.classList.add('hidden'), 500);
            }
        }

        function updateDataCount() {
            const invTextarea = document.getElementById('list-inventario');
            const sisTextarea = document.getElementById('list-sistema');
            
            const invLines = invTextarea.value.trim().split('\n').filter(Boolean).length;
            const sisLines = sisTextarea.value.trim().split('\n').filter(Boolean).length;
            
            const invCount = Math.max(0, invLines - 1);
            const sisCount = Math.max(0, sisLines - 1);
            
            document.getElementById('count-inventario').textContent = invCount;
            document.getElementById('count-sistema').textContent = sisCount;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Helper global para agrupar itens
        function groupItems(items) {
            const grouped = new Map();
            items.forEach(item => {
                // item √© um objeto de linha completa, usamos o nome do item (ID/Tombo) como chave
                const itemId = item.itemId; 
                grouped.set(itemId, (grouped.get(itemId) || 0) + 1);
            });
            return grouped;
        }

        // === AN√ÅLISE PRINCIPAL ===
        
        async function runMasterCount() {
            showLoading(true);
            document.getElementById('results-container').classList.add('hidden');
            await new Promise(resolve => setTimeout(resolve), 100);
            
            try {
                globalInventarioData = parseData(document.getElementById('list-inventario').value);
                globalSistemaData = parseData(document.getElementById('list-sistema').value);
                
                if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                    showCustomAlert("‚ö†Ô∏è Por favor, cole os dados antes de analisar.");
                    showLoading(false);
                    return;
                }

                await processAuditData();
                
                document.getElementById('results-container').classList.remove('hidden');
                document.getElementById('filter-container').classList.remove('hidden');
                document.getElementById('search-container').classList.remove('hidden');
                
                populateUnitFilter(); 
                document.getElementById('unit-filter').value = 'all_divergent';
                document.getElementById('local-search').value = '';
                
                filterResultCards('all_divergent');
                showLoading(false);
                
                setTimeout(() => {
                    document.getElementById('results-container').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
                
            } catch (error) { 
                console.error('Erro:', error);
                showCustomAlert(`‚ùå Erro ao processar: ${error.message}`);
                showLoading(false);
            }
        }

        function findColumn(headers, key) {
             const normalizedKey = normalizeString(key);
             return headers.find(h => normalizeString(h).includes(normalizedKey));
        }

        // Processa dados e adiciona metadados (IDs)
        async function processAuditData() {
            const inventarioMap = new Map();
            const sistemaMap = new Map();
            const allCompositeKeys = new Set();
            auditData = [];
            discrepancyDetails.clear();
            
            const invHeader = globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : [];
            const sisHeader = globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : [];
            
            const invUnitCol = findColumn(invHeader, COLUMNS.INV.UNIT);
            const invLocalCol = findColumn(invHeader, COLUMNS.INV.LOCAL);
            const invItemCol = findColumn(invHeader, COLUMNS.INV.ITEM); // Descri√ß√£o do item (Item)
            const invIdCol = findColumn(invHeader, COLUMNS.INV.ID);     // ID do Tombamento (Tombo)
            
            const sisUnitCol = findColumn(sisHeader, COLUMNS.SIS.UNIT);
            const sisLocalCol = findColumn(sisHeader, COLUMNS.SIS.LOCAL);
            const sisItemCol = findColumn(sisHeader, COLUMNS.SIS.ITEM); // Descri√ß√£o do item (Descri√ß√£o)
            const sisIdCol = findColumn(sisHeader, COLUMNS.SIS.ID);     // ID do Tombamento (Tombamento)
            
            // Valida√ß√£o de Colunas (usando ID como obrigat√≥rio para Tombo)
            if (globalInventarioData.length > 0 && !invLocalCol) throw new Error("Coluna 'Local' n√£o encontrada no Invent√°rio. Verifique o cabe√ßalho.");
            if (globalInventarioData.length > 0 && !invIdCol) throw new Error("Coluna 'Tombo' (Invent√°rio) n√£o encontrada. Verifique o cabe√ßalho.");
            
            if (globalSistemaData.length > 0 && !sisLocalCol) throw new Error("Coluna 'Localiza√ß√£o' ou 'Local' n√£o encontrada no Sistema. Verifique o cabe√ßalho.");
            if (globalSistemaData.length > 0 && !sisIdCol) throw new Error("Coluna 'Tombamento' (Sistema) n√£o encontrada. Verifique o cabe√ßalho.");


            // Processa Invent√°rio: usa o Tombo como identificador de item (item ID)
            globalInventarioData.forEach(item => {
                const unidade = invUnitCol ? normalizeString(item[invUnitCol] || 'sem unidade') : 'sem unidade';
                const local = normalizeString(item[invLocalCol] || 'sem local');
                const itemId = invIdCol ? (item[invIdCol] || `Item sem Tombo Inv-${Math.random()}`).trim() : `Item sem Tombo Inv-${Math.random()}`;
                const compositeKey = `${unidade}|${local}`;
                
                allCompositeKeys.add(compositeKey);
                
                if (!inventarioMap.has(compositeKey)) {
                    inventarioMap.set(compositeKey, { 
                        count: 0, 
                        items: [], // Array de objetos { itemId, data: {objeto linha completa} }
                        originalUnit: item[invUnitCol] || 'Sem Unidade', 
                        originalLocal: item[invLocalCol] || 'Sem Local' 
                    });
                }
                const data = inventarioMap.get(compositeKey);
                data.count++;
                
                // Salva a linha completa
                data.items.push({ 
                    itemId: itemId, 
                    data: item, 
                    // Adiciona a descri√ß√£o para o modal
                    description: invItemCol ? (item[invItemCol] || `Item sem Descri√ß√£o - ${itemId}`).trim() : `Item sem Descri√ß√£o - ${itemId}`
                });
            });
            
            // Processa Sistema: usa o Tombamento como identificador de item (item ID)
            globalSistemaData.forEach(item => {
                const unidade = sisUnitCol ? normalizeString(item[sisUnitCol] || 'sem unidade') : 'sem unidade';
                const local = sisLocalCol ? normalizeString(item[sisLocalCol] || 'sem local') : 'sem local';
                const itemId = sisIdCol ? (item[sisIdCol] || `Item sem Tombo Sis-${Math.random()}`).trim() : `Item sem Tombo Sis-${Math.random()}`;
                const compositeKey = `${unidade}|${local}`;

                allCompositeKeys.add(compositeKey);

                if (!sistemaMap.has(compositeKey)) {
                    sistemaMap.set(compositeKey, { 
                        count: 0, 
                        items: [], // Array de objetos { itemId, data: {objeto linha completa} }
                        originalUnit: item[sisUnitCol] || 'Sem Unidade', 
                        originalLocal: item[sisLocalCol] || 'Sem Local' 
                    });
                }
                const data = sistemaMap.get(compositeKey);
                
                data.count++;
                
                // Salva a linha completa
                data.items.push({ 
                    itemId: itemId, 
                    data: item,
                    // Adiciona a descri√ß√£o para o modal
                    description: sisItemCol ? (item[sisItemCol] || `Item sem Descri√ß√£o - ${itemId}`).trim() : `Item sem Descri√ß√£o - ${itemId}`
                });
            });

            const sortedKeys = [...allCompositeKeys].sort();

            for (const compositeKey of sortedKeys) {
                if (compositeKey === "sem unidade|sem local") continue;
                
                const [unidade, local] = compositeKey.split('|');
                
                const invData = inventarioMap.get(compositeKey) || { count: 0, items: [], originalUnit: '', originalLocal: '' };
                const sisData = sistemaMap.get(compositeKey) || { count: 0, items: [], originalUnit: '', originalLocal: '' };
                
                const qtdInv = invData.count;
                const qtdSis = sisData.count;
                const diff = qtdInv - qtdSis;

                if (qtdInv > 0 || qtdSis > 0) {
                    const auditRow = {
                        key: compositeKey,
                        unidade: unidade,
                        local: local,
                        originalUnit: invData.originalUnit || sisData.originalUnit,
                        originalLocal: invData.originalLocal || sisData.originalLocal,
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    };
                    auditData.push(auditRow);
                    
                    let hasQuantityDivergence = diff !== 0;
                    let hasTombamentoDivergence = false;
                    
                    const invIds = new Set(invData.items.map(i => normalizeString(i.itemId)));
                    const sisIds = new Set(sisData.items.map(i => normalizeString(i.itemId)));

                    // Checa Diverg√™ncia de Tombamento
                    if (qtdInv > 0 || qtdSis > 0) {
                        // Se houver algum ID em Inv que n√£o est√° em Sis OU vice-versa
                        let invOnly = [...invIds].some(id => !sisIds.has(id));
                        let sisOnly = [...sisIds].some(id => !invIds.has(id));
                        
                        // Ou se as contagens s√£o iguais, mas os conjuntos de IDs s√£o diferentes
                        if (qtdInv === qtdSis && [...invIds].length !== [...sisIds].length) {
                             hasTombamentoDivergence = true;
                        } else if (invOnly || sisOnly) {
                             hasTombamentoDivergence = true;
                        }
                    }
                    
                    // Adiciona se houver qualquer diverg√™ncia
                    if (hasQuantityDivergence || hasTombamentoDivergence) {
                        discrepancyDetails.set(compositeKey, {
                            unidade: auditRow.originalUnit,
                            local: auditRow.originalLocal,
                            invItems: invData.items.sort((a, b) => a.itemId.localeCompare(b.itemId)), // Objetos completos
                            sisItems: sisData.items.sort((a, b) => a.itemId.localeCompare(b.itemId)),  // Objetos completos
                            hasQuantityDivergence: hasQuantityDivergence,
                            hasTombamentoDivergence: hasTombamentoDivergence,
                            qtdInv: qtdInv,
                            qtdSis: qtdSis,
                            diff: diff
                        });
                    }
                }
            }
        }

        // REQ 1: Popula filtro com APENAS unidades que cont√™m diverg√™ncia
        function populateUnitFilter() {
            uniqueUnits = new Set();
            const filterSelect = document.getElementById('unit-filter');
            
            discrepancyDetails.forEach(details => {
                uniqueUnits.add(details.unidade);
            });

            uniqueUnits.delete('');
            uniqueUnits.delete('Sem Unidade');

            filterSelect.innerHTML = ''; 

            const allOption = document.createElement('option');
            allOption.value = "all_divergent";
            allOption.textContent = "üåê Todas as Unidades Divergentes";
            filterSelect.appendChild(allOption);
            
            const sortedUnits = [...uniqueUnits].sort();
            sortedUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = `üè¢ ${unit.toUpperCase()}`;
                filterSelect.appendChild(option);
            });
        }

        // REQ 5: Renderiza cards em modo lista agrupada por Unidade
        function filterResultCards(selectedUnit) {
            const cardsContainer = document.getElementById('discrepancy-cards-container');
            const noDiscrepancyMsg = document.getElementById('no-discrepancy-message');
            cardsContainer.innerHTML = '';
            
            let totalInv = 0;
            let totalSis = 0;

            const filteredAuditData = (selectedUnit === 'all_divergent') 
                ? auditData 
                : auditData.filter(item => normalizeString(item.originalUnit) === normalizeString(selectedUnit));

            for (const item of filteredAuditData) {
                totalInv += item.qtdInv;
                totalSis += item.qtdSis;
            }
            
            const searchFilteredEntries = [...discrepancyDetails.entries()].filter(([key, details]) => {
                const matchesUnit = selectedUnit === 'all_divergent' || normalizeString(details.unidade) === normalizeString(selectedUnit);
                
                const matchesSearch = currentSearchTerm 
                    ? normalizeString(details.local).includes(normalizeString(currentSearchTerm)) ||
                      normalizeString(details.unidade).includes(normalizeString(currentSearchTerm))
                    : true;
                    
                return matchesUnit && matchesSearch;
            });

            const discrepancyCount = searchFilteredEntries.length;
            
            const groupedDetails = new Map();
            searchFilteredEntries.forEach(([key, details]) => {
                const unit = details.unidade;
                if (!groupedDetails.has(unit)) {
                    groupedDetails.set(unit, []);
                }
                groupedDetails.get(unit).push({key, details});
            });

            if (discrepancyCount > 0) {
                const sortedUnits = [...groupedDetails.keys()].sort();
                
                sortedUnits.forEach(unit => {
                    const unitSection = document.createElement('div');
                    unitSection.className = 'mb-8 border-b border-gray-200 pb-4 fade-in';
                    unitSection.innerHTML = `
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-3xl">üè¢</span>
                            <span>${unit}</span>
                            <span class="ml-auto bg-primary text-white px-3 py-1 rounded-full text-sm">${groupedDetails.get(unit).length} locais com diverg√™ncia</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Cards here -->
                        </div>
                    `;
                    const cardsSubContainer = unitSection.querySelector('.grid');
                    
                    groupedDetails.get(unit).forEach(entry => {
                        const card = createDiscrepancyCard(entry.details, entry.key);
                        cardsSubContainer.appendChild(card);
                    });
                    
                    cardsContainer.appendChild(unitSection);
                });

                noDiscrepancyMsg.classList.add('hidden');
            } else {
                noDiscrepancyMsg.classList.remove('hidden');
            }

            updateSummaryUI(totalInv, totalSis, totalInv - totalSis);
            document.getElementById('discrepancy-count').textContent = discrepancyCount;
            
            const unitText = selectedUnit === 'all_divergent' ? 'Todas as Unidades Divergentes' : selectedUnit.toUpperCase();
            document.getElementById('report-title').innerHTML = `
                <span class="text-4xl">üìà</span>
                <span>Relat√≥rio: ${unitText}</span>
            `;
        }

        // REQ 3, 4: Cria card com aviso de diverg√™ncia combinada
        function createDiscrepancyCard(details, compositeKey) {
            const item = details;
            
            let cardClass = 'bg-white border-gray-300';
            let diffClass = 'text-gray-700';
            let borderColor = 'border-gray-300';
            let icon = 'üìä';
            let divergenceWarning = '';

            if (item.hasQuantityDivergence && item.hasTombamentoDivergence) {
                // Diverg√™ncia de Quantidade e Tombo
                cardClass = 'bg-gradient-to-br from-red-100 to-red-200 border-red-400';
                diffClass = 'text-red-600';
                borderColor = 'border-red-500';
                icon = 'üî•';
                divergenceWarning = '<span class="status-badge bg-red-200 text-red-800 pulse-warning">‚ö†Ô∏è Qtd. e Tombo Divergentes</span>';
            } else if (item.hasQuantityDivergence) { 
                // Diverg√™ncia de Quantidade
                cardClass = item.diff > 0 ? 'bg-gradient-to-br from-red-50 to-red-100 border-red-300' : 'bg-gradient-to-br from-orange-50 to-orange-100 border-orange-300';
                diffClass = item.diff > 0 ? 'text-red-600' : 'text-orange-600';
                borderColor = item.diff > 0 ? 'border-red-400' : 'border-orange-400';
                icon = item.diff > 0 ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'; 
                divergenceWarning = '<span class="status-badge bg-red-200 text-red-800 pulse-warning">‚ö†Ô∏è Qtd. Divergente</span>';
            } else if (item.hasTombamentoDivergence) {
                // Diverg√™ncia de Tombamento (Qtd OK)
                cardClass = 'bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-300';
                diffClass = 'text-gray-700';
                borderColor = 'border-yellow-400';
                icon = 'üîÑ'; 
                divergenceWarning = '<span class="status-badge bg-yellow-200 text-yellow-800">‚ö†Ô∏è Tombo Divergente (Qtd. OK)</span>';
            }
            
            const diffText = `${item.diff > 0 ? '+' : ''}${item.diff}`;
            
            const card = document.createElement('button');
            card.className = `p-6 border-2 rounded-xl shadow-lg text-left transition-all card-hover ${cardClass} ${borderColor}`;
            card.setAttribute('onclick', `openModal('${compositeKey}')`); 
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${item.local}</h3>
                        <p class="text-sm text-gray-600 font-semibold">üè¢ ${item.unidade}</p>
                    </div>
                    <div class="text-4xl">${icon}</div>
                </div>
                <div class="mb-4">${divergenceWarning}</div>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black text-blue-600">${item.qtdInv}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">INVENT√ÅRIO</div>
                    </div>
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black text-orange-600">${item.qtdSis}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">SISTEMA</div>
                    </div>
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black ${diffClass}">${diffText}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">DIFEREN√áA</div>
                    </div>
                </div>
            `;
            return card;
        }

        function updateSummaryUI(totalInv, totalSis, totalDiff) {
            document.getElementById('summary-inv').textContent = totalInv;
            document.getElementById('summary-sis').textContent = totalSis;
            document.getElementById('summary-diff').textContent = `${totalDiff > 0 ? '+' : ''}${totalDiff}`;
            
            const diffIcon = document.getElementById('diff-icon');
            const diffStatus = document.getElementById('diff-status');
            const diffBar = document.getElementById('progress-diff');
            
            if (totalDiff > 0) {
                diffIcon.textContent = 'üìâ';
                diffStatus.textContent = 'Falta Sistema';
                diffStatus.className = 'status-badge bg-red-200 text-red-700';
                diffBar.className = 'progress-fill bg-red-500';
            } else if (totalDiff < 0) {
                diffIcon.textContent = 'üìà';
                diffStatus.textContent = 'Sobra Sistema';
                diffStatus.className = 'status-badge bg-orange-200 text-orange-700';
                diffBar.className = 'progress-fill bg-orange-500';
            } else {
                diffIcon.textContent = '‚úÖ';
                diffStatus.textContent = 'Equil√≠brio';
                diffStatus.className = 'status-badge bg-green-200 text-green-700';
                diffBar.className = 'progress-fill bg-green-500';
            }
            
            const maxValue = Math.max(totalInv, totalSis, 1);
            document.getElementById('progress-inv').style.width = `${(totalInv / maxValue) * 100}%`;
            document.getElementById('progress-sis').style.width = `${(totalSis / maxValue) * 100}%`;
            
            const diffPercent = Math.abs(totalDiff) / maxValue * 100;
            diffBar.style.width = `${diffPercent}%`;
        }

        const searchLocal = debounce((searchTerm) => {
            currentSearchTerm = searchTerm;
            const selectedUnit = document.getElementById('unit-filter').value;
            filterResultCards(selectedUnit);
        }, 300);

        // === SISTEMA DE VINCULA√á√ÉO ===

        function toggleLinkingMode() {
            linkingMode = !linkingMode;
            const btn = document.getElementById('link-mode-btn');
            const info = document.getElementById('linking-info');
            
            if (linkingMode) {
                btn.innerHTML = '<span>‚úñ</span><span>Desativar Vincula√ß√£o</span>';
                btn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition flex items-center gap-2';
                info.classList.remove('hidden');
                selectedInvItem = null;
                selectedSysItem = null;
            } else {
                btn.innerHTML = '<span>üîó</span><span>Ativar Modo Vincula√ß√£o</span>';
                btn.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2';
                info.classList.add('hidden');
                cancelLinking();
                return;
            }
            
            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                 renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
            }
        }

        function cancelLinking() {
            selectedInvItem = null;
            selectedSysItem = null;
            linkingMode = false;
            document.getElementById('linking-info').classList.add('hidden');
            const btn = document.getElementById('link-mode-btn');
            btn.innerHTML = '<span>üîó</span><span>Ativar Modo Vincula√ß√£o</span>';
            btn.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2';
            
            document.querySelectorAll('.item-selected').forEach(el => el.classList.remove('item-selected'));

            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                 renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
            }
        }

        // Fun√ß√£o para selecionar item - usa o itemId (Tombo/Tombamento)
        function selectItemForLinking(event, itemId, isInventory) {
            if (!linkingMode) return;
            
            event.stopPropagation(); 
            
            const clickedLi = event.target.closest('li');
            if (!clickedLi) return;

            if (isInventory) {
                selectedInvItem = itemId;
                document.querySelectorAll('#modal-inv-list .item-selected').forEach(el => el.classList.remove('item-selected'));
                clickedLi.classList.add('item-selected');
            } else {
                selectedSysItem = itemId;
                document.querySelectorAll('#modal-sis-list .item-selected').forEach(el => el.classList.remove('item-selected'));
                clickedLi.classList.add('item-selected');
            }
            
            if (selectedInvItem && selectedSysItem) {
                createLink(selectedInvItem, selectedSysItem);
            }
        }

        // Cria link e melhora efeito de escolha (itens somem)
        function createLink(invItem, sysItem) {
            if (!itemLinks.has(currentCompositeKey)) {
                itemLinks.set(currentCompositeKey, new Map());
            }
            
            const locationLinks = itemLinks.get(currentCompositeKey);
            locationLinks.set(invItem, sysItem);
            
            saveLinksToStorage();
            
            // Reseta sele√ß√£o
            selectedInvItem = null;
            selectedSysItem = null;
            document.querySelectorAll('.item-selected').forEach(el => el.classList.remove('item-selected'));
            
            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                const tombamentoOnly = details.hasTombamentoDivergence && !details.hasQuantityDivergence;
                
                renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
                
                // Checa se a lista ficou vazia ap√≥s o link (REQ 3: finaliza liga√ß√£o de tombamento)
                const invListCount = document.getElementById('modal-inv-list').querySelectorAll('li').length;
                const sisListCount = document.getElementById('modal-sis-list').querySelectorAll('li').length;
                
                if (tombamentoOnly && invListCount === 0 && sisListCount === 0) {
                    showCustomAlert('‚úÖ V√≠nculo criado e diverg√™ncia de Tombo resolvida! Reanalisando a tabela...');
                    closeModal();
                    runMasterCount(); // Re-run master count to remove the card from the main screen
                    return;
                }

                // Exibe alerta padr√£o
                showCustomAlert(`‚úÖ V√≠nculo criado!\nüìã Invent√°rio ID: ${invItem}\n‚öôÔ∏è Sistema ID: ${sysItem}`);
            }
        }

        function removeLink(compositeKey, invItem) {
            if (itemLinks.has(compositeKey)) {
                itemLinks.get(compositeKey).delete(invItem);
                if (itemLinks.get(compositeKey).size === 0) {
                    itemLinks.delete(compositeKey);
                }
                saveLinksToStorage();
                updateLinkManagerDisplay();
            }
        }

        // Fun√ß√£o de confirma√ß√£o customizada
        function showCustomConfirm(message, onConfirm) {
            const existingConfirm = document.getElementById('custom-confirm');
            if (existingConfirm) existingConfirm.remove();
            
            const confirmDiv = document.createElement('div');
            confirmDiv.id = 'custom-confirm';
            confirmDiv.className = 'modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300';
            
            confirmDiv.innerHTML = `
                <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl transform scale-95 transition-all duration-300 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">${message}</h3>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-btn-no" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg transition">
                            Cancelar
                        </button>
                        <button id="confirm-btn-yes" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition">
                            Confirmar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
            
            const modalContent = confirmDiv.querySelector('.modal-content');
            
            setTimeout(() => {
                confirmDiv.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            const closeConfirm = () => {
                confirmDiv.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => confirmDiv.remove(), 300);
            };
            
            document.getElementById('confirm-btn-yes').onclick = () => {
                onConfirm();
                closeConfirm();
            };
            document.getElementById('confirm-btn-no').onclick = closeConfirm;
        }

        // Fun√ß√£o de alerta customizada
        function showCustomAlert(message) {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300';
            
            alertDiv.innerHTML = `
                <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl transform scale-95 transition-all duration-300 p-6">
                    <p class="text-gray-700 whitespace-pre-line mb-6">${message}</p>
                    <div class="flex justify-end">
                        <button id="alert-btn-ok" class="px-8 py-2 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg transition">
                            OK
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            const modalContent = alertDiv.querySelector('.modal-content');
            
            setTimeout(() => {
                alertDiv.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            const closeAlert = () => {
                alertDiv.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => alertDiv.remove(), 300);
            };
            
            document.getElementById('alert-btn-ok').onclick = closeAlert;
        }


        function clearAllLinks() {
            showCustomConfirm('‚ö†Ô∏è Tem certeza que deseja limpar TODAS as vincula√ß√µes?', () => {
                itemLinks.clear();
                saveLinksToStorage();
                showCustomAlert('‚úÖ Todas as vincula√ß√µes foram removidas!');
            });
        }

        function reanalyzeWithLinks() {
            closeModal();
            runMasterCount();
        }

        // === MODAL ===
        
        let currentModalData = { invItems: [], sisItems: [] };
        
        function openModal(compositeKey) {
            const details = discrepancyDetails.get(compositeKey);
            if (!details) return;

            currentModalData = details;
            currentCompositeKey = compositeKey;

            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');

            document.getElementById('modal-title').textContent = `üìç ${details.local}`;
            document.getElementById('modal-search').value = '';
            
            renderModalLists(details.invItems, details.sisItems);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        // Renderiza listas filtrando itens vinculados (sumir) e atualiza subt√≠tulo
        function renderModalLists(rawInvItems, rawSisItems, searchTerm = '') {
            const invList = document.getElementById('modal-inv-list');
            const sisList = document.getElementById('modal-sis-list');
            
            // Agrupa por itemId (Tombo/Tombamento)
            const invQtyMap = groupItems(rawInvItems);
            const sisQtyMap = groupItems(rawSisItems);
            
            // Aplica vincula√ß√µes para determinar itens "consumidos"
            const locationLinks = itemLinks.get(currentCompositeKey) || new Map();
            const tempInvQtyMap = new Map(invQtyMap);
            const tempSisQtyMap = new Map(sisQtyMap);

            locationLinks.forEach((sysId, invId) => {
                const invQty = tempInvQtyMap.get(invId) || 0;
                const sisQty = tempSisQtyMap.get(sysId) || 0;

                const consumed = Math.min(invQty, sisQty);
                
                if (consumed > 0) {
                    tempInvQtyMap.set(invId, invQty - consumed);
                    tempSisQtyMap.set(sysId, sisQty - consumed);
                }
            });

            // Converte Map<itemId, qty> para lista de objetos ItemData
            function mapToList(map, rawItems) {
                const list = [];
                map.forEach((qty, itemId) => {
                    if (qty > 0) {
                        const itemData = rawItems.find(i => i.itemId === itemId);
                        if (itemData) {
                            // Cria um item por quantidade restante
                            for(let i = 0; i < qty; i++) {
                                list.push({
                                    itemId: itemId,
                                    description: itemData.description,
                                    totalQty: qty // Usamos a quantidade total restante aqui
                                });
                            }
                        }
                    }
                });
                return list;
            }

            const filteredInvItems = mapToList(tempInvQtyMap, rawInvItems)
                .filter(item => !searchTerm || normalizeString(item.itemId).includes(normalizeString(searchTerm)) || normalizeString(item.description).includes(normalizeString(searchTerm)));
            
            const filteredSisItems = mapToList(tempSisQtyMap, rawSisItems)
                .filter(item => !searchTerm || normalizeString(item.itemId).includes(normalizeString(searchTerm)) || normalizeString(item.description).includes(normalizeString(searchTerm)));

            // T√≠tulos
            document.getElementById('modal-inv-title').innerHTML = `
                <span class="text-2xl">üìã</span>
                <span>Invent√°rio (${filteredInvItems.length} tombo(s) restantes)</span>
            `;
            document.getElementById('modal-sis-title').innerHTML = `
                <span class="text-2xl">‚öôÔ∏è</span>
                <span>Sistema (${filteredSisItems.length} tombamento(s) restantes)</span>
            `;

            // Renderiza Invent√°rio
            invList.innerHTML = '';
            if (filteredInvItems.length === 0) {
                invList.innerHTML = '<li class="text-gray-500 italic p-3 bg-white rounded-lg">Nenhum item restante</li>';
            } else {
                let currentItemId = '';
                let indexCounter = 0;

                filteredInvItems.forEach((itemData) => {
                    const { itemId, description, totalQty } = itemData;

                    if (itemId !== currentItemId) {
                        currentItemId = itemId;
                        indexCounter++;
                        
                        const li = document.createElement('li');
                        // No modal, s√≥ restam itens "S√≥ Invent√°rio"
                        li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition item-only-inv ${linkingMode ? 'linking-mode cursor-pointer' : ''}`;
                        if (linkingMode) {
                            li.setAttribute('onclick', `selectItemForLinking(event, '${itemId.replace(/'/g, "\\'")}', true)`);
                        }
                        
                        li.innerHTML = `
                            <div class="flex items-center gap-3 mb-2">
                                <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">${indexCounter}</span>
                                <span class="flex-1 font-medium">ID: ${itemId} | Descri√ß√£o: ${description}</span>
                            </div>
                            <div class="ml-9">
                                <span class="divergence-badge bg-blue-200 text-blue-800 border border-blue-400">‚ö†Ô∏è Restante (Qtd: ${totalQty})</span>
                            </div>
                        `;
                        invList.appendChild(li);
                    }
                });
            }

            // Renderiza Sistema
            sisList.innerHTML = '';
            if (filteredSisItems.length === 0) {
                sisList.innerHTML = '<li class="text-gray-500 italic p-3 bg-white rounded-lg">Nenhum item restante</li>';
            } else {
                let currentItemId = '';
                let indexCounter = 0;

                filteredSisItems.forEach((itemData) => {
                    const { itemId, description, totalQty } = itemData;

                    if (itemId !== currentItemId) {
                        currentItemId = itemId;
                        indexCounter++;
                        
                        const li = document.createElement('li');
                        // No modal, s√≥ restam itens "S√≥ Sistema"
                        li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition item-only-sys ${linkingMode ? 'linking-mode cursor-pointer' : ''}`;
                        if (linkingMode) {
                            li.setAttribute('onclick', `selectItemForLinking(event, '${itemId.replace(/'/g, "\\'")}', false)`);
                        }
                        
                        li.innerHTML = `
                            <div class="flex items-center gap-3 mb-2">
                                <span class="flex-shrink-0 w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs font-bold">${indexCounter}</span>
                                <span class="flex-1 font-medium">ID: ${itemId} | Descri√ß√£o: ${description}</span>
                            </div>
                            <div class="ml-9">
                                <span class="divergence-badge bg-orange-200 text-orange-800 border border-orange-400">‚ö†Ô∏è Restante (Qtd: ${totalQty})</span>
                            </div>
                        `;
                        sisList.appendChild(li);
                    }
                });
            }

            // Atualiza subt√≠tulo do modal (REQ 3, 4)
            const details = discrepancyDetails.get(currentCompositeKey);
            let subtitle = `üè¢ ${details.unidade}`;
            let linkingMessage = 'Selecione 1 item do Invent√°rio e 1 do Sistema para vincular';
            
            if (details.hasQuantityDivergence && details.hasTombamentoDivergence) {
                subtitle += ' | üö® Qtd. e Tombo Divergentes';
            } else if (details.hasQuantityDivergence) {
                subtitle += ' | ‚ö†Ô∏è Diverg√™ncia de Quantidade';
            } else if (details.hasTombamentoDivergence) {
                subtitle += ' | üîÑ Diverg√™ncia de Tombo (Qtd. OK)';
                linkingMessage = 'Esse local n√£o tem diverg√™ncia de quantidade. Vincule os IDs soltos (Tombo/Tombamento) para finalizar a liga√ß√£o.'; 
            }
            
            document.getElementById('modal-subtitle').textContent = subtitle;
            document.getElementById('linking-info').querySelector('p').textContent = linkingMessage;
        }

        const searchModalItems = debounce((searchTerm) => {
            renderModalLists(currentModalData.invItems, currentModalData.sisItems, searchTerm);
        }, 300);

        function closeModal() {
            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                cancelLinking();
            }, 300);
        }

        // === GERENCIADOR DE LINKS ===
        function toggleLinkManager() {
            const modal = document.getElementById('link-manager-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            updateLinkManagerDisplay();
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeLinkManager() {
            const modal = document.getElementById('link-manager-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function updateLinkManagerDisplay() {
            const container = document.getElementById('link-list-container');
            container.innerHTML = '';
            
            if (itemLinks.size === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 italic p-8">Nenhuma vincula√ß√£o criada ainda</p>';
                return;
            }
            
            itemLinks.forEach((links, compositeKey) => {
                const [unidade, local] = compositeKey.split('|');
                
                const section = document.createElement('div');
                section.className = 'mb-6 p-4 bg-purple-50 rounded-xl border-2 border-purple-200';
                section.innerHTML = `
                    <h4 class="font-bold text-lg text-purple-800 mb-3">üìç ${local.toUpperCase()} (${unidade.toUpperCase()})</h4>
                    <div class="space-y-2"></div>
                `;
                
                const listContainer = section.querySelector('.space-y-2');
                
                links.forEach((sysItem, invItem) => {
                    const linkItem = document.createElement('div');
                    linkItem.className = 'flex items-center justify-between bg-white p-3 rounded-lg shadow';
                    linkItem.innerHTML = `
                        <div class="flex-1">
                            <span class="font-semibold text-blue-700">üìã Tombo (Inv): ${invItem}</span>
                            <span class="mx-2 text-purple-600">üîó</span>
                            <span class="font-semibold text-orange-700">‚öôÔ∏è Tombamento (Sis): ${sysItem}</span>
                        </div>
                        <button onclick="removeLink('${compositeKey}', '${invItem.replace(/'/g, "\\'")}'); event.stopPropagation();" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold transition">
                            üóëÔ∏è
                        </button>
                    `;
                    listContainer.appendChild(linkItem);
                });
                
                container.appendChild(section);
            });
        }

        function exportLinks() {
            const data = {};
            itemLinks.forEach((value, key) => {
                data[key] = Object.fromEntries(value);
            });
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `vinculos_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        }

        function importLinks() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        itemLinks = new Map(Object.entries(data).map(([key, val]) => [key, new Map(Object.entries(val))]));
                        saveLinksToStorage();
                        showCustomAlert('‚úÖ Vincula√ß√µes importadas com sucesso!');
                    } catch (error) {
                        showCustomAlert('‚ùå Erro ao importar arquivo');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // === RELAT√ìRIO FINAL ===
        
        function generateFinalReport() {
            const modal = document.getElementById('final-report-modal');
            const modalContent = modal.querySelector('.modal-content');
            const content = document.getElementById('final-report-content');
            
            content.innerHTML = '<p class="text-center p-8">Gerando relat√≥rio...</p>';
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
                
                setTimeout(() => {
                    const reportHTML = buildFinalReport();
                    content.innerHTML = reportHTML;
                }, 100);
            }, 10);
        }

        // Novo: Constr√≥i o relat√≥rio final com todos os campos e lida com Tombamento
        function buildFinalReport() {
            const unitReport = new Map();
            
            // Mapeia todas as linhas completas do Invent√°rio e Sistema por ItemID (Tombo/Tombamento)
            const allInvItems = new Map(); // Map<itemId, Array<{itemId, data}>>
            const allSisItems = new Map();
            
            globalInventarioData.forEach(item => {
                const itemId = item[findColumn(Object.keys(item), COLUMNS.INV.ID)];
                if (itemId) {
                    if (!allInvItems.has(itemId)) allInvItems.set(itemId, []);
                    allInvItems.get(itemId).push({ itemId, data: item });
                }
            });

            globalSistemaData.forEach(item => {
                const itemId = item[findColumn(Object.keys(item), COLUMNS.SIS.ID)];
                if (itemId) {
                    if (!allSisItems.has(itemId)) allSisItems.set(itemId, []);
                    allSisItems.get(itemId).push({ itemId, data: item });
                }
            });


            // Itera sobre as discrep√¢ncias (locais)
            discrepancyDetails.forEach((details, compositeKey) => {
                
                const locationLinks = itemLinks.get(compositeKey) || new Map();
                
                const invMap = groupItems(details.invItems); // Map<itemId, qty>
                const sisMap = groupItems(details.sisItems); // Map<itemId, qty>
                
                const missing = [];
                const extra = [];
                
                const processedSysIds = new Set();
                
                // 1. Processa Itens do Invent√°rio (o que deveria estar l√°)
                invMap.forEach((invQty, invId) => {
                    const linkedSysId = locationLinks.get(invId);
                    
                    if (linkedSysId) {
                        processedSysIds.add(linkedSysId);
                        const sisQty = sisMap.get(linkedSysId) || 0;
                        const diff = invQty - sisQty;
                        
                        // Se Invent√°rio tem mais do que Sistema (ap√≥s v√≠nculo)
                        if (diff > 0) {
                            // Faltando diff itens do SISTEMA (para o ID vinculado)
                            // A lista Missing deve se basear nos dados do Invent√°rio
                            const invItemData = details.invItems.find(i => i.itemId === invId);
                            if (invItemData) {
                                for(let i = 0; i < diff; i++) {
                                     missing.push({ ...invItemData, type: 'Missing_Linked', qty: 1, linkedTo: linkedSysId });
                                }
                            }
                        } 
                        // Se Sistema tem mais do que Invent√°rio (ap√≥s v√≠nculo) - tratado em 2.
                    } else {
                        // Item N√ÉO VINCULADO (pode ser discrep√¢ncia de QTD, Tombo ou S√≥ Invent√°rio)
                        const sisQty = sisMap.get(invId) || 0;
                        const diff = invQty - sisQty;
                        
                        if (diff > 0) {
                            // Faltando diff itens do SISTEMA (para o ID n√£o vinculado)
                            const invItemData = details.invItems.find(i => i.itemId === invId);
                            if (invItemData) {
                                for(let i = 0; i < diff; i++) {
                                    missing.push({ ...invItemData, type: 'Missing_Unlinked', qty: 1 });
                                }
                            }
                        }
                    }
                });
                
                // 2. Processa Itens do Sistema (o que sobrou)
                sisMap.forEach((sisQty, sisId) => {
                    const invQty = invMap.get(sisId) || 0;
                    
                    if (processedSysIds.has(sisId)) {
                        // Item foi vinculado. Checa se sobrou no Sistema.
                        let linkedInvId = Array.from(locationLinks.entries()).find(([inv, sys]) => sys === sisId)?.[0];

                        const originalInvQty = invMap.get(linkedInvId) || 0;
                        const diff = sisQty - originalInvQty; // Sis - Inv
                        
                        if (diff > 0) {
                            // Sobrando diff itens no SISTEMA (ap√≥s v√≠nculo)
                            const sisItemData = details.sisItems.find(i => i.itemId === sisId);
                            if (sisItemData) {
                                for(let i = 0; i < diff; i++) {
                                     extra.push({ ...sisItemData, type: 'Extra_Linked', qty: 1, linkedFrom: linkedInvId });
                                }
                            }
                        }
                    } else if (locationLinks.has(sisId)) {
                        // Se esse sisId √© o TARGET de um link, j√° foi tratado pelo invMap
                        return;
                    } else {
                        // Item N√ÉO VINCULADO e Sobrando
                        const diff = sisQty - invQty; // Sis - Inv
                        
                        if (diff > 0) {
                            // Sobrando diff itens no SISTEMA (n√£o vinculado)
                            const sisItemData = details.sisItems.find(i => i.itemId === sisId);
                            if (sisItemData) {
                                for(let i = 0; i < diff; i++) {
                                    extra.push({ ...sisItemData, type: 'Extra_Unlinked', qty: 1 });
                                }
                            }
                        }
                    }
                });
                
                if (missing.length > 0 || extra.length > 0) {
                    if (!unitReport.has(details.unidade)) {
                        unitReport.set(details.unidade, []);
                    }
                    unitReport.get(details.unidade).push({
                        local: details.local,
                        missing,
                        extra
                    });
                }
            });
            
            // Gera HTML
            let html = '';
            
            if (unitReport.size === 0) {
                return '<div class="text-center p-8 bg-green-50 rounded-xl"><p class="text-2xl mb-2">üéâ</p><p class="text-lg font-bold text-green-700">Tudo est√° correto!</p><p class="text-gray-600">N√£o h√° itens faltantes ap√≥s as vincula√ß√µes</p></div>';
            }
            
            unitReport.forEach((locations, unidade) => {
                html += `
                    <div class="mb-8">
                        <h3 class="text-2xl font-bold text-purple-800 mb-4 pb-2 border-b-2 border-purple-300">
                            üè¢ ${unidade}
                        </h3>
                `;
                
                locations.forEach(location => {
                    html += `
                        <div class="mb-6 p-4 bg-gray-50 rounded-xl border-2 border-gray-200">
                            <h4 class="font-bold text-lg text-gray-800 mb-3">üìç ${location.local}</h4>
                    `;
                    
                    if (location.missing.length > 0) {
                        // Tabela para ITENS FALTANTES (devem ser adicionados ao sistema, logo, dados do Invent√°rio)
                        html += `
                            <div class="mb-4 overflow-x-auto custom-scrollbar">
                                <p class="font-bold text-red-700 mb-2">‚ö†Ô∏è FALTANDO (adicionar ao sistema):</p>
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Tombamento</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Unidade</th>
                                            <th>Localiza√ß√£o</th>
                                            <th>Estado</th>
                                            <th>Origem da Doa√ß√£o</th>
                                            <th>Observa√ß√£o</th>
                                            <th>Fornecedor</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        location.missing.forEach(item => {
                            // Usa a data (linha completa) do item do Invent√°rio
                            const row = item.data; 
                            html += `
                                <tr>
                                    <td>${row['Tipo'] || '-'}</td>
                                    <td class="font-medium">${row['Tombo'] || item.itemId}</td>
                                    <td>${row['Item'] || '-'}</td>
                                    <td>${row['Unidade'] || '-'}</td>
                                    <td>${row['Local'] || '-'}</td>
                                    <td>${row['Estado'] || '-'}</td>
                                    <td>${row['Origem da Doa√ß√£o'] || '-'}</td>
                                    <td>${row['Observa√ß√£o'] || '-'}</td>
                                    <td>${row['Fornecedor'] || '-'}</td>
                                    <td class="text-red-600 font-bold">${item.linkedTo ? `LIGAR AO ID ${item.linkedTo}` : 'INSERIR NO SIS.'}</td>
                                </tr>
                            `;
                        });
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    if (location.extra.length > 0) {
                        // Tabela para ITENS SOBRANDO (devem ser removidos do sistema, logo, dados do Sistema)
                        html += `
                            <div>
                                <p class="font-bold text-orange-700 mb-2">üì¶ SOBRANDO (remover do sistema):</p>
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>Tombamento</th>
                                            <th>Descri√ß√£o</th>
                                            <th>Unidade</th>
                                            <th>Localiza√ß√£o</th>
                                            <th>Estado</th>
                                            <th>Origem da Doa√ß√£o</th>
                                            <th>Observa√ß√£o</th>
                                            <th>Fornecedor</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        location.extra.forEach(item => {
                            // Usa a data (linha completa) do item do Sistema
                            const row = item.data;
                            html += `
                                <tr>
                                    <td>${row['Tipo'] || '-'}</td>
                                    <td class="font-medium">${row['Tombamento'] || item.itemId}</td>
                                    <td>${row['Descri√ß√£o'] || '-'}</td>
                                    <td>${row['Unidade'] || '-'}</td>
                                    <td>${row['Localiza√ß√£o'] || '-'}</td>
                                    <td>${row['Estado'] || '-'}</td>
                                    <td>${row['Origem da Doa√ß√£o'] || '-'}</td>
                                    <td>${row['Observa√ß√£o'] || '-'}</td>
                                    <td>${row['Fornecedor'] || '-'}</td>
                                    <td class="text-orange-600 font-bold">${item.linkedFrom ? `DESLIGAR DO ID ${item.linkedFrom}` : 'REMOVER DO SIS.'}</td>
                                </tr>
                            `;
                        });
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            return html;
        }

        function closeFinalReport() {
            const modal = document.getElementById('final-report-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Exporta CSV com os cabe√ßalhos solicitados
        function exportFinalReport() {
            const reportData = [];

            discrepancyDetails.forEach((details, compositeKey) => {
                const locationLinks = itemLinks.get(compositeKey) || new Map();
                const invMap = groupItems(details.invItems);
                const sisMap = groupItems(details.sisItems);
                
                const tempInvMap = new Map(invMap);
                const tempSisMap = new Map(sisMap);
                
                // 1. Processa Links para subtrair quantidades
                locationLinks.forEach((sysId, invId) => {
                    const invQty = tempInvMap.get(invId) || 0;
                    const sisQty = tempSisMap.get(sysId) || 0;
                    const consumed = Math.min(invQty, sisQty);
                    if (consumed > 0) {
                        tempInvMap.set(invId, invQty - consumed);
                        tempSisMap.set(sysId, sisQty - consumed);
                    }
                });

                // 2. Coleta ITENS FALTANTES (dados do Invent√°rio)
                tempInvMap.forEach((qty, invId) => {
                    if (qty > 0) {
                        const invItemData = details.invItems.find(i => i.itemId === invId).data;
                        const linkedTo = locationLinks.get(invId);
                        
                        for (let i = 0; i < qty; i++) {
                            const row = {
                                'Tipo': invItemData['Tipo'] || '',
                                'Tombamento': invItemData['Tombo'] || invId,
                                'Descri√ß√£o': invItemData['Item'] || '',
                                'Unidade': invItemData['Unidade'] || details.unidade,
                                'Quantidade': 1,
                                'Localiza√ß√£o': invItemData['Local'] || details.local,
                                'Estado': invItemData['Estado'] || '',
                                'Origem da Doa√ß√£o': invItemData['Origem da Doa√ß√£o'] || '',
                                'Observa√ß√£o': invItemData['Observa√ß√£o'] || '',
                                'Fornecedor': invItemData['Fornecedor'] || '',
                                'A√ß√£o': linkedTo ? `LIGAR AO ID ${linkedTo}` : 'INSERIR NO SIS.',
                                'Local_Composto': compositeKey 
                            };
                            reportData.push(row);
                        }
                    }
                });

                // 3. Coleta ITENS SOBRANDO (dados do Sistema)
                tempSisMap.forEach((qty, sisId) => {
                    if (qty > 0) {
                        const sisItemData = details.sisItems.find(i => i.itemId === sisId).data;
                        let linkedFrom = Array.from(locationLinks.entries()).find(([inv, sys]) => sys === sisId)?.[0];
                        
                        for (let i = 0; i < qty; i++) {
                            const row = {
                                'Tipo': sisItemData['Tipo'] || '',
                                'Tombamento': sisItemData['Tombamento'] || sisId,
                                'Descri√ß√£o': sisItemData['Descri√ß√£o'] || '',
                                'Unidade': sisItemData['Unidade'] || details.unidade,
                                'Quantidade': 1,
                                'Localiza√ß√£o': sisItemData['Localiza√ß√£o'] || details.local,
                                'Estado': sisItemData['Estado'] || '',
                                'Origem da Doa√ß√£o': sisItemData['Origem da Doa√ß√£o'] || '',
                                'Observa√ß√£o': sisItemData['Observa√ß√£o'] || '',
                                'Fornecedor': sisItemData['Fornecedor'] || '',
                                'A√ß√£o': linkedFrom ? `DESLIGAR DO ID ${linkedFrom}` : 'REMOVER DO SIS.',
                                'Local_Composto': compositeKey
                            };
                            reportData.push(row);
                        }
                    }
                });
            });

            if (reportData.length === 0) {
                showCustomAlert('üéâ O relat√≥rio final est√° vazio! N√£o h√° itens faltantes ap√≥s as vincula√ß√µes.');
                return;
            }

            const headers = FINAL_HEADERS.concat(['A√ß√£o', 'Local_Composto']);
            let csvContent = headers.join(';') + '\n';

            reportData.forEach(item => {
                const values = headers.map(header => {
                    const value = item[header] !== undefined ? item[header] : '';
                    // Sanitiza o valor para CSV
                    let safeValue = String(value).replace(/"/g, '""');
                    if (safeValue.includes(';') || safeValue.includes('\n')) {
                        safeValue = `"${safeValue}"`;
                    }
                    return safeValue;
                });
                csvContent += values.join(';') + '\n';
            });

            const timestamp = new Date().toISOString().slice(0,10);
            const filename = `Relatorio_Tombamento_Final_${timestamp}.csv`;

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Exporta CSV de Auditoria (dados consolidados por local)
        function exportCSV() {
            const selectedUnit = document.getElementById('unit-filter').value;
            const timestamp = new Date().toISOString().slice(0,10);
            let filename = `Auditoria_Consolidada_${selectedUnit === 'all_divergent' ? 'Geral' : selectedUnit}_${timestamp}.csv`;

            const filteredData = (selectedUnit === 'all_divergent') 
                ? auditData 
                : auditData.filter(item => normalizeString(item.unidade) === normalizeString(selectedUnit));

            if (filteredData.length === 0) {
                showCustomAlert('‚ö†Ô∏è N√£o h√° dados para exportar.');
                return;
            }

            const headers = ['Unidade', 'Local', 'Qtd_Inventario', 'Qtd_Sistema', 'Diferenca', 'Status_Quantidade', 'Status_Tombamento'];
            let csvContent = headers.join(';') + '\n';
            
            filteredData.forEach(item => {
                const details = discrepancyDetails.get(item.key);
                
                let statusQtd = 'OK';
                if (item.diff > 0) statusQtd = 'Falta_Sistema';
                if (item.diff < 0) statusQtd = 'Sobra_Sistema';
                
                let statusTombo = 'OK';
                if (details && details.hasTombamentoDivergence) {
                    statusTombo = 'Divergencia_Tombo';
                }
                
                const values = [
                    (item.originalUnit || item.unidade).replace(/;/g, ','),
                    (item.originalLocal || item.local).replace(/;/g, ','),
                    item.qtdInv,
                    item.qtdSis,
                    item.diff,
                    statusQtd,
                    statusTombo
                ];
                csvContent += values.join(';') + '\n';
            });

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === INICIALIZA√á√ÉO ===
        
        function setupDataListeners() {
            const inventarioTextarea = document.getElementById('list-inventario');
            const sistemaTextarea = document.getElementById('list-sistema');
            
            const debouncedUpdate = debounce(updateDataCount, 300);
            
            inventarioTextarea.addEventListener('input', debouncedUpdate);
            sistemaTextarea.addEventListener('input', debouncedUpdate);
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Fecha modais abertos
                    closeModal();
                    closeLinkManager();
                    closeFinalReport();
                    
                    const confirmModal = document.getElementById('custom-confirm');
                    if(confirmModal) confirmModal.remove();
                    
                    const alertModal = document.getElementById('custom-alert');
                    if(alertModal) alertModal.remove();
                }
                
                if (e.ctrlKey && e.key === 'Enter') {
                    runMasterCount();
                }
            });
            
            // Carrega links salvos
            loadLinksFromStorage();
        }

        window.onload = () => {
            setupDataListeners();
            console.log('üöÄ Sistema com Vincula√ß√£o Inteligente carregado!');
        };
    </script>
</body>
</html>
