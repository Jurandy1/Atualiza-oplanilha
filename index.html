<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Quantidade por Local</title>
    <!-- Carregando Tailwind CSS para estiliza칞칚o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definindo a fonte padr칚o e ajustes visuais */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        textarea {
            height: 250px; 
            @apply shadow-inner;
        }
        /* Responsividade da tabela */
        @media (max-width: 640px) {
            .responsive-table th, .responsive-table td {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                font-size: 0.75rem; /* extra small */
            }
        }
        .table-container { max-height: 700px; } /* Altura m치xima para rolagem na tabela */

        /* Estilos do Modal */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Esmeralda */
                        'primary-dark': '#059669',
                        'inventario': '#3b82f6', /* Azul */
                        'sistema': '#f97316', /* Laranja */
                        'export': '#d946ef', /* F칰csia */
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 border-b-4 border-primary pb-2 flex items-center">
            Analisador de Quantidade por Local 游늵
        </h1>
        <p class="text-gray-600 mb-6">
            Cole os dados para auditar a **contagem total de itens por local**. Clique em um card de discrep칙ncia para ver a lista de itens.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Invent치rio (Fonte) -->
            <div>
                <label for="list-inventario" class="block text-lg font-semibold text-inventario mb-2 flex items-center">
                    <span class="mr-2">游늶</span>
                    1. Dados do Invent치rio (Fonte da Verdade)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Usar치 as colunas:** Unidade, Local, Item
                </p>
                <textarea id="list-inventario" class="w-full p-3 border border-inventario rounded-lg focus:ring-inventario focus:border-inventario transition duration-150" placeholder="Cole aqui os dados do Invent치rio, incluindo o cabe칞alho..."></textarea>
                <span id="count-inventario" class="text-sm text-gray-500 mt-1 block">Total de Linhas no Invent치rio: 0</span>
            </div>
            
            <!-- Sistema (Destino) -->
            <div>
                <label for="list-sistema" class="block text-lg font-semibold text-sistema mb-2 flex items-center">
                    <span class="mr-2">丘뙖잺</span>
                    2. Dados do Sistema (Estoque Atual)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Usar치 as colunas:** Unidade, Localiza칞칚o, Descri칞칚o
                </p>
                <textarea id="list-sistema" class="w-full p-3 border border-sistema rounded-lg focus:ring-sistema focus:border-sistema transition duration-150" placeholder="Cole aqui os dados do Sistema, incluindo o cabe칞alho..."></textarea>
                <span id="count-sistema" class="text-sm text-gray-500 mt-1 block">Total de Linhas no Sistema: 0</span>
            </div>
        </div>

        <!-- FILTRO DE UNIDADE -->
        <div id="filter-container" class="mb-6 hidden">
            <label for="unit-filter" class="block text-lg font-semibold text-gray-700 mb-2">
                Selecione a Unidade (CRAS) para Analisar:
            </label>
            <select id="unit-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                <option value="all">-- Todas as Unidades --</option>
                <!-- Op칞칫es de unidade ser칚o preenchidas dinamicamente -->
            </select>
        </div>


        <!-- BOT츾O DE A칂츾O 칔NICO -->
        <div class="mb-8">
             <button onclick="runMasterCount()" class="w-full px-6 py-3 bg-primary text-white font-bold text-lg rounded-xl shadow-lg hover:bg-primary-dark transition duration-300 transform hover:scale-[1.01]">
                Analisar Contagem de Itens por Local
            </button>
        </div>
        
        
        <!-- Container de Resultados - Auditoria de Quantidade -->
        <div id="results-container" class="mt-12 hidden">
            <h2 id="report-title" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-primary pb-2">
                Relat칩rio de Auditoria de Quantidade
            </h2>
            
            <!-- Export Button -->
            <button onclick="exportCSV()" class="w-full md:w-auto px-6 py-2 bg-export text-white font-bold rounded-lg shadow-md hover:bg-fuchsia-700 transition duration-300 transform hover:scale-[1.01] mb-4">
                Exportar Auditoria CSV
            </button>
            
            <!-- Resumo de Totais -->
            <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="summary-inv">0</div>
                    <div class="text-sm font-semibold text-gray-600">Total Itens (Invent치rio)</div>
                </div>
                 <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-orange-600" id="summary-sis">0</div>
                    <div class="text-sm font-semibold text-gray-600">Total Itens (Sistema)</div>
                </div>
                 <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-gray-700" id="summary-diff">0</div>
                    <div class="text-sm font-semibold text-gray-600">Diferen칞a L칤quida (Inv - Sis)</div>
                </div>
            </div>

            <!-- Container de Cards de Discrep칙ncia -->
            <h3 class="text-xl font-bold text-gray-800 mb-4">
                Discrep칙ncias Encontradas (Clique no card para ver os itens)
            </h3>
            <p id="no-discrepancy-message" class="text-gray-600 text-center p-6 bg-gray-50 rounded-lg hidden">
                游꿀 Nenhuma discrep칙ncia encontrada para esta sele칞칚o!
            </p>
            <div id="discrepancy-cards-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Cards de discrep칙ncia clic치veis ser칚o injetados aqui -->
            </div>
        </div>
    </div>

    <!-- MODAL (Janela) para Detalhes dos Itens -->
    <div id="item-details-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeModal()">
        <div class="modal-content bg-white w-full max-w-4xl rounded-xl shadow-2xl p-6 md:p-8 transform scale-95" onclick="event.stopPropagation()">
            <!-- Cabe칞alho do Modal -->
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <div>
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Detalhes dos Itens</h2>
                    <p id="modal-subtitle" class="text-gray-600"></p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            
            <!-- Conte칰do do Modal (Listas Lado a Lado) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Lista Invent치rio -->
                <div>
                    <h3 id="modal-inv-title" class="text-lg font-semibold text-inventario mb-2">Itens no Invent치rio (0)</h3>
                    <ul id="modal-inv-list" class="list-disc list-inside bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-gray-700 space-y-1">
                        <!-- Itens do Invent치rio aqui -->
                    </ul>
                </div>
                <!-- Lista Sistema -->
                <div>
                    <h3 id="modal-sis-title" class="text-lg font-semibold text-sistema mb-2">Itens no Sistema (0)</h3>
                    <ul id="modal-sis-list" class="list-disc list-inside bg-orange-50 border border-orange-200 rounded-lg p-4 text-sm text-gray-700 space-y-1">
                        <!-- Itens do Sistema aqui -->
                    </ul>
                </div>
            </div>
            
            <!-- Rodap칠 do Modal -->
            <div class="mt-6 text-right border-t pt-4">
                <button onclick="closeModal()" class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>


    <script>
        // Global variable for storing audit data
        let auditData = []; // Para a auditoria de quantidade
        let globalInventarioData = [];
        let globalSistemaData = [];
        let uniqueUnits = new Set();
        // Novo: Armazena os dados completos da auditoria, incluindo listas de itens
        let discrepancyDetails = new Map();

        
        // Fun칞칚o de normaliza칞칚o B츼SICA (apenas remove acentos, min칰sculas, espa칞os extras)
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            let s = str.toLowerCase();
            // 1. Remove acentos
            s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            // 2. Remove caracteres especiais
            s = s.replace(/[-/.,]/g, ' '); 
            // 3. Remove espa칞os extras
            s = s.replace(/\s+/g, ' ').trim(); 
            return s;
        }

        // Fun칞칚o para detetar o separador (v칤rgula, ponto e v칤rgula, ou tab) e parsear os dados
        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            let separator = '\t'; // Tentativa padr칚o: Tab

            // Conta a frequ칡ncia de cada separador na primeira linha
            const counts = { ',': (firstLine.match(/,/g) || []).length, ';': (firstLine.match(/;/g) || []).length, '\t': (firstLine.match(/\t/g) || []).length };
            
            // Escolhe o separador com maior contagem (se for maior que zero)
            if (counts[';'] > counts[','] && counts[';'] > counts['\t']) {
                separator = ';';
            } else if (counts[','] > counts[';'] && counts[','] > counts['\t']) {
                separator = ',';
            } else if (counts['\t'] > 0) {
                 separator = '\t';
            }

            const rawHeaders = lines[0].split(separator).map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length === rawHeaders.length) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        // Encontra o cabe칞alho original (mantendo case)
                        const originalHeader = rawHeaders.find(h => normalizeString(h) === normalizeString(header));
                        item[originalHeader || header] = values[index];
                    });
                    data.push(item);
                }
            }
            return data;
        }

        // Fun칞칚o para atualizar o filtro de unidades
        function updateUnitFilter() {
            uniqueUnits = new Set();
            const filterSelect = document.getElementById('unit-filter');
            const filterContainer = document.getElementById('filter-container');

            // Encontra o nome da coluna "Unidade" em ambas as listas
            const invHeader = (globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : []);
            const invUnitCol = invHeader.find(k => normalizeString(k) === 'unidade');
            
            const sisHeader = (globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : []);
            const sisUnitCol = sisHeader.find(k => normalizeString(k) === 'unidade');
            
            globalInventarioData.forEach(item => {
                if(invUnitCol) uniqueUnits.add(normalizeString(item[invUnitCol] || ''));
            });
            globalSistemaData.forEach(item => {
                if(sisUnitCol) uniqueUnits.add(normalizeString(item[sisUnitCol] || ''));
            });

            // Limpa unidades vazias
            uniqueUnits.delete('');
            uniqueUnits.delete('sem unidade');

            // Limpa op칞칫es antigas (mantendo a primeira)
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }
            
            const sortedUnits = [...uniqueUnits].sort();
            sortedUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit.toUpperCase(); // Mostra em mai칰sculo para ficar mais claro
                filterSelect.appendChild(option);
            });
            
            if (sortedUnits.length > 0) {
                filterContainer.classList.remove('hidden');
            } else {
                filterContainer.classList.add('hidden');
            }
        }
        
        // --- FLUXO 칔NICO: Auditoria de Quantidade Mestra (Agora com filtro) ---
        function runMasterCount() {
            document.getElementById('results-container').classList.add('hidden');
            
            if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                // Tenta carregar os dados se estiverem vazios (caso o usu치rio cole e clique r치pido)
                 globalInventarioData = parseData(document.getElementById('list-inventario').value);
                 globalSistemaData = parseData(document.getElementById('list-sistema').value);
                 if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                    console.error('Dados n칚o foram carregados.');
                    alert("Por favor, cole os dados nas duas caixas antes de analisar.");
                    return;
                 }
            }

            // Pega a unidade selecionada no filtro
            const selectedUnit = document.getElementById('unit-filter').value;

            // Mostra o container de resultados
            document.getElementById('results-container').classList.remove('hidden');

            const inventarioMap = new Map(); // Map<"unidade|local", { count: 0, items: [] }>
            const sistemaMap = new Map();
            const allCompositeKeys = new Set();
            auditData = []; // Limpa auditoria anterior
            discrepancyDetails.clear(); // Limpa detalhes anteriores
            
            let totalInv = 0;
            let totalSis = 0;
            let hasDiscrepancy = false;

            // Encontra os nomes das colunas
            const invHeader = (globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : []);
            const invUnitCol = invHeader.find(k => normalizeString(k) === 'unidade');
            const invLocalCol = invHeader.find(k => normalizeString(k) === 'local');
            const invItemCol = invHeader.find(k => normalizeString(k) === 'item'); // Novo: Coluna do Item
            
            const sisHeader = (globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : []);
            const sisUnitCol = sisHeader.find(k => normalizeString(k) === 'unidade');
            const sisLocalCol = sisHeader.find(k => normalizeString(k) === 'localizacao') || sisHeader.find(k => normalizeString(k) === 'local');
            const sisItemCol = sisHeader.find(k => normalizeString(k) === 'descricao') || sisHeader.find(k => normalizeString(k) === 'item'); // Novo: Coluna da Descri칞칚o

            if (!invLocalCol || !sisLocalCol) {
                alert("Erro: N칚o foi poss칤vel encontrar as colunas 'Local' (na Lista 1) e 'Localiza칞칚o' (na Lista 2). Verifique os cabe칞alhos.");
                return;
            }
             if (!invItemCol || !sisItemCol) {
                alert("Aviso: N칚o foi poss칤vel encontrar as colunas 'Item' (Lista 1) ou 'Descri칞칚o' (Lista 2). O detalhamento de itens pode ficar vazio.");
            }

            // Processa Invent치rio (USA: Unidade, Local, Item)
            globalInventarioData.forEach(item => {
                const unidade = invUnitCol ? normalizeString(item[invUnitCol] || 'Sem Unidade') : 'sem unidade';
                
                // Pula o item se n칚o for da unidade selecionada (e n칚o for 'all')
                if (selectedUnit !== 'all' && unidade !== selectedUnit) return;
                
                const local = normalizeString(item[invLocalCol] || 'Sem Local');
                const itemName = invItemCol ? (item[invItemCol] || 'Item sem nome') : 'Item sem nome';
                const compositeKey = `${unidade}|${local}`;
                
                allCompositeKeys.add(compositeKey);
                
                if (!inventarioMap.has(compositeKey)) {
                    inventarioMap.set(compositeKey, { count: 0, items: [] });
                }
                const data = inventarioMap.get(compositeKey);
                data.count++;
                data.items.push(itemName);
            });
            
            // Processa Sistema (USA: Unidade, Localiza칞칚o, Descri칞칚o)
            globalSistemaData.forEach(item => {
                const unidade = sisUnitCol ? normalizeString(item[sisUnitCol] || 'Sem Unidade') : 'sem unidade';
                
                // Pula o item se n칚o for da unidade selecionada (e n칚o for 'all')
                if (selectedUnit !== 'all' && unidade !== selectedUnit) return;

                const local = normalizeString(item[sisLocalCol] || 'Sem Local');
                const itemName = sisItemCol ? (item[sisItemCol] || 'Item sem nome') : 'Item sem nome';
                const compositeKey = `${unidade}|${local}`;

                allCompositeKeys.add(compositeKey);

                if (!sistemaMap.has(compositeKey)) {
                    sistemaMap.set(compositeKey, { count: 0, items: [] });
                }
                const data = sistemaMap.get(compositeKey);
                data.count++;
                data.items.push(itemName);
            });

            // Gera o relat칩rio de auditoria
            const cardsContainer = document.getElementById('discrepancy-cards-container');
            const noDiscrepancyMsg = document.getElementById('no-discrepancy-message');
            cardsContainer.innerHTML = '';
            
            const sortedKeys = [...allCompositeKeys].sort();

            for (const compositeKey of sortedKeys) {
                // Ignora chaves "vazias"
                if (compositeKey === "sem unidade|sem local") continue;
                
                const [unidade, local] = compositeKey.split('|');
                
                const invData = inventarioMap.get(compositeKey) || { count: 0, items: [] };
                const sisData = sistemaMap.get(compositeKey) || { count: 0, items: [] };
                
                const qtdInv = invData.count;
                const qtdSis = sisData.count;
                const diff = qtdInv - qtdSis;

                // Processa se existir em qualquer lista
                if (qtdInv > 0 || qtdSis > 0) { 
                    
                    // 1. Atualiza totais do resumo (para TODOS os itens)
                    totalInv += qtdInv;
                    totalSis += qtdSis;

                    // 2. Salva para exporta칞칚o (para TODOS os itens, mesmo sem diferen칞a)
                    const auditRow = {
                        unidade: unidade,
                        local: local,
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    };
                    auditData.push(auditRow); // Salva para exporta칞칚o

                    // 3. Cria o card APENAS SE houver discrep칙ncia
                    if (diff !== 0) {
                        hasDiscrepancy = true;
                        
                        // Armazena os detalhes para o modal
                        discrepancyDetails.set(compositeKey, {
                            unidade: unidade,
                            local: local,
                            invItems: invData.items.sort(),
                            sisItems: sisData.items.sort()
                        });
                        
                        let cardClass = 'bg-white border-gray-300';
                        let diffClass = 'text-gray-700';
                        let diffText = `${diff > 0 ? '+' : ''}${diff}`;
                        
                        if (diff > 0) { // Falta no Sistema
                            cardClass = 'bg-green-50 border-green-300';
                            diffClass = 'text-green-600';
                        } else { // Sobra no Sistema
                            cardClass = 'bg-red-50 border-red-300';
                            diffClass = 'text-red-600';
                        }
                        
                        // O card agora 칠 um <button>
                        const card = document.createElement('button');
                        card.className = `p-4 border rounded-lg shadow-md text-left transition-transform transform hover:scale-105 ${cardClass}`;
                        card.setAttribute('onclick', `openModal('${compositeKey}')`);
                        card.innerHTML = `
                            <h3 class="text-lg font-bold text-gray-800">${local}</h3>
                            <p class="text-sm text-gray-600 mb-3">${unidade}</p>
                            <div class="flex justify-between items-center text-center px-2">
                                <div>
                                    <span class="block text-2xl font-bold text-blue-600">${qtdInv}</span>
                                    <span class="text-xs font-semibold text-gray-500">Invent치rio</span>
                                </div>
                                <div>
                                    <span class="block text-2xl font-bold text-orange-600">${qtdSis}</span>
                                    <span class="text-xs font-semibold text-gray-500">Sistema</span>
                                </div>
                                <div>
                                    <span class="block text-2xl font-bold ${diffClass}">${diffText}</span>
                                    <span class="text-xs font-semibold text-gray-500">Diferen칞a</span>
                                </div>
                            </div>
                        `;
                        cardsContainer.appendChild(card);
                    }
                }
            }
            
            // Mostra mensagem se n칚o houver discrep칙ncias
            if (!hasDiscrepancy) {
                noDiscrepancyMsg.classList.remove('hidden');
            } else {
                noDiscrepancyMsg.classList.add('hidden');
            }

            // Atualiza T칤tulos e Resumo
            const unitText = selectedUnit === 'all' ? 'Geral (Todas as Unidades)' : selectedUnit.toUpperCase();
            document.getElementById('report-title').textContent = `Relat칩rio de Auditoria: ${unitText}`;
            
            document.getElementById('summary-inv').textContent = totalInv;
            document.getElementById('summary-sis').textContent = totalSis;
            const totalDiff = totalInv - totalSis;
            document.getElementById('summary-diff').textContent = `${totalDiff > 0 ? '+' : ''}${totalDiff}`;
        }


        // --- Fun칞칫es do MODAL ---
        function openModal(compositeKey) {
            const details = discrepancyDetails.get(compositeKey);
            if (!details) return;

            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');

            // Preenche T칤tulos
            document.getElementById('modal-title').textContent = `Detalhes de: ${details.local.toUpperCase()}`;
            document.getElementById('modal-subtitle').textContent = `Unidade: ${details.unidade.toUpperCase()}`;

            // Preenche Lista Invent치rio
            const invList = document.getElementById('modal-inv-list');
            invList.innerHTML = '';
            document.getElementById('modal-inv-title').textContent = `Itens no Invent치rio (${details.invItems.length})`;
            if (details.invItems.length === 0) {
                invList.innerHTML = '<li class="text-gray-500 italic">Nenhum item encontrado.</li>';
            } else {
                details.invItems.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    invList.appendChild(li);
                });
            }

            // Preenche Lista Sistema
            const sisList = document.getElementById('modal-sis-list');
            sisList.innerHTML = '';
            document.getElementById('modal-sis-title').textContent = `Itens no Sistema (${details.sisItems.length})`;
             if (details.sisItems.length === 0) {
                sisList.innerHTML = '<li class="text-gray-500 italic">Nenhum item encontrado.</li>';
            } else {
                details.sisItems.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    sisList.appendChild(li);
                });
            }

            // Exibe o Modal com anima칞칚o
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250); // Aguarda a transi칞칚o de opacidade terminar
        }


        // Fun칞칚o para exportar CSV (modo 칰nico de auditoria)
        function exportCSV() {
            let csvContent = '';
            const selectedUnit = document.getElementById('unit-filter').value;
            let filename = `Auditoria_de_Quantidade_${selectedUnit === 'all' ? 'Geral' : selectedUnit}.csv`;

            // Exporta Relat칩rio SEM TOMBO
            const headers = ['Unidade', 'Local', 'Qtd_Inventario', 'Qtd_Sistema', 'Diferenca'];
            csvContent = headers.join(';') + '\n';
            
            auditData.forEach(item => {
                const values = [
                    (item.unidade || '').replace(/;/g, ','),
                    (item.local || '').replace(/;/g, ','),
                    item.qtdInv,
                    item.qtdSis,
                    item.diff
                ];
                csvContent += values.join(';') + '\n';
            });

            // L칩gica de Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                console.error("Download is not supported in this browser.");
            }
        }

        // Adiciona listener para atualizar a contagem E o filtro de unidade
        function setupDataListeners() {
            const inventarioTextarea = document.getElementById('list-inventario');
            const sistemaTextarea = document.getElementById('list-sistema');
            
            const handleInput = () => {
                 globalInventarioData = parseData(inventarioTextarea.value);
                 globalSistemaData = parseData(document.getElementById('list-sistema').value);
                 
                 document.getElementById('count-inventario').textContent = `Total de Linhas no Invent치rio: ${globalInventarioData.length}`;
                 document.getElementById('count-sistema').textContent = `Total de Linhas no Sistema: ${globalSistemaData.length}`;
                 
                 updateUnitFilter(); // Atualiza o filtro de unidade
            };
            
            inventarioTextarea.addEventListener('input', handleInput);
            sistemaTextarea.addEventListener('input', handleInput);
        }
        window.onload = setupDataListeners;

    </script>
</body>
</html>

