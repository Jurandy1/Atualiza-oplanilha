<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Quantidade - Sistema com Vincula√ß√£o Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        textarea {
            height: 250px; 
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .progress-bar {
            position: relative;
            height: 8px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 9999px;
        }

        .modal {
            transition: opacity 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #059669;
        }

        .search-box {
            transition: all 0.3s ease;
        }

        .search-box:focus-within {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            background: #1f2937;
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .pulse-warning {
            animation: pulse-warning 2s ease-in-out infinite;
        }

        .divergence-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            /* Remove pulse-warning for minor badges, keep only for cards */
        }

        @media (max-width: 640px) {
            textarea {
                height: 180px;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .highlight {
            background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        .item-divergent {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }

        .item-match {
            border-left: 4px solid #22c55e;
        }

        .item-only-inv {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
        }

        .item-only-sys {
            border-left: 4px solid #f97316;
            background: linear-gradient(90deg, rgba(249, 115, 22, 0.1) 0%, transparent 100%);
        }

        /* NOVOS ESTILOS PARA VINCULA√á√ÉO */
        .linking-mode {
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.1) 0%, transparent 100%);
            border: 2px dashed #9333ea !important;
        }

        .item-selected {
            background: #ddd6fe !important;
            border: 3px solid #9333ea !important;
            box-shadow: 0 0 20px rgba(147, 51, 234, 0.5);
            transform: scale(1.02);
        }

        .item-linked {
            border-left: 4px solid #9333ea;
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.2) 0%, transparent 100%);
        }

        .link-badge {
            background: linear-gradient(135deg, #9333ea 0%, #c084fc 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            box-shadow: 0 2px 4px rgba(147, 51, 234, 0.3);
        }

        @keyframes link-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .link-active {
            animation: link-pulse 1s ease-in-out infinite;
        }

        /* Tabela de relat√≥rio */
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th, .report-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8rem; /* Fonte menor para caber mais colunas */
        }

        .report-table th {
            background: #f3f4f6;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.7rem; /* Fonte menor para caber mais colunas */
            color: #374151;
            position: sticky; /* Fixa o cabe√ßalho ao rolar */
            top: 0;
            z-index: 10;
        }

        .report-table tr:hover {
            background: #f9fafb;
        }

        /* Novo estilo para Local Linking */
        .location-link-mode {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
            border: 2px dashed #3b82f6 !important;
        }

        .location-selected {
            background: #dbeafe !important;
            border: 3px solid #3b82f6 !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            transform: scale(1.02);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981',
                        'primary-dark': '#059669',
                        'inventario': '#3b82f6',
                        'sistema': '#f97316',
                        'export': '#d946ef',
                        'success': '#22c55e',
                        'warning': '#f59e0b',
                        'danger': '#ef4444',
                        'link': '#9333ea',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-white text-lg font-semibold">Processando dados...</p>
            <p class="text-gray-300 text-sm mt-2">Isso pode levar alguns segundos</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-2xl fade-in">
        <!-- Header -->
        <div class="mb-8 border-b-4 border-primary pb-4">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2 flex items-center gap-3">
                <span class="text-5xl">üìä</span>
                Analisador com Vincula√ß√£o Inteligente
            </h1>
            <p class="text-gray-600 text-lg">
                Sistema avan√ßado que permite vincular itens e locais com nomes diferentes
            </p>
            <div class="mt-3 flex flex-wrap gap-2">
                <span class="status-badge bg-green-100 text-green-700">‚úì Compara√ß√£o Autom√°tica</span>
                <span class="status-badge bg-blue-100 text-blue-700">‚úì Filtros Avan√ßados</span>
                <span class="status-badge bg-purple-100 text-purple-700">‚úì Vincula√ß√£o Inteligente</span>
                <span class="status-badge bg-red-100 text-red-700">‚úì Detec√ß√£o de Diverg√™ncias</span>
            </div>
        </div>

        <!-- Gerenciador de Vincula√ß√µes -->
        <div class="mb-6 p-6 bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl border-2 border-purple-300">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold text-purple-800 flex items-center gap-2">
                        <span class="text-2xl">üîó</span>
                        <span>Gerenciador de Vincula√ß√µes</span>
                    </h3>
                    <p class="text-sm text-purple-600 mt-1">Vincule locais e itens com nomes diferentes</p>
                </div>
                <button onclick="toggleLinkManager()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition">
                    Ver V√≠nculos (<span id="link-count">0</span>)
                </button>
            </div>
            <div class="flex gap-3">
                <button onclick="clearAllLinks()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition text-sm">
                    üóëÔ∏è Limpar Todas
                </button>
                <button onclick="exportLinks()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition text-sm">
                    üì• Exportar
                </button>
                <button onclick="importLinks()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition text-sm">
                    üì§ Importar
                </button>
            </div>
        </div>

        <!-- Contadores -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-xl border-2 border-blue-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-blue-600 mb-1">INVENT√ÅRIO</p>
                        <p id="count-inventario" class="text-3xl font-bold text-blue-700">0</p>
                        <p class="text-xs text-blue-600 mt-1">linhas carregadas</p>
                    </div>
                    <div class="text-5xl opacity-20">üìã</div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-xl border-2 border-orange-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-orange-600 mb-1">SISTEMA</p>
                        <p id="count-sistema" class="text-3xl font-bold text-orange-700">0</p>
                        <p class="text-xs text-orange-600 mt-1">linhas carregadas</p>
                    </div>
                    <div class="text-5xl opacity-20">‚öôÔ∏è</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Invent√°rio -->
            <div class="group">
                <label for="list-inventario" class="block text-lg font-bold text-inventario mb-3 flex items-center gap-2">
                    <span class="text-2xl">üìã</span>
                    <span>Dados do Invent√°rio</span>
                    <span class="tooltip text-gray-400 cursor-help text-sm" data-tooltip="Cole dados com: Unidade, Local, Item, Tombo e outros campos completos.">‚ÑπÔ∏è</span>
                </label>
                <div class="relative">
                    <textarea 
                        id="list-inventario" 
                        class="w-full p-4 border-2 border-inventario rounded-xl focus:ring-2 focus:ring-inventario focus:border-inventario transition duration-150 custom-scrollbar" 
                        placeholder="Cole os dados do Invent√°rio incluindo cabe√ßalho. (Campos importantes: Unidade, Local, Item, Tombo)"
                        aria-label="Dados do Invent√°rio"
                    ></textarea>
                    <div class="absolute top-2 right-2">
                        <button onclick="clearTextarea('list-inventario')" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-lg text-xs font-semibold transition">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sistema -->
            <div class="group">
                <label for="list-sistema" class="block text-lg font-bold text-sistema mb-3 flex items-center gap-2">
                    <span class="text-2xl">‚öôÔ∏è</span>
                    <span>Dados do Sistema</span>
                    <span class="tooltip text-gray-400 cursor-help text-sm" data-tooltip="Cole dados com: Unidade, Localiza√ß√£o, Descri√ß√£o, Tombamento e outros campos completos.">‚ÑπÔ∏è</span>
                </label>
                <div class="relative">
                    <textarea 
                        id="list-sistema" 
                        class="w-full p-4 border-2 border-sistema rounded-xl focus:ring-2 focus:ring-sistema focus:border-sistema transition duration-150 custom-scrollbar" 
                        placeholder="Cole os dados do Sistema incluindo cabe√ßalho. (Campos importantes: Unidade, Localiza√ß√£o, Descri√ß√£o, Tombamento)"
                        aria-label="Dados do Sistema"
                    ></textarea>
                    <div class="absolute top-2 right-2">
                        <button onclick="clearTextarea('list-sistema')" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-1 rounded-lg text-xs font-semibold transition">
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√£o de A√ß√£o -->
        <div class="mb-8">
             <button 
                onclick="runMasterCount()" 
                class="w-full px-8 py-4 bg-gradient-to-r from-primary to-primary-dark text-white font-bold text-xl rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-[1.02] flex items-center justify-center gap-3"
             >
                <span class="text-2xl">üöÄ</span>
                <span>Analisar Contagem de Itens por Local</span>
             </button>
        </div>
        
        <!-- Container de Resultados -->
        <div id="results-container" class="mt-12 hidden fade-in">
            <div class="mb-6 p-6 bg-gradient-to-r from-primary to-primary-dark rounded-xl text-white">
                <h2 id="report-title" class="text-3xl font-bold mb-2 flex items-center gap-3">
                    <span class="text-4xl">üìà</span>
                    <span>Relat√≥rio de Auditoria de Quantidade</span>
                </h2>
                <p class="text-green-100">An√°lise completa com vincula√ß√µes aplicadas</p>
            </div>

            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div id="filter-container" class="hidden">
                    <label for="unit-filter" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        üè¢ Filtrar por Unidade (Divergente)
                    </label>
                    <select 
                        id="unit-filter" 
                        class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition duration-150 bg-white font-semibold" 
                        onchange="filterResultCards(this.value)"
                    >
                        <option value="all_divergent">üåê Todas as Unidades Divergentes</option>
                    </select>
                </div>

                <div id="search-container" class="hidden">
                    <label for="local-search" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                        üîç Buscar Local
                    </label>
                    <div class="search-box relative">
                        <input 
                            type="text" 
                            id="local-search" 
                            class="w-full p-3 pl-10 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition duration-150" 
                            placeholder="Digite o nome do local..."
                            oninput="searchLocal(this.value)"
                        />
                        <span class="absolute left-3 top-3.5 text-gray-400 text-xl">üîé</span>
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-wrap gap-3 mb-6">
                 <!-- REQ 1: Novo bot√£o para Vincula√ß√£o de Local -->
                <button 
                    onclick="toggleLocalLinkingMode()" 
                    id="local-link-mode-btn" 
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] flex items-center gap-2"
                >
                    <span class="text-xl">üó∫Ô∏è</span>
                    <span>Ativar V√≠nculo de Local</span>
                </button>
                <button 
                    onclick="generateFinalReport()" 
                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white font-bold rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] flex items-center gap-2"
                >
                    <span class="text-xl">üìã</span>
                    <span>Relat√≥rio Final por Unidade</span>
                </button>
                <button 
                    onclick="exportFinalReport()" 
                    class="px-6 py-3 bg-gradient-to-r from-export to-fuchsia-600 text-white font-bold rounded-xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] flex items-center gap-2"
                >
                    <span class="text-xl">üì•</span>
                    <span>Exportar CSV de Auditoria</span>
                </button>
            </div>
            
            <!-- Resumo -->
            <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="p-6 bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl">üìã</span>
                        <span class="status-badge bg-blue-200 text-blue-700">Fonte</span>
                    </div>
                    <div class="text-4xl font-black text-blue-600 mb-2" id="summary-inv">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Total Itens (Invent√°rio)</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-blue-500" id="progress-inv" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="p-6 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl">‚öôÔ∏è</span>
                        <span class="status-badge bg-orange-200 text-orange-700">Atual</span>
                    </div>
                    <div class="text-4xl font-black text-orange-600 mb-2" id="summary-sis">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Total Itens (Sistema)</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-orange-500" id="progress-sis" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="p-6 bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-300 rounded-xl shadow-lg card-hover">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-4xl" id="diff-icon">üìä</span>
                        <span class="status-badge bg-gray-200 text-gray-700" id="diff-status">An√°lise</span>
                    </div>
                    <div class="text-4xl font-black text-gray-700 mb-2" id="summary-diff">0</div>
                    <div class="text-sm font-bold text-gray-600 uppercase tracking-wide">Diferen√ßa L√≠quida</div>
                    <div class="progress-bar mt-3">
                        <div class="progress-fill bg-gray-500" id="progress-diff" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Cards de Discrep√¢ncia (Modo Lista Agrupada - REQ 5) -->
            <div class="mb-4">
                <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <span class="text-3xl">‚ö†Ô∏è</span>
                    <span>Discrep√¢ncias Encontradas</span>
                    <span id="discrepancy-count" class="ml-auto bg-red-100 text-red-700 px-4 py-1 rounded-full font-bold text-sm">0</span>
                </h3>
                <p class="text-gray-600 mb-4">Clique nos cards para visualizar e vincular itens</p>
            </div>
            
            <p id="no-discrepancy-message" class="text-center p-8 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border-2 border-green-200 hidden">
                <span class="text-6xl mb-4 block">üéâ</span>
                <span class="text-2xl font-bold text-green-700 block mb-2">Perfeito!</span>
                <span class="text-gray-600">Nenhuma discrep√¢ncia encontrada</span>
            </p>
            
            <div id="discrepancy-cards-container" class="grid grid-cols-1 gap-6">
                <!-- Conte√∫do agora renderizado como lista agrupada por unidade -->
            </div>
        </div>
    </div>

    <!-- MODAL DE VINCULA√á√ÉO -->
    <div id="item-details-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeModal()">
        <div class="modal-content bg-white w-full max-w-6xl rounded-2xl shadow-2xl transform scale-95" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="flex justify-between items-center border-b-2 border-gray-200 p-6 bg-gradient-to-r from-primary to-primary-dark text-white rounded-t-2xl">
                <div>
                    <h2 id="modal-title" class="text-3xl font-bold">Detalhes dos Itens</h2>
                    <p id="modal-subtitle" class="text-green-100 mt-1"></p>
                </div>
                <button onclick="closeModal()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            
            <!-- Modo de Vincula√ß√£o -->
            <div id="linking-info" class="px-6 pt-4 pb-2 bg-purple-50 border-b-2 border-purple-200 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl link-active">üîó</span>
                        <div>
                            <p class="font-bold text-purple-800">Modo de Vincula√ß√£o Ativo</p>
                            <!-- REQ 3: Mensagem din√¢mica -->
                            <p class="text-sm text-purple-600">Selecione 1 item do Invent√°rio e 1 do Sistema para vincular</p>
                        </div>
                    </div>
                    <button onclick="cancelLinking()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition">
                        ‚úñ Cancelar
                    </button>
                </div>
            </div>

            <!-- Controles -->
            <div class="px-6 pt-4 pb-2">
                <div class="flex gap-3 mb-3">
                    <button onclick="toggleLinkingMode()" id="link-mode-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <span>üîó</span>
                        <span>Ativar Modo Vincula√ß√£o de Tombo</span>
                    </button>
                    <button onclick="reanalyzeWithLinks()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                        <span>üîÑ</span>
                        <span>Reanalisar com V√≠nculos</span>
                    </button>
                </div>
            </div>

            <!-- Legenda -->
            <div class="px-6 pb-2">
                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <span>üîç</span>
                        <span>LEGENDA (Itens Restantes):</span>
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                            <span class="font-semibold">Qtd Diferente</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                            <span class="font-semibold">S√≥ Invent√°rio</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
                            <span class="font-semibold">S√≥ Sistema</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-purple-500 rounded-full"></span>
                            <span class="font-semibold">Vinculado</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            <span class="font-semibold">Correto</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Busca -->
            <div class="px-6 pb-4">
                <div class="search-box relative">
                    <input 
                        type="text" 
                        id="modal-search" 
                        class="w-full p-3 pl-10 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition" 
                        placeholder="üîé Buscar item..."
                        oninput="searchModalItems(this.value)"
                    />
                    <span class="absolute left-3 top-3.5 text-gray-400 text-xl">üîç</span>
                </div>
            </div>
            
            <!-- Listas -->
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[50vh] overflow-y-auto custom-scrollbar">
                <div class="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                    <h3 id="modal-inv-title" class="text-xl font-bold text-inventario mb-3 flex items-center gap-2">
                        <span class="text-2xl">üìã</span>
                        <span>Invent√°rio (0)</span>
                    </h3>
                    <ul id="modal-inv-list" class="space-y-2 text-sm text-gray-700">
                    </ul>
                </div>
                
                <div class="bg-orange-50 rounded-xl p-5 border-2 border-orange-200">
                    <h3 id="modal-sis-title" class="text-xl font-bold text-sistema mb-3 flex items-center gap-2">
                        <span class="text-2xl">‚öôÔ∏è</span>
                        <span>Sistema (0)</span>
                    </h3>
                    <ul id="modal-sis-list" class="space-y-2 text-sm text-gray-700">
                    </ul>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span class="font-semibold">Vincula√ß√µes ativas:</span> <span id="modal-link-count">0</span>
                </div>
                <button 
                    onclick="closeModal()" 
                    class="px-8 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-xl hover:from-gray-700 hover:to-gray-800 transition duration-200 shadow-lg"
                >
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL GERENCIADOR DE LINKS -->
    <div id="link-manager-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeLinkManager()">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl transform scale-95 max-h-[80vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b-2 border-purple-200 p-6 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-t-2xl">
                <div>
                    <h2 class="text-3xl font-bold">üîó Vincula√ß√µes Salvas</h2>
                    <p class="text-purple-100 mt-1">Gerencie todos os v√≠nculos entre locais e itens</p>
                </div>
                <button onclick="closeLinkManager()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar" style="max-height: calc(80vh - 180px);">
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">V√≠nculos de Localiza√ß√£o</h3>
                <div id="local-link-list-container" class="mb-6 space-y-2">
                    <!-- Lista de V√≠nculos de Local ser√° preenchida dinamicamente -->
                </div>
                
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">V√≠nculos de Tombo/Item (Inst√¢ncias)</h3>
                <div id="item-link-list-container">
                    <!-- Lista de V√≠nculos de Item ser√° preenchida dinamicamente -->
                </div>
            </div>
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl">
                <button onclick="closeLinkManager()" class="px-8 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-xl transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL RELAT√ìRIO FINAL -->
    <div id="final-report-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeFinalReport()">
        <div class="modal-content bg-white w-full max-w-6xl rounded-2xl shadow-2xl transform scale-95" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b-2 border-purple-200 p-6 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-t-2xl">
                <div>
                    <h2 class="text-3xl font-bold">üìã Relat√≥rio Final de Auditoria</h2>
                    <p class="text-purple-100 mt-1">Exporta√ß√£o baseada no Invent√°rio, com o cabe√ßalho padr√£o do Sistema e Tombo atualizado.</p>
                </div>
                <button onclick="closeFinalReport()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>
            <div class="p-6">
                <button onclick="exportFinalReport()" class="mb-4 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition flex items-center gap-2">
                    <span>üì•</span>
                    <span>Exportar Relat√≥rio Final (CSV)</span>
                </button>
                <div id="final-report-content" class="overflow-y-auto custom-scrollbar" style="max-height: calc(90vh - 250px);">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                    <p class="text-center p-8 text-gray-500">Clique em "Relat√≥rio Final por Unidade" para gerar a pr√©via.</p>
                </div>
            </div>
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl">
                <button onclick="closeFinalReport()" class="px-8 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-xl transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE LOCAL LINKING (REQ 1 - MODO AUDITORIA) -->
     <div id="local-linking-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeLocalLinkingModal()">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl transform scale-95" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="flex justify-between items-center border-b-2 border-gray-200 p-6 bg-gradient-to-r from-inventario to-blue-700 text-white rounded-t-2xl">
                <div>
                    <h2 class="text-3xl font-bold">üó∫Ô∏è Auditoria de Local (Garantia)</h2>
                    <p class="text-blue-100 mt-1">Confirme ou corrija o mapeamento entre locais de diferentes bases.</p>
                </div>
                <button onclick="closeLocalLinkingModal()" class="text-white hover:text-gray-200 text-4xl transition-colors">
                    &times;
                </button>
            </div>

            <!-- Filtro de Unidade (REQ 1) -->
            <div class="px-6 pt-4 pb-2">
                <label for="local-unit-filter" class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wide">
                    üè¢ Selecione a Unidade para Auditar
                </label>
                <select 
                    id="local-unit-filter" 
                    class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-inventario focus:border-inventario transition duration-150 bg-white font-semibold" 
                    onchange="setupLocalLinkingModal(this.value)"
                >
                    <option value="none">Selecione a Unidade</option>
                </select>
            </div>

            <!-- Listas de Locais (REQ 1: Modo Auditoria) -->
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[50vh] overflow-y-auto custom-scrollbar">
                <div class="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                    <!-- REQ 1: Contador de Locais -->
                    <h3 class="text-xl font-bold text-inventario mb-3 flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            <span class="text-2xl">üìã</span>
                            <span>Invent√°rio (Origem)</span>
                        </span>
                        <span id="inv-local-count" class="bg-blue-300 text-blue-900 px-3 py-1 rounded-full text-sm font-bold">0 Locais</span>
                    </h3>
                    <ul id="local-inv-list" class="space-y-2 text-sm text-gray-700">
                        <li class="text-gray-500 italic p-3">Selecione uma unidade para carregar os locais.</li>
                    </ul>
                </div>
                
                <div class="bg-orange-50 rounded-xl p-5 border-2 border-orange-200">
                    <!-- REQ 1: Contador de Locais -->
                    <h3 class="text-xl font-bold text-sistema mb-3 flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            <span class="text-2xl">‚öôÔ∏è</span>
                            <span>Sistema (Destino)</span>
                        </span>
                        <span id="sis-local-count" class="bg-orange-300 text-orange-900 px-3 py-1 rounded-full text-sm font-bold">0 Locais</span>
                    </h3>
                    <ul id="local-sis-list" class="space-y-2 text-sm text-gray-700">
                        <li class="text-gray-500 italic p-3">Selecione um local √† esquerda para auditar o mapeamento, ou clique em um local aqui para definir um novo destino.</li>
                    </ul>
                </div>
            </div>
            
            <!-- Controles de A√ß√£o (REQ 1) -->
            <div class="p-6 border-t border-gray-200 bg-gray-50">
                <div id="local-linking-action-panel" class="flex flex-col gap-3">
                    <p id="current-local-status" class="text-lg font-bold text-gray-800 text-center">Selecione um local do Invent√°rio para auditar.</p>
                    
                    <div class="flex flex-wrap gap-3 justify-center">
                        <button 
                            id="btn-confirm-local"
                            onclick="confirmLocalLink()" 
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition"
                            disabled
                        >
                            ‚úÖ Confirmar V√≠nculo
                        </button>
                        <button 
                            id="btn-remove-local"
                            onclick="removeLocalLink()" 
                            class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition"
                            disabled
                        >
                            üóëÔ∏è Remover V√≠nculo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="border-t-2 border-gray-200 p-6 bg-gray-50 rounded-b-2xl flex justify-between items-center">
                <button onclick="reanalyzeWithLinks()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition">
                    üîÑ Reanalisar e Fechar
                </button>
                <button 
                    onclick="closeLocalLinkingModal()" 
                    class="px-8 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-xl hover:from-gray-700 hover:to-gray-800 transition duration-200 shadow-lg"
                >
                    Fechar
                </button>
            </div>
        </div>
    </div>


    <script>
        // === VARI√ÅVEIS GLOBAIS ===
        let auditData = [];
        let globalInventarioData = []; 
        let globalSistemaData = [];    
        let uniqueUnits = new Set();
        let discrepancyDetails = new Map(); 
        let currentSearchTerm = '';
        
        // VINCULA√á√ÉO DE ITEM/TOMBO (AGORA RASTREIA POR INSTANCE ID √öNICO)
        // itemLinks: Map<compositeKey, Map<invInstanceId, sisInstanceId>>
        let itemLinks = new Map(); 
        let itemLinkingMode = false;
        let selectedInvItem = null; // Agora armazena o instanceId
        let selectedSysItem = null; // Agora armazena o instanceId
        let currentCompositeKey = '';

        // VINCULA√á√ÉO DE LOCAL (REQ 1)
        let locationLinks = new Map(); // Map<compositeKeyInv, compositeKeySis>
        let locationLinkingMode = false;
        let currentAuditedInvKey = null; // Apenas o local do Invent√°rio sendo auditado
        let allUniqueLocations = { inv: new Map(), sis: new Map() }; // Mapa global de todos os locais √∫nicos para o modal
        let autoMapSuggestions = new Map(); // Cache para sugest√µes de auto-map

        // Cabe√ßalhos de exporta√ß√£o final (definidos pelo usu√°rio, padr√£o Sistema)
        // Usado como TEMPLATE para a exporta√ß√£o final (RESUMO)
        const FINAL_HEADERS_TEMPLATE = ['Tipo', 'Tombamento', 'Descri√ß√£o', 'Unidade', 'Quantidade', 'Localiza√ß√£o', 'Estado', 'Origem da Doa√ß√£o', 'Observa√ß√£o', 'Fornecedor'];

        // Colunas chave para busca nos dados
        const COLUMNS = {
            INV: {
                UNIT: 'unidade',
                LOCAL: 'local',
                ITEM: 'item',
                ID: 'tombo',
                STATE: 'estado de conserva√ß√£o' 
            },
            SIS: {
                UNIT: 'unidade',
                LOCAL: 'localiza√ß√£o', 
                ITEM: 'descri√ß√£o',    
                ID: 'tombamento',
                STATE: 'estado'
            }
        };

        // Carrega links do localStorage
        function loadLinksFromStorage() {
            const storedItem = localStorage.getItem('itemLinks');
            const storedLocal = localStorage.getItem('locationLinks'); 

            if (storedItem) {
                try {
                    // Item Links: Estrutura Map<compositeKey, Map<invInstanceId, sisInstanceId>>
                    const parsed = JSON.parse(storedItem);
                    itemLinks = new Map(Object.entries(parsed).map(([key, val]) => [key, new Map(Object.entries(val))]));
                } catch (e) {
                    console.error('Erro ao carregar links de item:', e);
                }
            }
             if (storedLocal) {
                try {
                    locationLinks = new Map(Object.entries(JSON.parse(storedLocal)));
                } catch (e) {
                    console.error('Erro ao carregar links de local:', e);
                }
            }

            updateLinkCount();
        }

        // Salva links no localStorage
        function saveLinksToStorage() {
            // Item Links: Converte Map<compositeKey, Map<invInstanceId, sisInstanceId>> para Objeto
            const itemObj = {};
            itemLinks.forEach((value, key) => {
                itemObj[key] = Object.fromEntries(value);
            });
            localStorage.setItem('itemLinks', JSON.stringify(itemObj));
            
            localStorage.setItem('locationLinks', JSON.stringify(Object.fromEntries(locationLinks)));

            updateLinkCount();
        }

        // Atualiza contador de links
        function updateLinkCount() {
            let total = 0;
            itemLinks.forEach(map => total += map.size);
            
            total += locationLinks.size; 

            document.getElementById('link-count').textContent = total;
            document.getElementById('modal-link-count').textContent = total;
        }

        // === FUN√á√ïES B√ÅSICAS GLOBAIS ===
        
        function showCustomConfirm(message, onConfirm) {
            // Implementa√ß√£o da fun√ß√£o showCustomConfirm
            const existingConfirm = document.getElementById('custom-confirm');
            if (existingConfirm) existingConfirm.remove();
            
            const confirmDiv = document.createElement('div');
            confirmDiv.id = 'custom-confirm';
            confirmDiv.className = 'modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300';
            
            confirmDiv.innerHTML = `
                <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl transform scale-95 transition-all duration-300 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">${message}</h3>
                    <div class="flex justify-end gap-3">
                        <button id="confirm-btn-no" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg transition">
                            Cancelar
                        </button>
                        <button id="confirm-btn-yes" class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg transition">
                            Confirmar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
            
            const modalContent = confirmDiv.querySelector('.modal-content');
            
            setTimeout(() => {
                confirmDiv.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            const closeConfirm = () => {
                confirmDiv.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => confirmDiv.remove(), 300);
            };
            
            document.getElementById('confirm-btn-yes').onclick = () => {
                onConfirm();
                closeConfirm();
            };
            document.getElementById('confirm-btn-no').onclick = closeConfirm;
        }

        function showCustomAlert(message) {
            // Implementa√ß√£o da fun√ß√£o showCustomAlert
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'modal fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300';
            
            alertDiv.innerHTML = `
                <div class="modal-content bg-white w-full max-w-md rounded-2xl shadow-2xl transform scale-95 transition-all duration-300 p-6">
                    <p class="text-gray-700 whitespace-pre-line mb-6">${message}</p>
                    <div class="flex justify-end">
                        <button id="alert-btn-ok" class="px-8 py-2 bg-primary hover:bg-primary-dark text-white font-bold rounded-lg transition">
                            OK
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            const modalContent = alertDiv.querySelector('.modal-content');
            
            setTimeout(() => {
                alertDiv.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            
            const closeAlert = () => {
                alertDiv.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => alertDiv.remove(), 300);
            };
            
            document.getElementById('alert-btn-ok').onclick = closeAlert;
        }

        
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            // APLICA TRIM e remove acentos e substitui pontua√ß√µes por espa√ßo, e espa√ßos m√∫ltiplos por um √∫nico espa√ßo
            return str
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/[-/.,;:()]/g, ' ') // Substitui pontua√ß√µes por espa√ßo
                .replace(/\s+/g, ' ')
                .trim(); // Garante que n√£o h√° espa√ßos iniciais/finais ap√≥s a limpeza
        }

        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            
            // 1. Prioriza tabula√ß√£o (copiar de planilha)
            const separators = {
                '\t': (firstLine.match(/\t/g) || []).length,
                ';': (firstLine.match(/;/g) || []).length,
                ',': (firstLine.match(/,/g) || []).length,
                '|': (firstLine.match(/\|/g) || []).length
            };
            
            let separator = '\t'; // Default to tab
            let maxCount = separators['\t'];

            // Se a tabula√ß√£o n√£o for o separador mais comum, encontra o mais comum.
            Object.keys(separators).forEach(sep => {
                if (separators[sep] > maxCount) {
                    maxCount = separators[sep];
                    separator = sep;
                }
            });
            
            if (maxCount === 0) {
                 // Se n√£o encontrou separador, a primeira linha inteira ser√° o cabe√ßalho.
                 // Isso for√ßar√° o erro de valida√ß√£o de colunas se os dados n√£o estiverem formatados.
            }
            
            const rawHeaders = lines[0].split(separator).map(h => h.trim()).filter(h => h.length > 0);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length >= rawHeaders.length && values.some(v => v !== '')) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        // Garante que se o valor estiver faltando, ele seja uma string vazia, n√£o undefined
                        item[header] = values[index] !== undefined ? values[index] : '';
                    });
                    data.push(item);
                }
            }
            
            return data;
        }

        function clearTextarea(id) {
            document.getElementById(id).value = '';
            updateDataCount();
        }

        function showLoading(show = true) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                setTimeout(() => overlay.classList.add('hidden'), 500);
            }
        }

        function updateDataCount() {
            const invTextarea = document.getElementById('list-inventario');
            const sistemaTextarea = document.getElementById('list-sistema');
            
            const invLines = invTextarea.value.trim().split('\n').filter(Boolean).length;
            const sisLines = sistemaTextarea.value.trim().split('\n').filter(Boolean).length;
            
            const invCount = Math.max(0, invLines - 1);
            const sisCount = Math.max(0, sisLines - 1);
            
            document.getElementById('count-inventario').textContent = invCount;
            document.getElementById('count-sistema').textContent = sisCount;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // === FUN√á√ïES DO GERENCIADOR DE LINKS (CORRE√á√ÉO DE BUGS DE LIMPEZA/DELETAR/EXPORTAR/IMPORTAR) ===

        function clearAllLinks() {
            showCustomConfirm("Tem certeza que deseja limpar TODAS as vincula√ß√µes de Itens e Locais salvas? Isso n√£o pode ser desfeito.", () => {
                itemLinks = new Map();
                locationLinks = new Map();
                saveLinksToStorage();
                updateLinkCount();
                closeLinkManager();
                // A fun√ß√£o `closeLinkManager` garante que o modal estar√° fechado.
                showCustomAlert("‚úÖ Todas as vincula√ß√µes foram removidas. Execute a An√°lise para atualizar o relat√≥rio.");
            });
        }
        
        function exportLinks() {
            const dataToExport = {
                // Converte Map<compositeKey, Map<invInstanceId, sisInstanceId>> para Objeto aninhado para exporta√ß√£o JSON
                itemLinks: Object.fromEntries([...itemLinks].map(([key, map]) => [key, Object.fromEntries(map)])),
                locationLinks: Object.fromEntries(locationLinks)
            };
            
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vinculos_auditoria.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showCustomAlert('üì• V√≠nculos exportados como vinculos_auditoria.json');
        }

        function importLinks() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        let linksLoaded = 0;
                        
                        if (data.itemLinks) {
                            // Item Links: Converte Objeto aninhado de volta para Map<compositeKey, Map<invInstanceId, sisInstanceId>>
                            itemLinks = new Map(Object.entries(data.itemLinks).map(([key, val]) => {
                                linksLoaded += Object.keys(val).length;
                                return [key, new Map(Object.entries(val))];
                            }));
                        } else {
                            itemLinks = new Map();
                        }
                        
                        if (data.locationLinks) {
                            locationLinks = new Map(Object.entries(data.locationLinks));
                            linksLoaded += locationLinks.size;
                        } else {
                            locationLinks = new Map();
                        }
                        
                        saveLinksToStorage();
                        updateLinkCount();
                        
                        if (linksLoaded > 0) {
                            showCustomAlert(`üì§ ${linksLoaded} v√≠nculos importados com sucesso! Execute a An√°lise para aplicar no relat√≥rio.`);
                        } else {
                            showCustomAlert(`‚ÑπÔ∏è Nenhum v√≠nculo encontrado no arquivo importado. As vincula√ß√µes atuais foram limpas.`);
                        }

                    } catch (error) {
                        showCustomAlert(`‚ùå Erro ao processar o arquivo JSON: O arquivo pode estar corrompido ou no formato incorreto. Erro: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }
        
        // Fun√ß√£o para remover um √∫nico link (chamada do Gerenciador de Links)
        function removeLink(type, key1) {
            // type: 'item|compositeKey' ou 'LOCAL_LINK'
            // key1: invInstanceId (para item) ou invKey (para local)

            if (type.startsWith('item|')) {
                const compositeKey = type.split('|')[1];
                if (itemLinks.has(compositeKey)) {
                    const locationLinksMap = itemLinks.get(compositeKey); // Map<invInstanceId, sisInstanceId>
                    // key1 √© o invInstanceId
                    locationLinksMap.delete(key1); 
                    if (locationLinksMap.size === 0) {
                        itemLinks.delete(compositeKey);
                    }
                }
            } else if (type === 'LOCAL_LINK') {
                // key1 √© o invKey
                locationLinks.delete(key1);
            }

            saveLinksToStorage();
            updateLinkManagerDisplay(); // Atualiza o modal de gerenciamento
            showCustomAlert('üóëÔ∏è V√≠nculo removido com sucesso! Execute a An√°lise para atualizar o relat√≥rio.');
        }

        // NOVO: Fun√ß√£o para validar se o ID √© um Tombo (apenas n√∫meros, com toler√¢ncia a separadores)
        function isValidTombo(id) {
            if (typeof id !== 'string') return false;
            const trimmedId = id.trim();
            const normalized = normalizeString(trimmedId);

            // 1. Regras de exclus√£o estritas (palavras ou c√≥digos √≥bvios)
            // Se o usu√°rio colou Permuta, S/T, s/t, etc., ignora.
            if (normalized === 's t' || normalized === 'st' || normalized === 'permuta' || normalized.includes('nao tem') || normalized === 's' || normalized === 't') {
                return false;
            }

            // 2. Regra de inclus√£o: Deve conter pelo menos um d√≠gito e ser composto majoritariamente por caracteres num√©ricos ou delimitadores de n√∫mero (., -).
            // A regra do usu√°rio √© "Tombos s√£o s√≥ NUMEROS." - Aceita apenas n√∫meros, e separa/pontua√ß√µes que acompanham n√∫meros.
            return /^[0-9\.\-]*[0-9]+[0-9\.\-]*$/.test(trimmedId);
        }

        // === AN√ÅLISE PRINCIPAL ===
        
        async function runMasterCount() {
            showLoading(true);
            document.getElementById('results-container').classList.add('hidden');
            await new Promise(resolve => setTimeout(resolve), 100);
            
            try {
                globalInventarioData = parseData(document.getElementById('list-inventario').value);
                globalSistemaData = parseData(document.getElementById('list-sistema').value);
                
                if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                    showCustomAlert("‚ö†Ô∏è Por favor, cole os dados antes de analisar.");
                    showLoading(false);
                    return;
                }

                await processAuditData();
                
                document.getElementById('results-container').classList.remove('hidden');
                document.getElementById('filter-container').classList.remove('hidden');
                document.getElementById('search-container').classList.remove('hidden');
                
                populateUnitFilter(); 
                document.getElementById('unit-filter').value = 'all_divergent';
                document.getElementById('local-search').value = '';
                
                filterResultCards('all_divergent');
                showLoading(false);
                
                setTimeout(() => {
                    document.getElementById('results-container').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);
                
            } catch (error) { 
                console.error('Erro:', error);
                showCustomAlert(`‚ùå Erro ao processar: ${error.message}`);
                showLoading(false);
            }
        }

        function findColumn(headers, key) {
             // Normaliza a chave buscada para compara√ß√£o
             const normalizedKey = normalizeString(key);
             
             // 1. Tenta encontrar a chave exata (mesmo com case-insensibilidade/acentos)
             let found = headers.find(h => normalizeString(h) === normalizedKey);
             if (found) return found;
             
             // 2. Se n√£o encontrou, busca a coluna que contenha a palavra-chave (mais robusto)
             found = headers.find(h => normalizeString(h).includes(normalizedKey));
             if (found) return found;
             
             // 3. Busca a chave que o usu√°rio pode ter colado de forma compacta (ex: 'Localizacao' em 'TipoTombamentoLocalizacao')
             // Esta √© uma busca arriscada, mas necess√°ria para dados mal formatados
             if (normalizedKey.length > 0) {
                for (const header of headers) {
                    const normalizedHeader = normalizeString(header);
                    if (normalizedHeader.includes(normalizedKey)) {
                         return header;
                    }
                }
             }

             return null;
        }

        // Processa dados e aplica Vincula√ß√£o de Local (REQ 1)
        async function processAuditData() {
            const inventarioMap = new Map();
            const sistemaMap = new Map();
            const allCompositeKeys = new Set();
            discrepancyDetails.clear();
            
            const invHeader = globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : [];
            const sisHeader = globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : [];
            
            const invUnitCol = findColumn(invHeader, COLUMNS.INV.UNIT);
            const invLocalCol = findColumn(invHeader, COLUMNS.INV.LOCAL);
            const invItemCol = findColumn(invHeader, COLUMNS.INV.ITEM);
            const invIdCol = findColumn(invHeader, COLUMNS.INV.ID);     
            const invStateCol = findColumn(invHeader, COLUMNS.INV.STATE); 
            
            const sisUnitCol = findColumn(sisHeader, COLUMNS.SIS.UNIT);
            const sisLocalCol = findColumn(sisHeader, COLUMNS.SIS.LOCAL);
            const sisItemCol = findColumn(sisHeader, COLUMNS.SIS.ITEM);
            const sisIdCol = findColumn(sisHeader, COLUMNS.SIS.ID);     
            const sisStateCol = findColumn(sisHeader, COLUMNS.SIS.STATE); 
            
            // 1. Valida√ß√£o de Colunas
            if (globalInventarioData.length > 0 && !invLocalCol) throw new Error(`Coluna 'Local' (${COLUMNS.INV.LOCAL}) n√£o encontrada no Invent√°rio. Cabe√ßalhos encontrados: [${invHeader.join(', ')}]`);
            if (globalInventarioData.length > 0 && !invIdCol) throw new Error(`Coluna 'Tombo' (${COLUMNS.INV.ID}) n√£o encontrada no Invent√°rio. Cabe√ßalhos encontrados: [${invHeader.join(', ')}]`);
            if (globalSistemaData.length > 0 && !sisLocalCol) throw new Error(`Coluna 'Localiza√ß√£o' (${COLUMNS.SIS.LOCAL}) n√£o encontrada no Sistema. Cabe√ßalhos encontrados: [${sisHeader.join(', ')}]`);
            if (globalSistemaData.length > 0 && !sisIdCol) throw new Error(`Coluna 'Tombamento' (${COLUMNS.SIS.ID}) n√£o encontrada no Sistema. Cabe√ßalhos encontrados: [${sisHeader.join(', ')}]`);


            // 2. Pr√©-coleta de Locais √önicos (para o Modal de Local Linking)
            allUniqueLocations = { inv: new Map(), sis: new Map() };
            
            // ATUALIZA√á√ÉO PRINCIPAL: Usa isValidTombo na coleta de Locais √önicos
            globalInventarioData.forEach(item => {
                const tombo = invIdCol ? (item[invIdCol] || '').trim() : '';
                // Condi√ß√£o de filtro: S√ì CONSIDERA para a contagem/local se tiver Tombo v√°lido (n√∫mero)
                if (isValidTombo(tombo)) { 
                    const unidade = invUnitCol ? (item[invUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                    const local = invLocalCol ? (item[invLocalCol] || 'Sem Local').trim() : 'Sem Local';
                    // CRIA A CHAVE NORMALIZADA (UNIFICANDO AS DUPLICA√á√ïES)
                    const key = `${normalizeString(unidade)}|${normalizeString(local)}`;
                    if (local !== 'Sem Local' && !allUniqueLocations.inv.has(key)) {
                        allUniqueLocations.inv.set(key, { unit: unidade, local: local, key: key });
                    }
                }
            });
            globalSistemaData.forEach(item => {
                const unidade = sisUnitCol ? (item[sisUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                const local = sisLocalCol ? (item[sisLocalCol] || 'Sem Local').trim() : 'Sem Local';
                 // CRIA A CHAVE NORMALIZADA (UNIFICANDO AS DUPLICA√á√ïES)
                const key = `${normalizeString(unidade)}|${normalizeString(local)}`;
                if (local !== 'Sem Local' && !allUniqueLocations.sis.has(key)) {
                    allUniqueLocations.sis.set(key, { unit: unidade, local: local, key: key });
                }
            });


            // 3. Processamento e Aplica√ß√£o de V√≠nculos de Local
            let invItemCount = 0;
            globalInventarioData.forEach(item => {
                const tombo = invIdCol ? (item[invIdCol] || '').trim() : '';
                
                // NOVO FILTRO APLICADO AQUI: S√ì PROCESSA ITENS COM TOMBO V√ÅLIDO PARA AUDITORIA
                if (!isValidTombo(tombo)) {
                    // Adiciona um __instanceId para o item SEM Tombo, para fins de exporta√ß√£o final
                    item.__instanceId = `inv-${Date.now()}-${invItemCount}-${Math.floor(Math.random() * 10000)}`;
                    invItemCount++;
                    return; // Ignora itens do Invent√°rio sem Tombo v√°lido
                }
                
                const unidade = invUnitCol ? normalizeString(item[invUnitCol] || 'sem unidade') : 'sem unidade';
                const local = invLocalCol ? (item[invLocalCol] || 'sem local').trim() : 'sem local';
                
                const invCompositeKey = `${unidade}|${normalizeString(local)}`;
                const mappedSisCompositeKey = locationLinks.get(invCompositeKey);
                
                // A chave de compara√ß√£o √© a chave do sistema mapeada, ou a pr√≥pria chave do invent√°rio (se n√£o houver link)
                const compositeKey = mappedSisCompositeKey || invCompositeKey;
                
                const localOriginal = local; 
                const itemId = tombo;
                
                allCompositeKeys.add(compositeKey);
                
                if (!inventarioMap.has(compositeKey)) {
                    inventarioMap.set(compositeKey, { 
                        count: 0, 
                        items: [],
                        originalUnit: item[invUnitCol] || 'Sem Unidade', 
                        originalLocal: localOriginal || 'Sem Local',
                        actualInvKey: invCompositeKey
                    });
                }
                const data = inventarioMap.get(compositeKey);
                data.count++;
                invItemCount++;
                
                // BUG FIX 2: Adiciona um ID de inst√¢ncia √∫nico para permitir vincula√ß√£o granular
                const instanceId = `inv-${Date.now()}-${data.count}-${Math.floor(Math.random() * 10000)}`;
                item.__instanceId = instanceId; // Armazena no objeto original para rastreamento
                data.items.push({ 
                    instanceId: instanceId, 
                    itemId: itemId, 
                    data: item, 
                    description: invItemCol ? (item[invItemCol] || `Item sem Descri√ß√£o - ${itemId}`).trim() : `Item sem Descri√ß√£o - ${itemId}`,
                    state: invStateCol ? (item[invStateCol] || '-').trim() : '-' 
                });
            });
            
            // O Sistema n√£o tem filtro de "S/T", pois a aus√™ncia de Tombo nele j√° indica um problema (S√≥ Sistema).
            let sisItemCount = 0;
            globalSistemaData.forEach(item => {
                const unidade = sisUnitCol ? normalizeString(item[sisUnitCol] || 'sem unidade') : 'sem unidade';
                const local = sisLocalCol ? (item[sisLocalCol] || 'sem local').trim() : 'sem local'; 
                const compositeKey = `${unidade}|${normalizeString(local)}`;
                
                const localOriginal = local; 
                const itemId = sisIdCol ? (item[sisIdCol] || `Item sem Tombo Sis-${Math.random()}`).trim() : `Item sem Tombo Sis-${Math.random()}`;

                allCompositeKeys.add(compositeKey);

                if (!sistemaMap.has(compositeKey)) {
                    sistemaMap.set(compositeKey, { 
                        count: 0, 
                        items: [],
                        originalUnit: item[sisUnitCol] || 'Sem Unidade', 
                        originalLocal: localOriginal || 'Sem Local' ,
                        actualSisKey: compositeKey
                    });
                }
                const data = sistemaMap.get(compositeKey);
                
                data.count++;
                sisItemCount++;

                // BUG FIX 2: Adiciona um ID de inst√¢ncia √∫nico para permitir vincula√ß√£o granular
                const instanceId = `sis-${Date.now()}-${data.count}-${Math.floor(Math.random() * 10000)}`;
                item.__instanceId = instanceId; // Armazena no objeto original para rastreamento
                data.items.push({ 
                    instanceId: instanceId, 
                    itemId: itemId, 
                    data: item,
                    description: sisItemCol ? (item[sisItemCol] || `Item sem Descri√ß√£o - ${itemId}`).trim() : `Item sem Descri√ß√£o - ${itemId}`,
                    state: sisStateCol ? (item[sisStateCol] || '-').trim() : '-' 
                });
            });

            const sortedKeys = [...allCompositeKeys].sort();

            // 4. Auditoria de Diverg√™ncias (REQ 4: Locais sem diverg√™ncia n√£o s√£o adicionados)
            auditData = [];
            for (const compositeKey of sortedKeys) {
                if (compositeKey === "sem unidade|sem local") continue;

                const invData = inventarioMap.get(compositeKey) || { count: 0, items: [], originalUnit: '', originalLocal: '', actualInvKey: '' };
                const sisData = sistemaMap.get(compositeKey) || { count: 0, items: [], originalUnit: '', originalLocal: '', actualSisKey: '' };
                
                // NOVO: A contagem agora reflete apenas itens com Tombo v√°lido no Invent√°rio
                const qtdInv = invData.count; 
                const qtdSis = sisData.count; 
                const diff = qtdInv - qtdSis;

                let hasQuantityDivergence = diff !== 0;
                let hasTombamentoDivergence = false;

                // CRITICAL FIX: Filtra IDs "S/T" ou vazios da verifica√ß√£o de duplicidade de Tombo.
                const invIds = new Set(invData.items
                    .filter(i => isValidTombo(i.itemId)) // Filtro redundante, mas garante
                    .map(i => normalizeString(i.itemId)));

                const sisIds = new Set(sisData.items
                    .filter(i => isValidTombo(i.itemId)) // Apenas Tombos V√°lidos no Sistema
                    .map(i => normalizeString(i.itemId)));


                if (qtdInv > 0 || qtdSis > 0) {
                    // IMPLEMENTA√á√ÉO DA L√ìGICA DO USU√ÅRIO: A diverg√™ncia de Tombo s√≥ √© marcada se houver Tombo no Invent√°rio que n√£o est√° no Sistema.
                    // Isso ignora Tombos "sobrando" no Sistema e diferen√ßas em Tombos quando a QTD bate.
                    let invOnlyTombo = [...invIds].some(id => !sisIds.has(id)); 
                    
                    // hasTombamentoDivergence √© True se um Tombo do Invent√°rio est√° faltando no Sistema
                    hasTombamentoDivergence = invOnlyTombo; 

                    // Se a Qtd for a mesma, mas os Tombos do Sis tivessem sobrado (Tombo no Sis que n√£o est√° no Inv), isso seria ignorado aqui, 
                    // a n√£o ser que a Qtd n√£o batesse (hasQuantityDivergence) - o que √© o comportamento desejado pelo usu√°rio.
                }
                
                if (hasQuantityDivergence || hasTombamentoDivergence) {
                    const auditRow = {
                        key: compositeKey,
                        unidade: invData.originalUnit || sisData.originalUnit,
                        local: invData.originalLocal || sisData.originalLocal,
                        originalUnit: invData.originalUnit || sisData.originalUnit,
                        originalLocal: invData.originalLocal || sisData.originalLocal,
                        // BUG FIX 1: Adiciona chave de unidade normalizada para filtragem
                        // CORRIGIDO: Utiliza a chave armazenada em invData.actualInvKey, ou a chave composta se for item S√ì do Sistema.
                        normalizedUnitKey: (invData.actualInvKey || compositeKey).split('|')[0], 
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    };
                    auditData.push(auditRow);
                    
                    discrepancyDetails.set(compositeKey, {
                        unidade: auditRow.originalUnit,
                        normalizedUnitKey: auditRow.normalizedUnitKey, // BUG FIX 1
                        local: auditRow.originalLocal,
                        invItems: invData.items.sort((a, b) => a.itemId.localeCompare(b.itemId)), 
                        sisItems: sisData.items.sort((a, b) => a.itemId.localeCompare(b.itemId)),  
                        hasQuantityDivergence: hasQuantityDivergence,
                        hasTombamentoDivergence: hasTombamentoDivergence,
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    });
                }
            }
        }

        // NOVO: Fun√ß√£o para obter status final de um item do invent√°rio
        // Recebe o mapa de Tombos dispon√≠veis do Sistema (para match impl√≠cito)
        function getFinalStatus(invItemInstance, compositeKey, availableSysTombos) {
            const invTombo = normalizeString(invItemInstance.itemId);
            
            // 1. Checa se o item foi explicitamente vinculado (via itemLinks)
            const locationLinksMap = itemLinks.get(compositeKey) || new Map();
            const linkedSisId = locationLinksMap.get(invItemInstance.instanceId);
            
            if (linkedSisId) {
                // Remove o item vinculado do mapa de sistema para que ele n√£o seja contado como dispon√≠vel/sobra
                // O linkedSisId √© um instanceId. Procuramos o Tombo ID correspondente no mapa de availableSysTombos.
                let matchedSysTombo = 'N/A';
                
                for(const [tomboKey, instanceIds] of availableSysTombos.entries()) {
                    const index = instanceIds.indexOf(linkedSisId);
                    if (index > -1) {
                        matchedSysTombo = tomboKey; // Encontrou o Tombo normalizado
                        instanceIds.splice(index, 1); // Remove o instanceId do array de dispon√≠veis
                        if (instanceIds.length === 0) {
                            availableSysTombos.delete(tomboKey);
                        }
                        break;
                    }
                }
                
                // O Tombo Aplicado deve ser o Tombo ORIGINAL do Sistema, n√£o o normalizado
                const linkedSysItem = globalSistemaData.find(item => item.__instanceId === linkedSisId);
                const sisIdCol = globalSistemaData.length > 0 ? findColumn(Object.keys(globalSistemaData[0]), COLUMNS.SIS.ID) : null;
                const newTombo = linkedSysItem && sisIdCol ? (linkedSysItem[sisIdCol] || 'N/A') : 'N/A';

                // Encontrado e Vinculado
                return { 
                    status: 'Vinculado', 
                    newTombo: newTombo,
                    sisKey: linkedSisId
                };
            }
            
            // 2. Checa se o Tombo faz um match direto (impl√≠cito) e est√° dispon√≠vel
            if (availableSysTombos.has(invTombo) && availableSysTombos.get(invTombo).length > 0) {
                // Pega a primeira inst√¢ncia dispon√≠vel para este Tombo
                const sisInstanceId = availableSysTombos.get(invTombo).shift(); 
                
                // Se a lista de inst√¢ncias para este Tombo ficar vazia, remove a chave
                if (availableSysTombos.get(invTombo).length === 0) {
                    availableSysTombos.delete(invTombo);
                }

                // O Tombo Aplicado deve ser o Tombo ORIGINAL do Sistema, n√£o o normalizado
                const matchedSysItem = globalSistemaData.find(item => item.__instanceId === sisInstanceId);
                const sisIdCol = globalSistemaData.length > 0 ? findColumn(Object.keys(globalSistemaData[0]), COLUMNS.SIS.ID) : null;
                const newTombo = matchedSysItem && sisIdCol ? (matchedSysItem[sisIdCol] || 'N/A') : 'N/A';
                
                // Encontrado por Tombo (Match)
                return { 
                    status: 'Encontrado', 
                    newTombo: newTombo,
                    sisKey: sisInstanceId
                };
            }
            
            // 3. Faltante
            return { 
                status: 'Faltante', 
                newTombo: invItemInstance.itemId,
                sisKey: 'N/A' 
            };
        }

        // NOVO: Fun√ß√£o que gera o relat√≥rio final (dados processados)
        async function generateFinalReport() {
            showLoading(true);
            await new Promise(resolve => setTimeout(resolve, 100)); // Delay para mostrar loading
            
            try {
                // Re-executa a auditoria para garantir que os dados e v√≠nculos mais recentes sejam usados
                await processAuditData(); 
                
                const invHeader = globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : [];
                
                // Mapeamento das colunas do Invent√°rio (para extrair os dados)
                const invUnitCol = findColumn(invHeader, COLUMNS.INV.UNIT);
                const invLocalCol = findColumn(invHeader, COLUMNS.INV.LOCAL);
                const invItemCol = findColumn(invHeader, COLUMNS.INV.ITEM);
                const invIdCol = findColumn(invHeader, COLUMNS.INV.ID);     
                const invStateCol = findColumn(invHeader, COLUMNS.INV.STATE); 
                
                // Mapeamento de colunas "extras" que podem existir no Invent√°rio
                // Tenta encontrar um match aproximado dos campos do template final no Invent√°rio
                const invTipoCol = findColumn(invHeader, 'tipo');
                const invQtdCol = findColumn(invHeader, 'quantidade');
                const invOrigemCol = findColumn(invHeader, 'origem da doa√ß√£o');
                const invObsCol = findColumn(invHeader, 'observa√ß√£o');
                const invFornCol = findColumn(invHeader, 'fornecedor');

                const sisIdCol = globalSistemaData.length > 0 ? findColumn(Object.keys(globalSistemaData[0]), COLUMNS.SIS.ID) : null;     
                
                // 1. Criar um mapa de Tombos dispon√≠veis no Sistema (Tombo normalizado -> Lista de instanceIds)
                const availableSysTombos = new Map(); // Map<normalizedTombo, List<instanceId>>
                
                globalSistemaData.forEach(item => {
                    // ATEN√á√ÉO: Se o item do Sistema n√£o tem Tombo, ele n√£o entra no pool de match Tombo-a-Tombo
                    const id = sisIdCol ? (item[sisIdCol] || '').trim() : '';
                    if (isValidTombo(id)) { // S√≥ considera Tombos v√°lidos (numericos) do Sistema
                        const normalizedId = normalizeString(id);
                        if (!availableSysTombos.has(normalizedId)) {
                            availableSysTombos.set(normalizedId, []);
                        }
                        // O __instanceId foi preenchido por processAuditData
                        const instanceId = item.__instanceId; 
                        availableSysTombos.get(normalizedId).push(instanceId);
                    }
                });

                // 2. Processar TODOS os itens do Invent√°rio (base do relat√≥rio final)
                const finalReportData = [];
                
                globalInventarioData.forEach(item => {
                    const instanceId = item.__instanceId; // Deve estar preenchido por processAuditData
                    const tombo = invIdCol ? (item[invIdCol] || '').trim() : '';
                    const isTomboValid = isValidTombo(tombo);
                    
                    const unidade = invUnitCol ? (item[invUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                    const local = invLocalCol ? (item[invLocalCol] || 'Sem Local').trim() : 'Sem Local';
                    
                    // L√≥gica para determinar a chave composta de compara√ß√£o (aplica link de local)
                    const invCompositeKey = `${normalizeString(unidade)}|${normalizeString(local)}`;
                    const mappedSisCompositeKey = locationLinks.get(invCompositeKey);
                    const finalCompositeKey = mappedSisCompositeKey || invCompositeKey;
                    
                    const invItemInstance = {
                        instanceId: instanceId,
                        itemId: tombo, 
                        data: item,
                        isTomboValid: isTomboValid,
                        compositeKey: finalCompositeKey,
                        originalLocal: local
                    };
                    
                    let statusResult = { 
                        status: 'Sem Tombo V√°lido', 
                        newTombo: tombo 
                    };

                    if (isTomboValid) {
                        // Item com Tombo V√°lido: Checar status
                        statusResult = getFinalStatus(invItemInstance, finalCompositeKey, availableSysTombos);
                    }
                    
                    // --- Mapeamento para o Cabe√ßalho Padr√£o do Sistema (FINAL_HEADERS_TEMPLATE) ---
                    const finalItem = {
                        // 1. Campos principais mapeados do Invent√°rio para o padr√£o do Sistema
                        'Tipo': invTipoCol ? item[invTipoCol] : '',
                        'Tombamento': statusResult.newTombo, // O NOVO TOMBO APLICADO (o grande update)
                        'Descri√ß√£o': invItemCol ? item[invItemCol] : '',
                        'Unidade': unidade,
                        // Assume 1 se a coluna QTD n√£o for encontrada ou estiver vazia
                        'Quantidade': invQtdCol && item[invQtdCol] ? item[invQtdCol] : '1', 
                        'Localiza√ß√£o': local,
                        'Estado': invStateCol ? item[invStateCol] : '',
                        // 2. Campos extras
                        'Origem da Doa√ß√£o': invOrigemCol ? item[invOrigemCol] : '',
                        'Observa√ß√£o': invObsCol ? item[invObsCol] : '',
                        'Fornecedor': invFornCol ? item[invFornCol] : '',
                        // 3. Colunas de Status de Auditoria
                        'TOMBO_ORIGINAL': tombo,
                        'STATUS_FINAL': statusResult.status,
                        'ORIGEM_LOCAL_VINCULADA': invItemInstance.originalLocal,
                    };
                    
                    finalReportData.push(finalItem);
                });

                // 3. Montar a Tabela HTML para o modal (Op√ß√£o 1)
                const exportHeaders = [...FINAL_HEADERS_TEMPLATE, 'TOMBO_ORIGINAL', 'STATUS_FINAL', 'ORIGEM_LOCAL_VINCULADA'];
                renderFinalReportTable(finalReportData, exportHeaders);
                
                // 4. Exibir o modal
                openFinalReport();

            } catch (error) {
                console.error('Erro ao gerar relat√≥rio final:', error);
                showCustomAlert(`‚ùå Erro ao gerar relat√≥rio final: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        // NOVO: Renderiza a tabela do relat√≥rio final no modal
        function renderFinalReportTable(data, headers) {
            const container = document.getElementById('final-report-content');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<p class="text-center p-8 text-gray-500">Nenhum dado do Invent√°rio para gerar o relat√≥rio.</p>';
                return;
            }

            // Define os cabe√ßalhos de exibi√ß√£o (passados por generateFinalReport)
            const exportHeaders = headers; 
            
            let html = '<div class="overflow-x-auto custom-scrollbar" style="max-height: calc(90vh - 250px);">';
            html += '<table class="report-table">';
            
            // Cabe√ßalho da tabela
            html += '<thead><tr>';
            exportHeaders.forEach(h => {
                // Destaca as colunas de status no cabe√ßalho
                const isStatusColumn = h.includes('TOMBO_ORIGINAL') || h.includes('STATUS_FINAL') || h.includes('ORIGEM_LOCAL_VINCULADA');
                // Destaca o Tombamento e Localiza√ß√£o como chave do sistema
                const isSystemKey = h === 'Tombamento' || h === 'Localiza√ß√£o' || h === 'Descri√ß√£o' || h === 'Unidade' || h === 'Estado';
                
                let colorClass = 'bg-gray-200 text-gray-700';
                if (isStatusColumn) {
                    colorClass = 'bg-purple-600 text-white';
                } else if (isSystemKey) {
                    colorClass = 'bg-gray-300 text-gray-800'; // Cor mais escura para o padr√£o do Sistema
                }

                html += `<th class="${colorClass} sticky top-0">${h.toUpperCase()}</th>`;
            });
            html += '</tr></thead>';

            // Corpo da tabela
            html += '<tbody>';
            data.forEach(item => {
                let rowClass = 'hover:bg-gray-100';
                // Mant√©m o destaque visual para o status
                if (item['STATUS_FINAL'] === 'Faltante') {
                    rowClass = 'bg-red-50 hover:bg-red-100 text-red-700 font-semibold';
                } else if (item['STATUS_FINAL'] === 'Vinculado') {
                    rowClass = 'bg-purple-50 hover:bg-purple-100 text-purple-700';
                } else if (item['STATUS_FINAL'] === 'Encontrado') {
                     rowClass = 'bg-green-50 hover:bg-green-100 text-green-700';
                } else if (item['STATUS_FINAL'] === 'Sem Tombo V√°lido') {
                     rowClass = 'bg-gray-100 hover:bg-gray-200 text-gray-500 italic';
                }
                
                html += `<tr class="${rowClass}">`;
                exportHeaders.forEach(h => {
                    let cellValue = item[h] !== undefined ? item[h] : '';
                    
                    if (h === 'STATUS_FINAL') {
                         cellValue = `<span class="px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap" style="background-color: ${
                            item[h] === 'Faltante' ? '#fecaca' : 
                            item[h] === 'Vinculado' ? '#e9d5ff' : 
                            item[h] === 'Encontrado' ? '#dcfce7' : '#f3f4f6'
                         }; color: ${
                            item[h] === 'Faltante' ? '#dc2626' : 
                            item[h] === 'Vinculado' ? '#9333ea' : 
                            item[h] === 'Encontrado' ? '#16a34a' : '#4b5563'
                         };">${item[h].toUpperCase()}</span>`;
                    }
                    
                    html += `<td class="whitespace-nowrap">${cellValue}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            container.innerHTML = html;
        }

        // NOVO: Abre o modal do relat√≥rio final
        function openFinalReport() {
            const modal = document.getElementById('final-report-modal');
            const modalContent = modal.querySelector('.modal-content');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        // NOVO: Fecha o modal do relat√≥rio final
        function closeFinalReport() {
            const modal = document.getElementById('final-report-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // NOVO: Exporta o relat√≥rio final (CSV)
        async function exportFinalReport() {
             showLoading(true);
             // Re-executa o processamento para garantir que a lista `finalReportData` seja populada
             // Isso pode ser demorado, por isso est√° no in√≠cio
             await generateFinalReport(); 
             
             try {
                const container = document.getElementById('final-report-content');
                const table = container.querySelector('.report-table');
                
                if (!table) {
                    showCustomAlert("‚ö†Ô∏è Nenhum dado de relat√≥rio para exportar. Gere o relat√≥rio primeiro.");
                    return;
                }

                let csv = [];
                const rows = table.querySelectorAll('tr');

                rows.forEach((row, rowIndex) => {
                    const cells = row.querySelectorAll('th, td');
                    const rowData = [];
                    cells.forEach(cell => {
                        let text;
                        if (rowIndex === 0) { // Cabe√ßalho
                            text = cell.textContent.trim();
                        } else { // Dados
                            const span = cell.querySelector('span');
                            // Se for um status badge, pega o texto do span, sen√£o pega o texto da c√©lula
                            text = span ? span.textContent.trim() : cell.textContent.trim(); 
                        }
                        
                        // Remove quebras de linha e trata a formata√ß√£o CSV
                        text = text.replace(/"/g, '""'); // Escape double quotes
                        if (text.includes(';') || text.includes('\n') || text.includes('"')) {
                            text = `"${text}"`; // Enclose in quotes if necessary
                        }
                        rowData.push(text);
                    });
                    csv.push(rowData.join(';')); // Usa ponto e v√≠rgula como separador
                });

                const csvString = csv.join('\n');
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' }); // Adiciona BOM para caracteres especiais
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'relatorio_final_auditoria.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showCustomAlert('üì• Relat√≥rio Final exportado com sucesso como CSV.');
             } catch (error) {
                 console.error('Erro ao exportar relat√≥rio:', error);
                 showCustomAlert(`‚ùå Erro ao exportar relat√≥rio: ${error.message}`);
             } finally {
                 showLoading(false);
             }
        }
        
        // NOVO: Fun√ß√£o para reanalisar e fechar o modal (usada no modal de vincula√ß√£o de local e item)
        async function reanalyzeWithLinks() {
            closeLocalLinkingModal();
            closeModal();
            await runMasterCount();
            showCustomAlert('üîÑ Rean√°lise completa! Verifique o relat√≥rio atualizado.');
        }

        // Fun√ß√µes do arquivo original (mantidas)

        function populateUnitFilter() {
            const uniqueNormalizedUnits = new Map(); // Map<normalizedKey, originalName>
            const filterSelect = document.getElementById('unit-filter');
            
            discrepancyDetails.forEach(details => {
                const normalizedKey = details.normalizedUnitKey;
                if (!uniqueNormalizedUnits.has(normalizedKey)) {
                     uniqueNormalizedUnits.set(normalizedKey, details.unidade);
                }
            });

            uniqueNormalizedUnits.delete('');
            uniqueNormalizedUnits.delete('sem unidade');

            filterSelect.innerHTML = ''; 

            const allOption = document.createElement('option');
            allOption.value = "all_divergent";
            allOption.textContent = "üåê Todas as Unidades Divergentes";
            filterSelect.appendChild(allOption);
            
            const sortedKeys = [...uniqueNormalizedUnits.keys()].sort();
            sortedKeys.forEach(normKey => {
                const originalName = uniqueNormalizedUnits.get(normKey);
                const option = document.createElement('option');
                option.value = normKey; // O valor √© a chave normalizada
                option.textContent = `üè¢ ${originalName.toUpperCase()}`;
                filterSelect.appendChild(option);
            });
        }

        function filterResultCards(selectedUnit) {
            const cardsContainer = document.getElementById('discrepancy-cards-container');
            const noDiscrepancyMsg = document.getElementById('no-discrepancy-message');
            cardsContainer.innerHTML = '';
            
            let totalInv = 0;
            let totalSis = 0;

            const filteredAuditData = (selectedUnit === 'all_divergent') 
                ? auditData 
                : auditData.filter(item => item.normalizedUnitKey === selectedUnit);

            for (const item of filteredAuditData) {
                totalInv += item.qtdInv;
                totalSis += item.qtdSis;
            }
            
            const searchFilteredEntries = [...discrepancyDetails.entries()].filter(([key, details]) => {
                const matchesUnit = selectedUnit === 'all_divergent' || details.normalizedUnitKey === selectedUnit;
                
                const matchesSearch = currentSearchTerm 
                    ? normalizeString(details.local).includes(normalizeString(currentSearchTerm)) ||
                      normalizeString(details.unidade).includes(normalizeString(currentSearchTerm))
                    : true;
                    
                return matchesUnit && matchesSearch;
            });

            const discrepancyCount = searchFilteredEntries.length;
            
            const groupedDetails = new Map();
            searchFilteredEntries.forEach(([key, details]) => {
                const unitKey = details.normalizedUnitKey; 
                const unitName = details.unidade; 
                
                if (!groupedDetails.has(unitKey)) {
                    groupedDetails.set(unitKey, { name: unitName, items: [] });
                }
                groupedDetails.get(unitKey).items.push({key, details});
            });

            if (discrepancyCount > 0) {
                const sortedKeys = [...groupedDetails.keys()].sort();
                
                sortedKeys.forEach(unitKey => {
                    const unitGroup = groupedDetails.get(unitKey);
                    const unitSection = document.createElement('div');
                    unitSection.className = 'mb-8 border-b border-gray-200 pb-4 fade-in';
                    unitSection.innerHTML = `
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="text-3xl">üè¢</span>
                            <span>${unitGroup.name}</span> 
                            <span class="ml-auto bg-primary text-white px-3 py-1 rounded-full text-sm">${unitGroup.items.length} locais com diverg√™ncia</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Cards here -->
                        </div>
                    `;
                    const cardsSubContainer = unitSection.querySelector('.grid');
                    
                    unitGroup.items.forEach(entry => {
                        const card = createDiscrepancyCard(entry.details, entry.key);
                        cardsSubContainer.appendChild(card);
                    });
                    
                    cardsContainer.appendChild(unitSection);
                });

                noDiscrepancyMsg.classList.add('hidden');
            } else {
                cardsContainer.innerHTML = `
                    <div class="p-8 bg-gradient-to-r from-green-50 to-emerald-100 rounded-xl border-4 border-green-400 shadow-xl">
                        <span class="text-6xl mb-4 block text-center">‚úÖ</span>
                        <span class="text-2xl font-bold text-green-700 block mb-2 text-center">AUDITORIA CONCLU√çDA</span>
                        <span class="text-gray-600 block text-center">Nenhuma discrep√¢ncia pendente encontrada ap√≥s a aplica√ß√£o de todos os v√≠nculos.</span>
                    </div>
                `;
                noDiscrepancyMsg.classList.add('hidden'); 
            }

            updateSummaryUI(totalInv, totalSis, totalInv - totalSis);
            document.getElementById('discrepancy-count').textContent = discrepancyCount;
            
            const unitText = selectedUnit === 'all_divergent' ? 'Todas as Unidades Divergentes' : discrepancyDetails.values().next().value?.unidade.toUpperCase() || 'RELAT√ìRIO GERAL';
            document.getElementById('report-title').innerHTML = `
                <span class="text-4xl">üìà</span>
                <span>Relat√≥rio: ${unitText}</span>
            `;
        }

        function createDiscrepancyCard(details, compositeKey) {
            const item = details;
            
            let cardClass = 'bg-white border-gray-300';
            let diffClass = 'text-gray-700';
            let borderColor = 'border-gray-300';
            let icon = 'üìä';
            let divergenceWarning = '';

            if (item.hasQuantityDivergence && item.hasTombamentoDivergence) {
                cardClass = 'bg-gradient-to-br from-red-100 to-red-200 border-red-400';
                diffClass = 'text-red-600';
                borderColor = 'border-red-500';
                icon = 'üî•';
                divergenceWarning = '<span class="status-badge bg-red-200 text-red-800 pulse-warning">‚ö†Ô∏è Qtd. e Tombo Divergentes</span>';
            } else if (item.hasQuantityDivergence) { 
                cardClass = item.diff > 0 ? 'bg-gradient-to-br from-red-50 to-red-100 border-red-300' : 'bg-gradient-to-br from-orange-50 to-orange-100 border-orange-300';
                diffClass = item.diff > 0 ? 'text-red-600' : 'text-orange-600';
                borderColor = item.diff > 0 ? 'border-red-400' : 'border-orange-400';
                icon = item.diff > 0 ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è'; 
                divergenceWarning = '<span class="status-badge bg-red-200 text-red-800 pulse-warning">‚ö†Ô∏è Qtd. Divergente</span>';
            } else if (item.hasTombamentoDivergence) {
                cardClass = 'bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-300';
                diffClass = 'text-gray-700';
                borderColor = 'border-yellow-400';
                icon = 'üîÑ'; 
                divergenceWarning = '<span class="status-badge bg-yellow-200 text-yellow-800">‚ö†Ô∏è Tombo Divergente (Faltante no Sis)</span>';
            }
            
            const diffText = `${item.diff > 0 ? '+' : ''}${item.diff}`;
            
            const card = document.createElement('button');
            card.className = `p-6 border-2 rounded-xl shadow-lg text-left transition-all card-hover ${cardClass} ${borderColor}`;
            card.setAttribute('onclick', `openModal('${compositeKey}')`); 
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-gray-800 mb-1">${item.local}</h3>
                        <p class="text-sm text-gray-600 font-semibold">üè¢ ${item.unidade}</p>
                    </div>
                    <div class="text-4xl">${icon}</div>
                </div>
                <div class="mb-4">${divergenceWarning}</div>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black text-blue-600">${item.qtdInv}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">INVENT√ÅRIO</div>
                    </div>
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black text-orange-600">${item.qtdSis}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">SISTEMA</div>
                    </div>
                    <div class="bg-white bg-opacity-60 p-3 rounded-lg shadow">
                        <div class="text-2xl font-black ${diffClass}">${diffText}</div>
                        <div class="text-xs font-bold text-gray-600 mt-1">DIFEREN√áA</div>
                    </div>
                </div>
            `;
            return card;
        }

        function updateSummaryUI(totalInv, totalSis, totalDiff) {
            document.getElementById('summary-inv').textContent = totalInv;
            document.getElementById('summary-sis').textContent = totalSis;
            document.getElementById('summary-diff').textContent = `${totalDiff > 0 ? '+' : ''}${totalDiff}`;
            
            const diffIcon = document.getElementById('diff-icon');
            const diffStatus = document.getElementById('diff-status');
            const diffBar = document.getElementById('progress-diff');
            
            if (totalDiff > 0) {
                diffIcon.textContent = 'üìâ';
                diffStatus.textContent = 'Falta Sistema';
                diffStatus.className = 'status-badge bg-red-200 text-red-700';
                diffBar.className = 'progress-fill bg-red-500';
            } else if (totalDiff < 0) {
                diffIcon.textContent = 'üìà';
                diffStatus.textContent = 'Sobra Sistema';
                diffStatus.className = 'status-badge bg-orange-200 text-orange-700';
                diffBar.className = 'progress-fill bg-orange-500';
            } else {
                diffIcon.textContent = '‚úÖ';
                diffStatus.textContent = 'Equil√≠brio';
                diffStatus.className = 'status-badge bg-green-200 text-green-700';
                diffBar.className = 'progress-fill bg-green-500';
            }
            
            const maxValue = Math.max(totalInv, totalSis, 1);
            document.getElementById('progress-inv').style.width = `${(totalInv / maxValue) * 100}%`;
            document.getElementById('progress-sis').style.width = `${(totalSis / maxValue) * 100}%`;
            
            const diffPercent = Math.abs(totalDiff) / maxValue * 100;
            diffBar.style.width = `${diffPercent}%`;
        }

        const searchLocal = debounce((searchTerm) => {
            currentSearchTerm = searchTerm;
            const selectedUnit = document.getElementById('unit-filter').value;
            filterResultCards(selectedUnit);
        }, 300);

        function toggleLinkingMode() {
            itemLinkingMode = !itemLinkingMode;
            const btn = document.getElementById('link-mode-btn');
            const info = document.getElementById('linking-info');
            
            if (itemLinkingMode) {
                btn.innerHTML = '<span>‚úñ</span><span>Desativar Vincula√ß√£o</span>';
                btn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition flex items-center gap-2';
                info.classList.remove('hidden');
                selectedInvItem = null;
                selectedSysItem = null;
            } else {
                btn.innerHTML = '<span>üîó</span><span>Ativar Modo Vincula√ß√£o de Tombo</span>';
                btn.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2';
                info.classList.add('hidden');
                cancelLinking();
                return;
            }
            
            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                 renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
            }
        }

        function cancelLinking() {
            selectedInvItem = null;
            selectedSysItem = null;
            itemLinkingMode = false;
            document.getElementById('linking-info').classList.add('hidden');
            const btn = document.getElementById('link-mode-btn');
            btn.innerHTML = '<span>üîó</span><span>Ativar Modo Vincula√ß√£o de Tombo</span>';
            btn.className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition flex items-center gap-2';
            
            document.querySelectorAll('.item-selected').forEach(el => el.classList.remove('item-selected'));

            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                 renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
            }
        }

        function selectItemForLinking(event, instanceId, isInventory) {
            if (!itemLinkingMode) return;
            
            event.stopPropagation(); 
            
            const clickedLi = event.target.closest('li');
            if (!clickedLi) return;

            if (isInventory) {
                selectedInvItem = instanceId;
                document.querySelectorAll('#modal-inv-list .item-selected').forEach(el => el.classList.remove('item-selected'));
                clickedLi.classList.add('item-selected');
            } else {
                selectedSysItem = instanceId;
                document.querySelectorAll('#modal-sis-list .item-selected').forEach(el => el.classList.remove('item-selected'));
                clickedLi.classList.add('item-selected');
            }
            
            if (selectedInvItem && selectedSysItem) {
                createItemLink(selectedInvItem, selectedSysItem);
            }
        }

        function createItemLink(invInstanceId, sysInstanceId) { 
            if (!itemLinks.has(currentCompositeKey)) {
                itemLinks.set(currentCompositeKey, new Map());
            }
            
            const locationLinksMap = itemLinks.get(currentCompositeKey); 
            locationLinksMap.set(invInstanceId, sysInstanceId);
            
            saveLinksToStorage();
            
            selectedInvItem = null;
            selectedSysItem = null;
            document.querySelectorAll('.item-selected').forEach(el => el.classList.remove('item-selected'));
            
            const details = discrepancyDetails.get(currentCompositeKey);
            if (details) {
                const invTombo = details.invItems.find(i => i.instanceId === invInstanceId)?.itemId || invInstanceId;
                const sysTombo = details.sisItems.find(i => i.instanceId === sysInstanceId)?.itemId || sysInstanceId;
                
                renderModalLists(details.invItems, details.sisItems, document.getElementById('modal-search').value);
                
                const invListCount = document.getElementById('modal-inv-list').querySelectorAll('li').length;
                const sisListCount = document.getElementById('modal-sis-list').querySelectorAll('li').length;
                
                if (invListCount === 0 && sisListCount === 0) {
                    showCustomAlert('‚úÖ V√≠nculo criado e diverg√™ncia resolvida! Reanalisando a tabela...');
                    closeModal();
                    runMasterCount(); 
                    return;
                }

                showCustomAlert(`‚úÖ V√≠nculo criado!\nüìã Invent√°rio Tombo: ${invTombo}\n‚öôÔ∏è Sistema Tombamento: ${sysTombo}`);
            }
        }

        function openModal(compositeKey) {
            const details = discrepancyDetails.get(compositeKey);
            if (!details) return;

            currentModalData = details;
            currentCompositeKey = compositeKey;

            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');

            document.getElementById('modal-title').textContent = `üìç ${details.local}`;
            document.getElementById('modal-search').value = '';
            
            renderModalLists(details.invItems, details.sisItems);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-100');
                modalContent.classList.add('scale-95');
            }, 10);
        }

        function renderModalLists(rawInvItems, rawSisItems, searchTerm = '') {
            const invList = document.getElementById('modal-inv-list');
            const sisList = document.getElementById('modal-sis-list');
            
            const locationItemLinks = itemLinks.get(currentCompositeKey) || new Map();
            
            const linkedInvIds = new Set(locationItemLinks.keys());
            const linkedSisIds = new Set(locationItemLinks.values());

            const filteredInvItems = rawInvItems
                .filter(item => !linkedInvIds.has(item.instanceId)) 
                .filter(item => !searchTerm || normalizeString(item.itemId).includes(normalizeString(searchTerm)) || normalizeString(item.description).includes(normalizeString(searchTerm)));
            
            const filteredSisItems = rawSisItems
                .filter(item => !linkedSisIds.has(item.instanceId)) 
                .filter(item => !searchTerm || normalizeString(item.itemId).includes(normalizeString(searchTerm)) || normalizeString(item.description).includes(normalizeString(searchTerm)));
                
            const countTomboInv = new Map();
            filteredInvItems.forEach(item => countTomboInv.set(item.itemId, (countTomboInv.get(item.itemId) || 0) + 1));
            const countTomboSis = new Map();
            filteredSisItems.forEach(item => countTomboSis.set(item.itemId, (countTomboSis.get(item.itemId) || 0) + 1));

            document.getElementById('modal-inv-title').innerHTML = `
                <span class="text-2xl">üìã</span>
                <span>Invent√°rio (${filteredInvItems.length} item(s) restante(s))</span>
            `;
            document.getElementById('modal-sis-title').innerHTML = `
                <span class="text-2xl">‚öôÔ∏è</span>
                <span>Sistema (${filteredSisItems.length} item(s) restante(s))</span>
            `;

            invList.innerHTML = '';
            if (filteredInvItems.length === 0) {
                invList.innerHTML = '<li class="text-gray-500 italic p-3 bg-white rounded-lg">Nenhum item restante.</li>';
            } else {
                filteredInvItems.forEach((itemData, index) => {
                    const { instanceId, itemId, description, state } = itemData;
                    
                    const li = document.createElement('li');
                    li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition item-only-inv ${itemLinkingMode ? 'linking-mode cursor-pointer' : ''}`;
                    if (itemLinkingMode) {
                        li.setAttribute('onclick', `selectItemForLinking(event, '${instanceId.replace(/'/g, "\\'")}', true)`);
                    }
                    
                    const tomboCount = countTomboInv.get(itemId);
                    const isTombo = isValidTombo(itemId);
                    
                    let badgeText;
                    if (!isTombo) {
                        badgeText = `‚ö†Ô∏è SEM TOMBO V√ÅLIDO (ID: ${itemId})`;
                    } else if (tomboCount > 1) {
                        badgeText = `‚ö†Ô∏è DUPLICIDADE DE TOMBO (${itemId}) - ${tomboCount} Inst√¢ncias`;
                    } else {
                        badgeText = `A VINCULAR (Tombo: ${itemId})`;
                    }

                    li.innerHTML = `
                        <div class="flex items-center gap-3 mb-2">
                            <span class="flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold">${index + 1}</span>
                            <span class="flex-1 font-medium">${description}</span>
                        </div>
                        <div class="ml-9 flex flex-wrap gap-2 items-center">
                            <span class="text-xs font-semibold text-gray-700">Estado: ${state}</span>
                            <span class="divergence-badge ${!isTombo ? 'bg-red-200 text-red-800 border-red-400' : 'bg-blue-200 text-blue-800 border-blue-400'}">${badgeText}</span>
                        </div>
                    `;
                    invList.appendChild(li);
                });
            }

            sisList.innerHTML = '';
            if (filteredSisItems.length === 0) {
                sisList.innerHTML = '<li class="text-gray-500 italic p-3 bg-white rounded-lg">Nenhum item restante.</li>';
            } else {
                filteredSisItems.forEach((itemData, index) => {
                    const { instanceId, itemId, description, state } = itemData;
                    
                    const li = document.createElement('li');
                    li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition item-only-sys ${itemLinkingMode ? 'linking-mode cursor-pointer' : ''}`;
                    if (itemLinkingMode) {
                         li.setAttribute('onclick', `selectItemForLinking(event, '${instanceId.replace(/'/g, "\\'")}', false)`);
                    }
                    
                    const tomboCount = countTomboSis.get(itemId);
                    const isTombo = isValidTombo(itemId);

                    let badgeText;
                    if (!isTombo) {
                        badgeText = `‚ö†Ô∏è SEM TOMBO V√ÅLIDO (ID: ${itemId})`;
                    } else if (tomboCount > 1) {
                        badgeText = `‚ö†Ô∏è DUPLICIDADE DE TOMBAMENTO (${itemId}) - ${tomboCount} Inst√¢ncias`;
                    } else {
                        badgeText = `A VINCULAR (Tombamento: ${itemId})`;
                    }

                    li.innerHTML = `
                        <div class="flex items-center gap-3 mb-2">
                            <span class="flex-shrink-0 w-6 h-6 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-xs font-bold">${index + 1}</span>
                            <span class="flex-1 font-medium">${description}</span>
                        </div>
                        <div class="ml-9 flex flex-wrap gap-2 items-center">
                            <span class="text-xs font-semibold text-gray-700">Estado: ${state}</span>
                            <span class="divergence-badge ${!isTombo ? 'bg-red-200 text-red-800 border-red-400' : 'bg-orange-200 text-orange-800 border-orange-400'}">${badgeText}</span>
                        </div>
                    `;
                    sisList.appendChild(li);
                });
            }

            const details = discrepancyDetails.get(currentCompositeKey);
            let subtitle = `üè¢ ${details.unidade}`;
            let linkingMessage = 'Selecione 1 item do Invent√°rio e 1 do Sistema para vincular';
            
            if (details.hasQuantityDivergence && details.hasTombamentoDivergence) {
                subtitle += ' | üö® Qtd. e Tombo Divergentes';
            } else if (details.hasQuantityDivergence) {
                subtitle += ' | ‚ö†Ô∏è Diverg√™ncia de Quantidade';
            } else if (details.hasTombamentoDivergence) {
                subtitle += ' | üîÑ Tombo Faltante (No Invent√°rio)';
                linkingMessage = 'Esse local pode ter Tombo(s) que o Sistema n√£o reconheceu. Vincule os IDs para resolver o Tombo Faltante.'; 
            }
            
            document.getElementById('modal-subtitle').textContent = subtitle;
            document.getElementById('linking-info').querySelector('p').textContent = linkingMessage;
        }

        const searchModalItems = debounce((searchTerm) => {
            renderModalLists(currentModalData.invItems, currentModalData.sisItems, searchTerm);
        }, 300);

        function closeModal() {
            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                cancelLinking();
            }, 300);
        }

        function toggleLocalLinkingMode() {
            globalInventarioData = parseData(document.getElementById('list-inventario').value);
            globalSistemaData = parseData(document.getElementById('list-sistema').value);

            if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                showCustomAlert("‚ö†Ô∏è Por favor, cole os dados do Invent√°rio e Sistema antes de vincular locais.");
                return;
            }

            try {
                allUniqueLocations = { inv: new Map(), sis: new Map() };
                
                const invHeader = globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : [];
                const sisHeader = globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : [];
                
                const invUnitCol = findColumn(invHeader, COLUMNS.INV.UNIT);
                const invLocalCol = findColumn(invHeader, COLUMNS.INV.LOCAL);
                const invIdCol = findColumn(invHeader, COLUMNS.INV.ID); 
                const sisUnitCol = findColumn(sisHeader, COLUMNS.SIS.UNIT);
                const sisLocalCol = findColumn(sisHeader, COLUMNS.SIS.LOCAL);

                if (globalInventarioData.length > 0 && !invLocalCol) throw new Error("Coluna 'Local' (Invent√°rio) n√£o encontrada.");
                if (globalSistemaData.length > 0 && !sisLocalCol) throw new Error("Coluna 'Localiza√ß√£o' (Sistema) n√£o encontrada.");
                if (globalInventarioData.length > 0 && !invIdCol) throw new Error("Coluna 'Tombo' (Invent√°rio) n√£o encontrada.");


                globalInventarioData.forEach(item => {
                    const tombo = invIdCol ? (item[invIdCol] || '').trim() : '';
                    if (isValidTombo(tombo)) { 
                        const unidade = invUnitCol ? (item[invUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                        const local = invLocalCol ? (item[invLocalCol] || 'Sem Local').trim() : 'Sem Local';
                        const key = `${normalizeString(unidade)}|${normalizeString(local)}`;
                        if (local !== 'Sem Local' && !allUniqueLocations.inv.has(key)) {
                            allUniqueLocations.inv.set(key, { unit: unidade, local: local, key: key });
                        }
                    }
                });
                globalSistemaData.forEach(item => {
                    const unidade = sisUnitCol ? (item[sisUnitCol] || 'Sem Unidade').trim() : 'Sem Unidade';
                    const local = sisLocalCol ? (item[sisLocalCol] || 'Sem Local').trim() : 'Sem Local';
                    const key = `${normalizeString(unidade)}|${normalizeString(local)}`;
                    if (local !== 'Sem Local' && !allUniqueLocations.sis.has(key)) {
                        allUniqueLocations.sis.set(key, { unit: unidade, local: local, key: key });
                    }
                });

            } catch (error) {
                showCustomAlert(`‚ùå Erro ao pr√©-processar locais: ${error.message}`);
                return;
            }

            setupLocalLinkingModal('none'); 
            
            const modal = document.getElementById('local-linking-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            locationLinkingMode = true; 
            currentAuditedInvKey = null;
            document.getElementById('local-unit-filter').value = 'none'; 

            const unitFilter = document.getElementById('local-unit-filter');
            unitFilter.innerHTML = '<option value="none">Selecione a Unidade</option>';
            const unitsMap = new Map();
            allUniqueLocations.inv.forEach(loc => unitsMap.set(normalizeString(loc.unit), loc.unit));
            allUniqueLocations.sis.forEach(loc => unitsMap.set(normalizeString(loc.unit), loc.unit));
            
            [...unitsMap.keys()].sort().forEach(normUnit => {
                if (normUnit !== 'sem unidade') {
                    const option = document.createElement('option');
                    const originalUnitName = unitsMap.get(normUnit);
                    
                    option.value = normUnit; 
                    option.textContent = `üè¢ ${originalUnitName}`;
                    unitFilter.appendChild(option);
                }
            });


            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function setupLocalLinkingModal(selectedUnit) {
            const invList = document.getElementById('local-inv-list');
            const sisList = document.getElementById('local-sis-list');
            const invCountSpan = document.getElementById('inv-local-count');
            const sisCountSpan = document.getElementById('sis-local-count');
            
            autoMapSuggestions = new Map();
            
            if (selectedUnit === 'none') {
                invList.innerHTML = '<li class="text-gray-500 italic p-3">Selecione uma unidade para carregar os locais.</li>';
                sisList.innerHTML = '<li class="text-gray-500 italic p-3">Selecione uma unidade.</li>';
                invCountSpan.textContent = '0 Locais';
                sisCountSpan.textContent = '0 Locais';
                return;
            }
            
            invList.innerHTML = '';
            sisList.innerHTML = '';
            currentAuditedInvKey = null;
            document.getElementById('current-local-status').textContent = 'Selecione um local do Invent√°rio para auditar.';
            document.getElementById('btn-confirm-local').disabled = true;
            document.getElementById('btn-remove-local').disabled = true;


            const normalizedUnit = selectedUnit; 
            
            const filteredInv = [...allUniqueLocations.inv.values()]
                .filter(loc => loc.key.startsWith(normalizedUnit + '|'))
                .sort((a, b) => a.local.localeCompare(b.local));
                
            const filteredSis = [...allUniqueLocations.sis.values()]
                .filter(loc => loc.key.startsWith(normalizedUnit + '|'))
                .sort((a, b) => a.local.localeCompare(b.local));
            
            autoMapSuggestions = autoMapLocations(filteredInv, filteredSis);

            const remainingInv = filteredInv.filter(loc => !locationLinks.has(loc.key)); 

            const linkedSisKeys = new Set([...locationLinks.values()]);
            const remainingSis = filteredSis.filter(loc => !linkedSisKeys.has(loc.key)); 

            invCountSpan.textContent = `${remainingInv.length} Locais restantes`;
            sisCountSpan.textContent = `${remainingSis.length} Locais restantes`;

            if (remainingInv.length === 0) {
                 invList.innerHTML = '<li class="text-gray-500 italic p-3">Todos os locais desta unidade foram auditados e vinculados.</li>';
            } else {
                remainingInv.forEach(loc => {
                    const li = document.createElement('li');
                    li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition cursor-pointer location-link-mode`;
                    li.setAttribute('onclick', `selectLocalForAuditing(event, '${loc.key.replace(/'/g, "\\'")}')`);
                    li.dataset.key = loc.key; 
                    
                    const linkedSisKey = locationLinks.get(loc.key); 
                    const suggestedSisKey = autoMapSuggestions.get(loc.key);
                    let badge = '';
                    let targetName = 'Sem Mapeamento';
                    
                    if (linkedSisKey) {
                        
                    } else if (suggestedSisKey) {
                         targetName = allUniqueLocations.sis.get(suggestedSisKey)?.local || 'Desconhecido';
                         badge = `<span class="status-badge bg-yellow-200 text-yellow-800 ml-2">Sugest√£o: ${targetName}</span>`;
                    } else {
                         badge = `<span class="status-badge bg-gray-200 text-gray-700 ml-2">Sem V√≠nculo</span>`;
                    }
                    
                    li.innerHTML = `
                        <div class="font-semibold text-base">${loc.local}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            Destino: <span class="font-bold text-gray-700">${targetName}</span>
                        </div>
                        <div class="mt-1">${badge}</div>
                    `;
                    invList.appendChild(li);
                });
            }

             if (remainingSis.length === 0) {
                 sisList.innerHTML = '<li class="text-gray-500 italic p-3">Todos os locais do Sistema desta unidade foram mapeados como destino.</li>';
            } else {
                remainingSis.forEach(loc => {
                    const li = document.createElement('li');
                    li.className = `p-3 bg-white rounded-lg shadow hover:shadow-md transition cursor-pointer`;
                    li.setAttribute('onclick', `selectLocalForMapping(event, '${loc.key.replace(/'/g, "\\'")}')`);
                    li.dataset.key = loc.key; 
                    
                    li.innerHTML = `
                        <div class="font-semibold">${loc.local}</div>
                        <div class="text-xs text-gray-500">üè¢ ${loc.unit}</div>
                    `;
                    sisList.appendChild(li);
                });
            }
        }

        function autoMapLocations(invLocs, sisLocs) {
            const suggestions = new Map();
            const sisNormMap = new Map(sisLocs.map(loc => [normalizeString(loc.local), loc.key]));

            invLocs.forEach(invLoc => {
                const normInv = normalizeString(invLoc.local);
                if (sisNormMap.has(normInv)) {
                    suggestions.set(invLoc.key, sisNormMap.get(normInv));
                }
            });
            return suggestions;
        }

        function selectLocalForAuditing(event, invKey) {
            currentAuditedInvKey = invKey;
            
            document.querySelectorAll('#local-linking-modal .location-selected').forEach(el => el.classList.remove('location-selected'));
            
            const invLi = event.target.closest('li');
            invLi.classList.add('location-selected');

            const statusText = document.getElementById('current-local-status');
            const btnConfirm = document.getElementById('btn-confirm-local');
            const btnRemove = document.getElementById('btn-remove-local');

            const invLoc = allUniqueLocations.inv.get(invKey);
            statusText.textContent = `Auditando: ${invLoc.local}`;
            
            btnConfirm.disabled = false;
            btnRemove.disabled = !locationLinks.has(invKey); 

            const linkedSisKey = locationLinks.get(invKey) || autoMapSuggestions.get(invKey);
            
            if (linkedSisKey) {
                const sisLi = document.querySelector(`#local-sis-list li[data-key="${linkedSisKey.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}"]`);
                if (sisLi) {
                    sisLi.classList.add('location-selected');
                }
            }
        }
        
        function selectLocalForMapping(event, sisKey) {
             const sisLi = event.target.closest('li');
             
             if (!currentAuditedInvKey) return; 

             document.querySelectorAll('#local-sis-list .location-selected').forEach(el => el.classList.remove('location-selected'));
             
             sisLi.classList.add('location-selected');

            const statusText = document.getElementById('current-local-status');
            const invLoc = allUniqueLocations.inv.get(currentAuditedInvKey);
            const sisLoc = allUniqueLocations.sis.get(sisKey);
            statusText.textContent = `Pronto para VINCULAR: ${invLoc.local} ‚ûî ${sisLoc.local}`;
        }

        function confirmLocalLink() {
            if (!currentAuditedInvKey) {
                showCustomAlert("‚ö†Ô∏è Selecione um local do Invent√°rio primeiro.");
                return;
            }
            
            const selectedSisElement = document.querySelector('#local-sis-list .location-selected');
            const sisKeyToLink = selectedSisElement ? selectedSisElement.dataset.key : null;

            if (!sisKeyToLink) {
                 showCustomAlert("‚ö†Ô∏è Selecione um local do Sistema (destino) para vincular.");
                 return;
            }

            createLocationLink(currentAuditedInvKey, sisKeyToLink);
        }

        function createLocationLink(invKey, sisKey) {
            locationLinks.set(invKey, sisKey);
            saveLinksToStorage();
            
            const invLoc = allUniqueLocations.inv.get(invKey);
            const sisLoc = allUniqueLocations.sis.get(sisKey);
            
            showCustomAlert(`‚úÖ V√≠nculo de Local criado/confirmado!\nüìã ${invLoc.local} ‚ûî ‚öôÔ∏è ${sisLoc.local}`);
            
            setupLocalLinkingModal(document.getElementById('local-unit-filter').value);
            currentAuditedInvKey = null;
            document.getElementById('current-local-status').textContent = 'Selecione um local do Invent√°rio para auditar.';
            document.getElementById('btn-confirm-local').disabled = true;
            document.getElementById('btn-remove-local').disabled = true;
        }

        function removeLocalLink() {
            if (!currentAuditedInvKey) {
                showCustomAlert("‚ö†Ô∏è Selecione um local do Invent√°rio primeiro.");
                return;
            }

            if (!locationLinks.has(currentAuditedInvKey)) {
                 showCustomAlert("‚ÑπÔ∏è Este local n√£o possui v√≠nculo salvo para remover.");
                 return;
            }

            locationLinks.delete(currentAuditedInvKey);
            saveLinksToStorage();
            
            const invLoc = allUniqueLocations.inv.get(currentAuditedInvKey);
            showCustomAlert(`‚úÖ V√≠nculo removido para: ${invLoc.local}`);

            setupLocalLinkingModal(document.getElementById('local-unit-filter').value);
            currentAuditedInvKey = null;
            document.getElementById('current-local-status').textContent = 'Selecione um local do Invent√°rio para auditar.';
            document.getElementById('btn-confirm-local').disabled = true;
            document.getElementById('btn-remove-local').disabled = true;
        }

        function closeLocalLinkingModal() {
            currentAuditedInvKey = null;
            const modal = document.getElementById('local-linking-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        
        function toggleLinkManager() {
            const modal = document.getElementById('link-manager-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            updateLinkManagerDisplay();
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeLinkManager() {
            const modal = document.getElementById('link-manager-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function updateLinkManagerDisplay() {
            const itemContainer = document.getElementById('item-link-list-container');
            const localContainer = document.getElementById('local-link-list-container');
            
            itemContainer.innerHTML = '';
            localContainer.innerHTML = '';
            
            // Item Links
            if (itemLinks.size === 0) {
                itemContainer.innerHTML = '<p class="text-center text-gray-500 italic p-4">Nenhuma vincula√ß√£o de item criada</p>';
            } else {
                itemLinks.forEach((links, compositeKey) => {
                    // Nota: O Tombo ID n√£o est√° armazenado no link, apenas o Instance ID.
                    // Isso ser√° um desafio, mas o Instance ID garante a funcionalidade.
                    const [unidade, local] = compositeKey.split('|');
                    
                    const section = document.createElement('div');
                    section.className = 'mb-4 p-3 bg-purple-50 rounded-xl border border-purple-200';
                    section.innerHTML = `<h4 class="font-bold text-sm text-purple-800 mb-2">üìç ${local.toUpperCase()} (${unidade.toUpperCase()})</h4><div class="space-y-1"></div>`;
                    
                    const listContainer = section.querySelector('.space-y-1');
                    
                    links.forEach((sysInstanceId, invInstanceId) => {
                        const linkItem = document.createElement('div');
                        linkItem.className = 'flex items-center justify-between bg-white p-2 rounded-lg shadow-sm text-xs';
                        // Exibe os IDs de inst√¢ncia para fins de depura√ß√£o
                        linkItem.innerHTML = `
                            <div class="flex-1">
                                <span class="font-semibold text-blue-700">Inv Instance ID: ${invInstanceId}</span>
                                <span class="mx-1 text-purple-600">üîó</span>
                                <span class="font-semibold text-orange-700">Sis Instance ID: ${sysInstanceId}</span>
                            </div>
                            <button onclick="removeLink('item|${compositeKey}', '${invInstanceId.replace(/'/g, "\\'")}')" class="px-2 py-0.5 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                                üóëÔ∏è
                            </button>
                        `;
                        listContainer.appendChild(linkItem);
                    });
                    
                    itemContainer.appendChild(section);
                });
            }
            
            // Local Links
            if (locationLinks.size === 0) {
                localContainer.innerHTML = '<p class="text-center text-gray-500 italic p-4">Nenhuma vincula√ß√£o de local criada</p>';
            } else {
                locationLinks.forEach((sysKey, invKey) => {
                    const [invUnit, invLocal] = invKey.split('|');
                    const [sysUnit, sysLocal] = sysKey.split('|');

                    const linkItem = document.createElement('div');
                    linkItem.className = 'flex items-center justify-between bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm';
                    linkItem.innerHTML = `
                        <div class="flex-1 text-sm">
                            <span class="font-bold text-blue-700">Inv: ${invLocal.toUpperCase()} (${invUnit.toUpperCase()})</span>
                            <span class="mx-2 text-blue-600">üó∫Ô∏è VINCULADO A</span>
                            <span class="font-bold text-orange-700">Sis: ${sysLocal.toUpperCase()} (${sysUnit.toUpperCase()})</span>
                        </div>
                        <button onclick="removeLink('LOCAL_LINK', '${invKey.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-bold transition">
                            üóëÔ∏è
                        </button>
                    `;
                    localContainer.appendChild(linkItem);
                });
            }
            
            updateLinkCount();
        }

        // === INICIALIZA√á√ÉO ===
        
        function setupDataListeners() {
            const inventarioTextarea = document.getElementById('list-inventario');
            const sistemaTextarea = document.getElementById('list-sistema');
            
            const debouncedUpdate = debounce(updateDataCount, 300);
            
            inventarioTextarea.addEventListener('input', debouncedUpdate);
            sistemaTextarea.addEventListener('input', debouncedUpdate);
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Fecha modais abertos
                    closeModal();
                    closeLinkManager();
                    closeFinalReport();
                    closeLocalLinkingModal();
                    
                    const confirmModal = document.getElementById('custom-confirm');
                    if(confirmModal) confirmModal.remove();
                    
                    const alertModal = document.getElementById('custom-alert');
                    if(alertModal) alertModal.remove();
                }
                
                if (e.ctrlKey && e.key === 'Enter') {
                    runMasterCount();
                }
            });
            
            // Carrega links salvos
            loadLinksFromStorage();
        }

        window.onload = () => {
            setupDataListeners();
            console.log('üöÄ Sistema com Vincula√ß√£o Inteligente carregado!');
        };
    </script>
</body>
</html>
