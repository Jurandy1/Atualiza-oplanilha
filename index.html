<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de An치lise de Quantidade por Local</title>
    <!-- Carregando Tailwind CSS para estiliza칞칚o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definindo a fonte padr칚o e ajustes visuais */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        textarea {
            height: 250px; 
            @apply shadow-inner;
        }
        /* Responsividade da tabela */
        @media (max-width: 640px) {
            .responsive-table th, .responsive-table td {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                font-size: 0.75rem; /* extra small */
            }
        }
        .table-container { max-height: 700px; } /* Altura m치xima para rolagem na tabela */
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Esmeralda */
                        'primary-dark': '#059669',
                        'inventario': '#3b82f6', /* Azul */
                        'sistema': '#f97316', /* Laranja */
                        'export': '#d946ef', /* F칰csia */
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 border-b-4 border-primary pb-2 flex items-center">
            Sistema de An치lise de Quantidade por Local 游늳
        </h1>
        <p class="text-gray-600 mb-6">
            Cole os dados (TSV/CSV) para auditar a quantidade de itens. O sistema agrupar치 **todos** os itens por **Unidade + Local + Descri칞칚o** e mostrar치 a diferen칞a na contagem entre as duas listas.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Invent치rio (Fonte) -->
            <div>
                <label for="list-inventario" class="block text-lg font-semibold text-inventario mb-2 flex items-center">
                    <span class="mr-2">游늶</span>
                    1. Dados do Invent치rio (Fonte da Verdade)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Usar치 as colunas:** Unidade, Item (Descri칞칚o), Local
                </p>
                <textarea id="list-inventario" class="w-full p-3 border border-inventario rounded-lg focus:ring-inventario focus:border-inventario transition duration-150" placeholder="Cole aqui os dados do Invent치rio, incluindo o cabe칞alho..."></textarea>
                <span id="count-inventario" class="text-sm text-gray-500 mt-1 block">Total de Itens no Invent치rio: 0</span>
            </div>
            
            <!-- Sistema (Destino) -->
            <div>
                <label for="list-sistema" class="block text-lg font-semibold text-sistema mb-2 flex items-center">
                    <span class="mr-2">丘뙖잺</span>
                    2. Dados do Sistema (Estoque Atual)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Usar치 as colunas:** Unidade, Descri칞칚o, Localiza칞칚o
                </p>
                <textarea id="list-sistema" class="w-full p-3 border border-sistema rounded-lg focus:ring-sistema focus:border-sistema transition duration-150" placeholder="Cole aqui os dados do Sistema, incluindo o cabe칞alho..."></textarea>
                <span id="count-sistema" class="text-sm text-gray-500 mt-1 block">Total de Itens no Sistema: 0</span>
            </div>
        </div>

        <!-- BOT츾O DE A칂츾O 칔NICO -->
        <div class="mb-8">
             <button onclick="runMasterCount()" class="w-full px-6 py-3 bg-primary text-white font-bold text-lg rounded-xl shadow-lg hover:bg-primary-dark transition duration-300 transform hover:scale-[1.01]">
                1. Analisar Contagem por Local
            </button>
        </div>
        
        
        <!-- Container de Resultados - Auditoria de Quantidade -->
        <div id="results-container" class="mt-12 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-primary pb-2">
                Relat칩rio de Auditoria de Quantidade
            </h2>
            <p class="text-gray-600 mb-4">
                Este relat칩rio agrupa **todos** os itens (com ou sem tombo) por Local e Descri칞칚o para encontrar discrep칙ncias de quantidade.
            </p>
            
            <!-- Export Button -->
            <button onclick="exportCSV()" class="w-full md:w-auto px-6 py-2 bg-export text-white font-bold rounded-lg shadow-md hover:bg-fuchsia-700 transition duration-300 transform hover:scale-[1.01] mb-4">
                Exportar Auditoria CSV
            </button>

            <div class="overflow-x-auto rounded-lg shadow-xl table-container mt-4">
                <table class="min-w-full bg-white responsive-table">
                    <thead class="bg-gray-100 border-b-2 border-gray-300 sticky top-0">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unidade (Agrupada)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Local (Agrupado)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descri칞칚o (Agrupada)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Qtd. Invent치rio</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Qtd. Sistema</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Diferen칞a (Inv - Sis)</th>
                        </tr>
                    </thead>
                    <tbody id="results-body" class="divide-y divide-gray-200">
                        <!-- Resultados da auditoria de quantidade ser칚o injetados aqui -->
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <script>
        // Global variable for storing audit data
        let auditData = []; // Para a auditoria de quantidade

        
        // Fun칞칚o de normaliza칞칚o MELHORADA para strings (resolve "12 mil" vs "12.000")
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            let s = str.toLowerCase();
            
            // 1. Remove acentos
            s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            // 2. Padroniza "mil" para "000" (Ex: "12 mil btus" -> "12000 btus")
            s = s.replace(/\b(\d+)\s*mil\b/g, '$1000'); 
            
            // 3. Remove pontua칞칚o de n칰meros (Ex: "12.000" -> "12000")
            s = s.replace(/(\d+)[.,](\d+)/g, '$1$2'); 
            
            // 4. Padroniza unidades (Ex: "btus", "btu/h" -> "btu")
            s = s.replace(/\bbtus\b/g, 'btu');
            s = s.replace(/\bbtu\/h\b/g, 'btu');
            
            // 5. Remove caracteres especiais (incluindo os que o usu치rio mostrou: / .)
            s = s.replace(/[-/.,]/g, ' '); 
            
            // 6. Remove espa칞os extras
            s = s.replace(/\s+/g, ' ').trim(); 
            
            return s;
        }

        // Fun칞칚o para detetar o separador (v칤rgula, ponto e v칤rgula, ou tab) e parsear os dados
        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            let separator = '\t'; // Tentativa padr칚o: Tab
            if (firstLine.includes(';')) {
                separator = ';';
            } else if (firstLine.includes(',')) {
                 // Conta a frequ칡ncia de cada separador na primeira linha
                const counts = { ',': (firstLine.match(/,/g) || []).length, ';': (firstLine.match(/;/g) || []).length, '\t': (firstLine.match(/\t/g) || []).length };
                
                // Escolhe o separador com maior contagem (se for maior que zero)
                if (counts[';'] > counts[','] && counts[';'] > counts['\t']) {
                    separator = ';';
                } else if (counts[','] > counts[';'] && counts[','] > counts['\t']) {
                    separator = ',';
                } else if (counts['\t'] === 0 && counts[','] === 0 && counts[';'] === 0) {
                     separator = ' '; // Fallback para espa칞o se nenhum outro for encontrado
                }
            }


            const rawHeaders = lines[0].split(separator).map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length === rawHeaders.length) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        // Encontra o cabe칞alho original (mantendo case)
                        const originalHeader = rawHeaders.find(h => normalizeString(h) === normalizeString(header));
                        item[originalHeader || header] = values[index];
                    });
                    data.push(item);
                }
            }
            return data;
        }

        
        // --- FLUXO 칔NICO: Auditoria de Quantidade Mestra ---
        function runMasterCount() {
            const listInventarioText = document.getElementById('list-inventario').value;
            const listSistemaText = document.getElementById('list-sistema').value;
            
            document.getElementById('results-container').classList.add('hidden');
            
            if (!listInventarioText.trim() && !listSistemaText.trim()) {
                console.error('Por favor, cole os dados do Invent치rio e do Sistema.');
                return;
            }

            const inventarioData = parseData(listInventarioText);
            const sistemaData = parseData(listSistemaText);
            
            document.getElementById('count-inventario').textContent = `Total de Itens no Invent치rio: ${inventarioData.length}`;
            document.getElementById('count-sistema').textContent = `Total de Itens no Sistema: ${sistemaData.length}`;

            // Mostra o container de resultados
            document.getElementById('results-container').classList.remove('hidden');

            const inventarioMap = new Map(); // Map<"unidade|local|descri칞칚o", Qtd>
            const sistemaMap = new Map();
            const allCompositeKeys = new Set();
            auditData = []; // Limpa auditoria anterior

            // Processa Invent치rio (USA: Unidade, Local, Item)
            inventarioData.forEach(item => {
                // Aplica a normaliza칞칚o aos cabe칞alhos esperados
                const unidade = normalizeString(item['Unidade'] || 'Sem Unidade');
                const local = normalizeString(item['Local'] || 'Sem Local');
                const desc = normalizeString(item['Item'] || 'Sem Descri칞칚o'); // Do Invent치rio
                const compositeKey = `${unidade}|${local}|${desc}`;
                
                allCompositeKeys.add(compositeKey);
                inventarioMap.set(compositeKey, (inventarioMap.get(compositeKey) || 0) + 1);
            });
            
            // Processa Sistema (USA: Unidade, Localiza칞칚o, Descri칞칚o)
            sistemaData.forEach(item => {
                const unidade = normalizeString(item['Unidade'] || 'Sem Unidade');
                const local = normalizeString(item['Localiza칞칚o'] || 'Sem Local'); // Do Sistema
                const desc = normalizeString(item['Descri칞칚o'] || 'Sem Descri칞칚o'); // Do Sistema
                const compositeKey = `${unidade}|${local}|${desc}`;

                allCompositeKeys.add(compositeKey);
                sistemaMap.set(compositeKey, (sistemaMap.get(compositeKey) || 0) + 1);
            });

            // Gera o relat칩rio de auditoria
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';
            
            const sortedKeys = [...allCompositeKeys].sort();

            for (const compositeKey of sortedKeys) {
                // Ignora chaves "vazias" (ex: "sem unidade|sem local|sem descri칞칚o")
                if (compositeKey === "sem unidade|sem local|sem descri칞칚o") continue;
                
                const [unidade, local, desc] = compositeKey.split('|');
                const qtdInv = inventarioMap.get(compositeKey) || 0;
                const qtdSis = sistemaMap.get(compositeKey) || 0;
                const diff = qtdInv - qtdSis;

                if (qtdInv > 0 || qtdSis > 0) { // S칩 mostra se houver item em pelo menos uma lista
                    const auditRow = {
                        unidade: unidade,
                        local: local,
                        desc: desc,
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    };
                    auditData.push(auditRow); // Salva para exporta칞칚o
                    
                    let rowClass = 'bg-white';
                    let diffClass = 'text-gray-700';
                    if (diff > 0) {
                        rowClass = 'bg-green-50'; // Mais no Invent치rio (Falta no Sistema)
                        diffClass = 'text-green-700 font-bold';
                    } else if (diff < 0) {
                        rowClass = 'bg-red-50'; // Menos no Invent치rio (Sobra no Sistema)
                        diffClass = 'text-red-700 font-bold';
                    }

                    const row = document.createElement('tr');
                    row.className = `${rowClass} hover:bg-gray-100`;
                    row.innerHTML = `
                        <td class="p-3 font-medium text-gray-900">${unidade}</td>
                        <td class="p-3 font-medium text-gray-900">${local}</td>
                        <td class="p-3 text-sm text-gray-700">${desc}</td>
                        <td class="p-3 text-sm text-gray-700">${qtdInv}</td>
                        <td class="p-3 text-sm text-gray-700">${qtdSis}</td>
                        <td class="p-3 text-sm ${diffClass}">${diff > 0 ? '+' : ''}${diff}</td>
                    `;
                    resultsBody.appendChild(row);
                }
            }
        }


        // Fun칞칚o para exportar CSV (modo 칰nico de auditoria)
        function exportCSV() {
            let csvContent = '';
            let filename = '';

            // Exporta Relat칩rio SEM TOMBO
            const headers = ['Unidade', 'Local', 'Descricao', 'Qtd_Inventario', 'Qtd_Sistema', 'Diferenca'];
            csvContent = headers.join(';') + '\n';
            
            auditData.forEach(item => {
                const values = [
                    (item.unidade || '').replace(/;/g, ','),
                    (item.local || '').replace(/;/g, ','),
                    (item.desc || '').replace(/;/g, ','),
                    item.qtdInv,
                    item.qtdSis,
                    item.diff
                ];
                csvContent += values.join(';') + '\n';
            });
            filename = `Auditoria_de_Quantidade.csv`;

            // L칩gica de Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                console.error("Download is not supported in this browser.");
            }
        }

        // Adiciona listener para atualizar a contagem enquanto digita/cola
        function setupCountListeners() {
            document.getElementById('list-inventario').addEventListener('input', () => {
                 const data = parseData(document.getElementById('list-inventario').value);
                 document.getElementById('count-inventario').textContent = `Total de Itens no Invent치rio: ${data.length}`;
            });
            document.getElementById('list-sistema').addEventListener('input', () => {
                 const data = parseData(document.getElementById('list-sistema').value);
                 document.getElementById('count-sistema').textContent = `Total de Itens no Sistema: ${data.length}`;
            });
        }
        window.onload = setupCountListeners;

    </script>
</body>
</html>

