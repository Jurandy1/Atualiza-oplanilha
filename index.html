<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de An치lise de Quantidade por Local</title>
    <!-- Carregando Tailwind CSS para estiliza칞칚o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definindo a fonte padr칚o e ajustes visuais */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        textarea {
            height: 250px; 
            @apply shadow-inner;
        }
        /* Responsividade da tabela */
        @media (max-width: 640px) {
            .responsive-table th, .responsive-table td {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                font-size: 0.75rem; /* extra small */
            }
        }
        .table-container { max-height: 700px; } /* Altura m치xima para rolagem na tabela */
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Esmeralda */
                        'primary-dark': '#059669',
                        'inventario': '#3b82f6', /* Azul */
                        'sistema': '#f97316', /* Laranja */
                        'export': '#d946ef', /* F칰csia */
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 border-b-4 border-primary pb-2 flex items-center">
            Sistema de An치lise de Quantidade por Local 游늳
        </h1>
        <p class="text-gray-600 mb-6">
            Cole os dados (TSV/CSV) para auditar a quantidade de itens. O sistema agrupar치 **todos** os itens por **Unidade + Local + Descri칞칚o** e mostrar치 a diferen칞a na contagem entre as duas listas.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Invent치rio (Fonte) -->
            <div>
                <label for="list-inventario" class="block text-lg font-semibold text-inventario mb-2 flex items-center">
                    <span class="mr-2">游늶</span>
                    1. Dados do Invent치rio (Fonte da Verdade)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Usar치 as colunas:** Unidade, Item (Descri칞칚o), Local
                </p>
                <textarea id="list-inventario" class="w-full p-3 border border-inventario rounded-lg focus:ring-inventario focus:border-inventario transition duration-150" placeholder="Cole aqui os dados do Invent치rio, incluindo o cabe칞alho..."></textarea>
                <span id="count-inventario" class="text-sm text-gray-500 mt-1 block">Total de Itens no Invent치rio: 0</span>
            </div>
            
            <!-- Sistema (Destino) -->
            <div>
                <label for="list-sistema" class="block text-lg font-semibold text-sistema mb-2 flex items-center">
                    <span class="mr-2">丘뙖잺</span>
                    2. Dados do Sistema (Estoque Atual)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Usar치 as colunas:** Unidade, Descri칞칚o, Localiza칞칚o
                </p>
                <textarea id="list-sistema" class="w-full p-3 border border-sistema rounded-lg focus:ring-sistema focus:border-sistema transition duration-150" placeholder="Cole aqui os dados do Sistema, incluindo o cabe칞alho..."></textarea>
                <span id="count-sistema" class="text-sm text-gray-500 mt-1 block">Total de Itens no Sistema: 0</span>
            </div>
        </div>

        <!-- NOVO: FILTRO DE UNIDADE -->
        <div id="filter-container" class="mb-6 hidden">
            <label for="unit-filter" class="block text-lg font-semibold text-gray-700 mb-2">
                Selecione a Unidade (CRAS) para Analisar:
            </label>
            <select id="unit-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white">
                <option value="all">-- Todas as Unidades --</option>
                <!-- Op칞칫es de unidade ser칚o preenchidas dinamicamente -->
            </select>
        </div>


        <!-- BOT츾O DE A칂츾O 칔NICO -->
        <div class="mb-8">
             <button onclick="runMasterCount()" class="w-full px-6 py-3 bg-primary text-white font-bold text-lg rounded-xl shadow-lg hover:bg-primary-dark transition duration-300 transform hover:scale-[1.01]">
                1. Analisar Contagem por Local
            </button>
        </div>
        
        
        <!-- Container de Resultados - Auditoria de Quantidade -->
        <div id="results-container" class="mt-12 hidden">
            <h2 id="report-title" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-primary pb-2">
                Relat칩rio de Auditoria de Quantidade
            </h2>
            <p id="report-subtitle" class="text-gray-600 mb-4">
                Este relat칩rio agrupa **todos** os itens (com ou sem tombo) por Local e Descri칞칚o para encontrar discrep칙ncias de quantidade.
            </p>
            
            <!-- Export Button -->
            <button onclick="exportCSV()" class="w-full md:w-auto px-6 py-2 bg-export text-white font-bold rounded-lg shadow-md hover:bg-fuchsia-700 transition duration-300 transform hover:scale-[1.01] mb-4">
                Exportar Auditoria CSV
            </button>
            
            <!-- NOVO: Resumo de Totais -->
            <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="summary-inv">0</div>
                    <div class="text-sm font-semibold text-gray-600">Total Itens (Invent치rio)</div>
                </div>
                 <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-orange-600" id="summary-sis">0</div>
                    <div class="text-sm font-semibold text-gray-600">Total Itens (Sistema)</div>
                </div>
                 <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-gray-700" id="summary-diff">0</div>
                    <div class="text-sm font-semibold text-gray-600">Diferen칞a L칤quida (Inv - Sis)</div>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-xl table-container mt-4">
                <table class="min-w-full bg-white responsive-table">
                    <thead class="bg-gray-100 border-b-2 border-gray-300 sticky top-0">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Unidade (Agrupada)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Local (Agrupado)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Descri칞칚o (Agrupada)</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Qtd. Invent치rio</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Qtd. Sistema</th>
                            <th class="p-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Diferen칞a (Inv - Sis)</th>
                        </tr>
                    </thead>
                    <tbody id="results-body" class="divide-y divide-gray-200">
                        <!-- Resultados da auditoria de quantidade ser칚o injetados aqui -->
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <script>
        // Global variable for storing audit data
        let auditData = []; // Para a auditoria de quantidade
        let globalInventarioData = [];
        let globalSistemaData = [];
        let uniqueUnits = new Set();
        
        // Fun칞칚o de normaliza칞칚o MELHORADA para strings (resolve "12 mil" vs "12.000")
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            let s = str.toLowerCase();
            
            // 1. Remove acentos
            s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            // 2. Padroniza "mil" para "000" (Ex: "12 mil btus" -> "12000 btus")
            s = s.replace(/\b(\d+)\s*mil\b/g, '$1000'); 
            
            // 3. Remove pontua칞칚o de n칰meros (Ex: "12.000" -> "12000")
            s = s.replace(/(\d+)[.,](\d+)/g, '$1$2'); 
            
            // 4. Padroniza unidades (Ex: "btus", "btu/h" -> "btu")
            s = s.replace(/\bbtus\b/g, 'btu');
            s = s.replace(/\bbtu\/h\b/g, 'btu');
            
            // 5. Remove caracteres especiais (incluindo os que o usu치rio mostrou: / .)
            s = s.replace(/[-/.,]/g, ' '); 
            
            // 6. Remove espa칞os extras
            s = s.replace(/\s+/g, ' ').trim(); 
            
            return s;
        }

        // Fun칞칚o para detetar o separador (v칤rgula, ponto e v칤rgula, ou tab) e parsear os dados
        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            let separator = '\t'; // Tentativa padr칚o: Tab
            if (firstLine.includes(';')) {
                separator = ';';
            } else if (firstLine.includes(',')) {
                 // Conta a frequ칡ncia de cada separador na primeira linha
                const counts = { ',': (firstLine.match(/,/g) || []).length, ';': (firstLine.match(/;/g) || []).length, '\t': (firstLine.match(/\t/g) || []).length };
                
                // Escolhe o separador com maior contagem (se for maior que zero)
                if (counts[';'] > counts[','] && counts[';'] > counts['\t']) {
                    separator = ';';
                } else if (counts[','] > counts[';'] && counts[','] > counts['\t']) {
                    separator = ',';
                } else if (counts['\t'] === 0 && counts[','] === 0 && counts[';'] === 0) {
                     separator = ' '; // Fallback para espa칞o se nenhum outro for encontrado
                }
            }


            const rawHeaders = lines[0].split(separator).map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length === rawHeaders.length) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        // Encontra o cabe칞alho original (mantendo case)
                        const originalHeader = rawHeaders.find(h => normalizeString(h) === normalizeString(header));
                        item[originalHeader || header] = values[index];
                    });
                    data.push(item);
                }
            }
            return data;
        }

        // NOVO: Fun칞칚o para atualizar o filtro de unidades
        function updateUnitFilter() {
            uniqueUnits = new Set();
            const filterSelect = document.getElementById('unit-filter');
            const filterContainer = document.getElementById('filter-container');

            // Encontra o nome da coluna "Unidade" em ambas as listas
            const invHeader = (parseData(document.getElementById('list-inventario').value)[0] || {});
            const invUnitCol = Object.keys(invHeader).find(k => normalizeString(k) === 'unidade');
            
            const sisHeader = (parseData(document.getElementById('list-sistema').value)[0] || {});
            const sisUnitCol = Object.keys(sisHeader).find(k => normalizeString(k) === 'unidade');
            
            globalInventarioData.forEach(item => {
                if(invUnitCol) uniqueUnits.add(normalizeString(item[invUnitCol] || ''));
            });
            globalSistemaData.forEach(item => {
                if(sisUnitCol) uniqueUnits.add(normalizeString(item[sisUnitCol] || ''));
            });

            // Limpa unidades vazias
            uniqueUnits.delete('');
            uniqueUnits.delete('sem unidade');

            // Limpa op칞칫es antigas (mantendo a primeira)
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }
            
            const sortedUnits = [...uniqueUnits].sort();
            sortedUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit.toUpperCase(); // Mostra em mai칰sculo para ficar mais claro
                filterSelect.appendChild(option);
            });
            
            if (sortedUnits.length > 0) {
                filterContainer.classList.remove('hidden');
            } else {
                filterContainer.classList.add('hidden');
            }
        }
        
        // --- FLUXO 칔NICO: Auditoria de Quantidade Mestra (Agora com filtro) ---
        function runMasterCount() {
            document.getElementById('results-container').classList.add('hidden');
            
            if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                console.error('Dados n칚o foram carregados.');
                return;
            }

            // NOVO: Pega a unidade selecionada no filtro
            const selectedUnit = document.getElementById('unit-filter').value;

            // Mostra o container de resultados
            document.getElementById('results-container').classList.remove('hidden');

            const inventarioMap = new Map(); // Map<"unidade|local|descri칞칚o", Qtd>
            const sistemaMap = new Map();
            const allCompositeKeys = new Set();
            auditData = []; // Limpa auditoria anterior
            
            let totalInv = 0;
            let totalSis = 0;

            // Processa Invent치rio (USA: Unidade, Local, Item)
            globalInventarioData.forEach(item => {
                const unidade = normalizeString(item['Unidade'] || 'Sem Unidade');
                
                // NOVO: Pula o item se n칚o for da unidade selecionada (e n칚o for 'all')
                if (selectedUnit !== 'all' && unidade !== selectedUnit) return;
                
                const local = normalizeString(item['Local'] || 'Sem Local');
                const desc = normalizeString(item['Item'] || 'Sem Descri칞칚o');
                const compositeKey = `${unidade}|${local}|${desc}`;
                
                allCompositeKeys.add(compositeKey);
                inventarioMap.set(compositeKey, (inventarioMap.get(compositeKey) || 0) + 1);
            });
            
            // Processa Sistema (USA: Unidade, Localiza칞칚o, Descri칞칚o)
            globalSistemaData.forEach(item => {
                const unidade = normalizeString(item['Unidade'] || 'Sem Unidade');
                
                // NOVO: Pula o item se n칚o for da unidade selecionada (e n칚o for 'all')
                if (selectedUnit !== 'all' && unidade !== selectedUnit) return;

                const local = normalizeString(item['Localiza칞칚o'] || 'Sem Local');
                const desc = normalizeString(item['Descri칞칚o'] || 'Sem Descri칞칚o');
                const compositeKey = `${unidade}|${local}|${desc}`;

                allCompositeKeys.add(compositeKey);
                sistemaMap.set(compositeKey, (sistemaMap.get(compositeKey) || 0) + 1);
            });

            // Gera o relat칩rio de auditoria
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';
            
            const sortedKeys = [...allCompositeKeys].sort();

            for (const compositeKey of sortedKeys) {
                // Ignora chaves "vazias"
                if (compositeKey === "sem unidade|sem local|sem descri칞칚o") continue;
                
                const [unidade, local, desc] = compositeKey.split('|');
                const qtdInv = inventarioMap.get(compositeKey) || 0;
                const qtdSis = sistemaMap.get(compositeKey) || 0;
                const diff = qtdInv - qtdSis;

                // Atualiza totais do resumo
                totalInv += qtdInv;
                totalSis += qtdSis;

                if (qtdInv > 0 || qtdSis > 0) { // S칩 mostra se houver item em pelo menos uma lista
                    const auditRow = {
                        unidade: unidade,
                        local: local,
                        desc: desc,
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    };
                    auditData.push(auditRow); // Salva para exporta칞칚o
                    
                    let rowClass = 'bg-white';
                    let diffClass = 'text-gray-700';
                    if (diff > 0) {
                        rowClass = 'bg-green-50'; // Mais no Invent치rio (Falta no Sistema)
                        diffClass = 'text-green-700 font-bold';
                    } else if (diff < 0) {
                        rowClass = 'bg-red-50'; // Menos no Invent치rio (Sobra no Sistema)
                        diffClass = 'text-red-700 font-bold';
                    }

                    const row = document.createElement('tr');
                    row.className = `${rowClass} hover:bg-gray-100`;
                    row.innerHTML = `
                        <td class="p-3 font-medium text-gray-900">${unidade}</td>
                        <td class="p-3 font-medium text-gray-900">${local}</td>
                        <td class="p-3 text-sm text-gray-700">${desc}</td>
                        <td class="p-3 text-sm text-gray-700">${qtdInv}</td>
                        <td class="p-3 text-sm text-gray-700">${qtdSis}</td>
                        <td class="p-3 text-sm ${diffClass}">${diff > 0 ? '+' : ''}${diff}</td>
                    `;
                    resultsBody.appendChild(row);
                }
            }
            
            // NOVO: Atualiza T칤tulos e Resumo
            const unitText = selectedUnit === 'all' ? 'Geral (Todas as Unidades)' : selectedUnit.toUpperCase();
            document.getElementById('report-title').textContent = `Relat칩rio de Auditoria: ${unitText}`;
            document.getElementById('report-subtitle').textContent = `Compara칞칚o de quantidade de itens para ${selectedUnit === 'all' ? 'todas as unidades' : 'a unidade ' + unitText}.`;
            
            document.getElementById('summary-inv').textContent = totalInv;
            document.getElementById('summary-sis').textContent = totalSis;
            const totalDiff = totalInv - totalSis;
            document.getElementById('summary-diff').textContent = `${totalDiff > 0 ? '+' : ''}${totalDiff}`;
        }


        // Fun칞칚o para exportar CSV (modo 칰nico de auditoria)
        function exportCSV() {
            let csvContent = '';
            const selectedUnit = document.getElementById('unit-filter').value;
            let filename = `Auditoria_de_Quantidade_${selectedUnit === 'all' ? 'Geral' : selectedUnit}.csv`;

            // Exporta Relat칩rio SEM TOMBO
            const headers = ['Unidade', 'Local', 'Descricao', 'Qtd_Inventario', 'Qtd_Sistema', 'Diferenca'];
            csvContent = headers.join(';') + '\n';
            
            auditData.forEach(item => {
                const values = [
                    (item.unidade || '').replace(/;/g, ','),
                    (item.local || '').replace(/;/g, ','),
                    (item.desc || '').replace(/;/g, ','),
                    item.qtdInv,
                    item.qtdSis,
                    item.diff
                ];
                csvContent += values.join(';') + '\n';
            });

            // L칩gica de Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                console.error("Download is not supported in this browser.");
            }
        }

        // Adiciona listener para atualizar a contagem E o filtro de unidade
        function setupDataListeners() {
            const inventarioTextarea = document.getElementById('list-inventario');
            const sistemaTextarea = document.getElementById('list-sistema');
            
            const handleInput = () => {
                 globalInventarioData = parseData(inventarioTextarea.value);
                 globalSistemaData = parseData(sistemaTextarea.value);
                 
                 document.getElementById('count-inventario').textContent = `Total de Itens no Invent치rio: ${globalInventarioData.length}`;
                 document.getElementById('count-sistema').textContent = `Total de Itens no Sistema: ${globalSistemaData.length}`;
                 
                 updateUnitFilter(); // Atualiza o filtro de unidade
            };
            
            inventarioTextarea.addEventListener('input', handleInput);
            sistemaTextarea.addEventListener('input', handleInput);
        }
        window.onload = setupDataListeners;

    </script>
</body>
</html>

