<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Quantidade por Local</title>
    <!-- Carregando Tailwind CSS para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Definindo a fonte padr√£o e ajustes visuais */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        textarea {
            height: 250px; 
            @apply shadow-inner;
        }
        /* Responsividade da tabela */
        @media (max-width: 640px) {
            .responsive-table th, .responsive-table td {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
                font-size: 0.75rem; /* extra small */
            }
        }
        .table-container { max-height: 700px; } /* Altura m√°xima para rolagem na tabela */

        /* Estilos do Modal */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', /* Esmeralda */
                        'primary-dark': '#059669',
                        'inventario': '#3b82f6', /* Azul */
                        'sistema': '#f97316', /* Laranja */
                        'export': '#d946ef', /* F√∫csia */
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 border-b-4 border-primary pb-2 flex items-center">
            Analisador de Quantidade por Local üìä
        </h1>
        <p class="text-gray-600 mb-6">
            Cole os dados para auditar a **contagem total de itens por local**. O sistema mostrar√° as diferen√ßas e permitir√° clicar para ver os detalhes.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Invent√°rio (Fonte) -->
            <div>
                <label for="list-inventario" class="block text-lg font-semibold text-inventario mb-2 flex items-center">
                    <span class="mr-2">üìã</span>
                    1. Dados do Invent√°rio (Fonte da Verdade)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Usar√° as colunas:** Unidade, Local, Item
                </p>
                <textarea id="list-inventario" class="w-full p-3 border border-inventario rounded-lg focus:ring-inventario focus:border-inventario transition duration-150" placeholder="Cole aqui os dados do Invent√°rio, incluindo o cabe√ßalho..."></textarea>
                <span id="count-inventario" class="text-sm text-gray-500 mt-1 block">Total de Linhas no Invent√°rio: 0</span>
            </div>
            
            <!-- Sistema (Destino) -->
            <div>
                <label for="list-sistema" class="block text-lg font-semibold text-sistema mb-2 flex items-center">
                    <span class="mr-2">‚öôÔ∏è</span>
                    2. Dados do Sistema (Estoque Atual)
                </label>
                <p class="text-xs text-gray-500 mb-1">
                    **Usar√° as colunas:** Unidade, Localiza√ß√£o, Descri√ß√£o
                </p>
                <textarea id="list-sistema" class="w-full p-3 border border-sistema rounded-lg focus:ring-sistema focus:border-sistema transition duration-150" placeholder="Cole aqui os dados do Sistema, incluindo o cabe√ßalho..."></textarea>
                <span id="count-sistema" class="text-sm text-gray-500 mt-1 block">Total de Linhas no Sistema: 0</span>
            </div>
        </div>

        <!-- BOT√ÉO DE A√á√ÉO √öNICO -->
        <div class="mb-8">
             <button onclick="runMasterCount()" class="w-full px-6 py-3 bg-primary text-white font-bold text-lg rounded-xl shadow-lg hover:bg-primary-dark transition duration-300 transform hover:scale-[1.01]">
                Analisar Contagem de Itens por Local
            </button>
        </div>
        
        
        <!-- Container de Resultados - Auditoria de Quantidade -->
        <div id="results-container" class="mt-12 hidden">
            <h2 id="report-title" class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-primary pb-2">
                Relat√≥rio de Auditoria de Quantidade
            </h2>

            <!-- FILTRO DE UNIDADE (Agora DENTRO do resultado) -->
            <div id="filter-container" class="mb-6 hidden">
                <label for="unit-filter" class="block text-lg font-semibold text-gray-700 mb-2">
                    Filtrar por Unidade (CRAS):
                </label>
                <select id="unit-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 bg-white" onchange="filterResultCards(this.value)">
                    <option value="all">-- Todas as Unidades --</option>
                    <!-- Op√ß√µes de unidade ser√£o preenchidas dinamicamente -->
                </select>
            </div>
            
            <!-- Export Button -->
            <button onclick="exportCSV()" class="w-full md:w-auto px-6 py-2 bg-export text-white font-bold rounded-lg shadow-md hover:bg-fuchsia-700 transition duration-300 transform hover:scale-[1.01] mb-4">
                Exportar Auditoria CSV
            </button>
            
            <!-- Resumo de Totais (Ser√° atualizado pelo filtro) -->
            <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="summary-inv">0</div>
                    <div class="text-sm font-semibold text-gray-600">Total Itens (Invent√°rio)</div>
                </div>
                 <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-orange-600" id="summary-sis">0</div>
                    <div class="text-sm font-semibold text-gray-600">Total Itens (Sistema)</div>
                </div>
                 <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg shadow">
                    <div class="text-3xl font-bold text-gray-700" id="summary-diff">0</div>
                    <div class="text-sm font-semibold text-gray-600">Diferen√ßa L√≠quida (Inv - Sis)</div>
                </div>
            </div>

            <!-- Container de Cards de Discrep√¢ncia -->
            <h3 class="text-xl font-bold text-gray-800 mb-4">
                Discrep√¢ncias Encontradas (Clique no card para ver os itens)
            </h3>
            <p id="no-discrepancy-message" class="text-gray-600 text-center p-6 bg-gray-50 rounded-lg hidden">
                üéâ Nenhuma discrep√¢ncia encontrada para esta sele√ß√£o!
            </p>
            <div id="discrepancy-cards-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Cards de discrep√¢ncia clic√°veis ser√£o injetados aqui -->
            </div>
        </div>
    </div>

    <!-- MODAL (Janela) para Detalhes dos Itens -->
    <div id="item-details-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0" onclick="closeModal()">
        <div class="modal-content bg-white w-full max-w-4xl rounded-xl shadow-2xl p-6 md:p-8 transform scale-95" onclick="event.stopPropagation()">
            <!-- Cabe√ßalho do Modal -->
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <div>
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Detalhes dos Itens</h2>
                    <p id="modal-subtitle" class="text-gray-600"></p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            
            <!-- Conte√∫do do Modal (Listas Lado a Lado) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Lista Invent√°rio -->
                <div>
                    <h3 id="modal-inv-title" class="text-lg font-semibold text-inventario mb-2">Itens no Invent√°rio (0)</h3>
                    <ul id="modal-inv-list" class="list-disc list-inside bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-gray-700 space-y-1">
                        <!-- Itens do Invent√°rio aqui -->
                    </ul>
                </div>
                <!-- Lista Sistema -->
                <div>
                    <h3 id="modal-sis-title" class="text-lg font-semibold text-sistema mb-2">Itens no Sistema (0)</h3>
                    <ul id="modal-sis-list" class="list-disc list-inside bg-orange-50 border border-orange-200 rounded-lg p-4 text-sm text-gray-700 space-y-1">
                        <!-- Itens do Sistema aqui -->
                    </ul>
                </div>
            </div>
            
            <!-- Rodap√© do Modal -->
            <div class="mt-6 text-right border-t pt-4">
                <button onclick="closeModal()" class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>


    <script>
        // Global variable for storing audit data
        let auditData = []; // Para a auditoria de quantidade
        let globalInventarioData = [];
        let globalSistemaData = [];
        let uniqueUnits = new Set();
        // Armazena os dados completos da auditoria, incluindo listas de itens
        let discrepancyDetails = new Map();

        
        // Fun√ß√£o de normaliza√ß√£o B√ÅSICA (apenas remove acentos, min√∫sculas, espa√ßos extras)
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            let s = str.toLowerCase();
            // 1. Remove acentos
            s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            // 2. Remove caracteres especiais
            s = s.replace(/[-/.,]/g, ' '); 
            // 3. Remove espa√ßos extras
            s = s.replace(/\s+/g, ' ').trim(); 
            return s;
        }

        // Fun√ß√£o para detetar o separador (v√≠rgula, ponto e v√≠rgula, ou tab) e parsear os dados
        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const firstLine = lines[0];
            let separator = '\t'; // Tentativa padr√£o: Tab

            // Conta a frequ√™ncia de cada separador na primeira linha
            const counts = { ',': (firstLine.match(/,/g) || []).length, ';': (firstLine.match(/;/g) || []).length, '\t': (firstLine.match(/\t/g) || []).length };
            
            // Escolhe o separador com maior contagem (se for maior que zero)
            if (counts[';'] > counts[','] && counts[';'] > counts['\t']) {
                separator = ';';
            } else if (counts[','] > counts[';'] && counts[','] > counts['\t']) {
                separator = ',';
            } else if (counts['\t'] > 0) {
                 separator = '\t';
            }

            const rawHeaders = lines[0].split(separator).map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.trim());
                if (values.length === rawHeaders.length) {
                    const item = {};
                    rawHeaders.forEach((header, index) => {
                        // Encontra o cabe√ßalho original (mantendo case)
                        const originalHeader = rawHeaders.find(h => normalizeString(h) === normalizeString(header));
                        item[originalHeader || header] = values[index];
                    });
                    data.push(item);
                }
            }
            return data;
        }

        // Fun√ß√£o para PREENCHER o filtro de unidades (n√£o mais atualizar)
        function populateUnitFilter() {
            uniqueUnits = new Set();
            const filterSelect = document.getElementById('unit-filter');
            const filterContainer = document.getElementById('filter-container');

            // Encontra o nome da coluna "Unidade" em ambas as listas
            const invHeader = (globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : []);
            const invUnitCol = invHeader.find(k => normalizeString(k) === 'unidade');
            
            const sisHeader = (globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : []);
            const sisUnitCol = sisHeader.find(k => normalizeString(k) === 'unidade');
            
            globalInventarioData.forEach(item => {
                if(invUnitCol) uniqueUnits.add(normalizeString(item[invUnitCol] || ''));
            });
            globalSistemaData.forEach(item => {
                if(sisUnitCol) uniqueUnits.add(normalizeString(item[sisUnitCol] || ''));
            });

            // Limpa unidades vazias
            uniqueUnits.delete('');
            uniqueUnits.delete('sem unidade');

            // Limpa op√ß√µes antigas (mantendo a primeira)
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }
            
            const sortedUnits = [...uniqueUnits].sort();
            sortedUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit.toUpperCase(); // Mostra em mai√∫sculo para ficar mais claro
                filterSelect.appendChild(option);
            });
            
            if (sortedUnits.length > 0) {
                filterContainer.classList.remove('hidden');
            } else {
                filterContainer.classList.add('hidden');
            }
        }
        
        // --- FLUXO √öNICO: Auditoria de Quantidade Mestra ---
        function runMasterCount() {
            document.getElementById('results-container').classList.add('hidden');
            
            // Sempre (re)carrega os dados dos textareas
            globalInventarioData = parseData(document.getElementById('list-inventario').value);
            globalSistemaData = parseData(document.getElementById('list-sistema').value);
            
            if (globalInventarioData.length === 0 && globalSistemaData.length === 0) {
                alert("Por favor, cole os dados nas duas caixas antes de analisar.");
                return;
            }

            // Mostra o container de resultados
            document.getElementById('results-container').classList.remove('hidden');

            // PREENCHE o filtro de unidades (nova l√≥gica)
            populateUnitFilter(); 
            // Reseta o filtro para "Todas as Unidades"
            document.getElementById('unit-filter').value = 'all';

            const inventarioMap = new Map(); // Map<"unidade|local", { count: 0, items: [] }>
            const sistemaMap = new Map();
            const allCompositeKeys = new Set();
            auditData = []; // Limpa auditoria anterior
            discrepancyDetails.clear(); // Limpa detalhes anteriores
            
            // Encontra os nomes das colunas
            const invHeader = (globalInventarioData.length > 0 ? Object.keys(globalInventarioData[0]) : []);
            const invUnitCol = invHeader.find(k => normalizeString(k) === 'unidade');
            const invLocalCol = invHeader.find(k => normalizeString(k) === 'local');
            const invItemCol = invHeader.find(k => normalizeString(k) === 'item'); // Novo: Coluna do Item
            
            const sisHeader = (globalSistemaData.length > 0 ? Object.keys(globalSistemaData[0]) : []);
            const sisUnitCol = sisHeader.find(k => normalizeString(k) === 'unidade');
            const sisLocalCol = sisHeader.find(k => normalizeString(k) === 'localizacao') || sisHeader.find(k => normalizeString(k) === 'local');
            const sisItemCol = sisHeader.find(k => normalizeString(k) === 'descricao') || sisHeader.find(k => normalizeString(k) === 'item'); // Novo: Coluna da Descri√ß√£o

            if (!invLocalCol || !sisLocalCol) {
                alert("Erro: N√£o foi poss√≠vel encontrar as colunas 'Local' (na Lista 1) e 'Localiza√ß√£o' (na Lista 2). Verifique os cabe√ßalhos.");
                return;
            }
             if (!invItemCol || !sisItemCol) {
                alert("Aviso: N√£o foi poss√≠vel encontrar as colunas 'Item' (Lista 1) ou 'Descri√ß√£o' (Lista 2). O detalhamento de itens pode ficar vazio.");
            }

            // Processa Invent√°rio (USA: Unidade, Local, Item)
            globalInventarioData.forEach(item => {
                const unidade = invUnitCol ? normalizeString(item[invUnitCol] || 'Sem Unidade') : 'sem unidade';
                const local = normalizeString(item[invLocalCol] || 'Sem Local');
                const itemName = invItemCol ? (item[invItemCol] || 'Item sem nome') : 'Item sem nome';
                const compositeKey = `${unidade}|${local}`;
                
                allCompositeKeys.add(compositeKey);
                
                if (!inventarioMap.has(compositeKey)) {
                    inventarioMap.set(compositeKey, { count: 0, items: [] });
                }
                const data = inventarioMap.get(compositeKey);
                data.count++;
                data.items.push(itemName);
            });
            
            // Processa Sistema (USA: Unidade, Localiza√ß√£o, Descri√ß√£o)
            globalSistemaData.forEach(item => {
                const unidade = sisUnitCol ? normalizeString(item[sisUnitCol] || 'Sem Unidade') : 'sem unidade';
                const local = normalizeString(item[sisLocalCol] || 'Sem Local');
                const itemName = sisItemCol ? (item[sisItemCol] || 'Item sem nome') : 'Item sem nome';
                const compositeKey = `${unidade}|${local}`;

                allCompositeKeys.add(compositeKey);

                if (!sistemaMap.has(compositeKey)) {
                    sistemaMap.set(compositeKey, { count: 0, items: [] });
                }
                const data = sistemaMap.get(compositeKey);
                data.count++;
                data.items.push(itemName);
            });

            // Gera o relat√≥rio de auditoria (APENAS os dados)
            // A renderiza√ß√£o dos cards agora √© feita por filterResultCards()
            
            const sortedKeys = [...allCompositeKeys].sort();

            for (const compositeKey of sortedKeys) {
                // Ignora chaves "vazias"
                if (compositeKey === "sem unidade|sem local") continue;
                
                const [unidade, local] = compositeKey.split('|');
                
                const invData = inventarioMap.get(compositeKey) || { count: 0, items: [] };
                const sisData = sistemaMap.get(compositeKey) || { count: 0, items: [] };
                
                const qtdInv = invData.count;
                const qtdSis = sisData.count;
                const diff = qtdInv - qtdSis;

                // Processa se existir em qualquer lista
                if (qtdInv > 0 || qtdSis > 0) { 
                    
                    // 1. Salva para exporta√ß√£o E filtragem
                    const auditRow = {
                        key: compositeKey, // Chave para o modal
                        unidade: unidade,
                        local: local,
                        qtdInv: qtdInv,
                        qtdSis: qtdSis,
                        diff: diff
                    };
                    auditData.push(auditRow); // Salva para exporta√ß√£o e filtragem

                    // 2. Armazena os detalhes para o modal (SE houver diferen√ßa)
                    if (diff !== 0) {
                        discrepancyDetails.set(compositeKey, {
                            unidade: unidade,
                            local: local,
                            invItems: invData.items.sort(),
                            sisItems: sisData.items.sort()
                        });
                    }
                }
            }
            
            // CHAMA O FILTRO pela primeira vez (mostrando 'all')
            filterResultCards('all');
        }

        // NOVO: Fun√ß√£o para FILTRAR e RENDERIZAR os cards e o resumo
        function filterResultCards(selectedUnit) {
            const cardsContainer = document.getElementById('discrepancy-cards-container');
            const noDiscrepancyMsg = document.getElementById('no-discrepancy-message');
            cardsContainer.innerHTML = '';
            
            let totalInv = 0;
            let totalSis = 0;
            let hasDiscrepancy = false;

            // Filtra os dados da auditoria
            const filteredData = (selectedUnit === 'all') 
                ? auditData 
                : auditData.filter(item => item.unidade === selectedUnit);

            for (const item of filteredData) {
                // 1. Atualiza totais do resumo
                totalInv += item.qtdInv;
                totalSis += item.qtdSis;

                // 2. Cria o card APENAS SE houver discrep√¢ncia
                if (item.diff !== 0) {
                    hasDiscrepancy = true;
                    
                    let cardClass = 'bg-white border-gray-300';
                    let diffClass = 'text-gray-700';
                    let diffText = `${item.diff > 0 ? '+' : ''}${item.diff}`;
                    
                    if (item.diff > 0) { // Falta no Sistema
                        cardClass = 'bg-green-50 border-green-300';
                        diffClass = 'text-green-600';
                    } else { // Sobra no Sistema
                        cardClass = 'bg-red-50 border-red-300';
                        diffClass = 'text-red-600';
                    }
                    
                    // O card agora √© um <button>
                    const card = document.createElement('button');
                    // Adiciona data-unidade para o filtro (embora o JS j√° filtre, isso √© bom para CSS se necess√°rio)
                    card.setAttribute('data-unidade', item.unidade); 
                    card.className = `p-4 border rounded-lg shadow-md text-left transition-transform transform hover:scale-105 ${cardClass}`;
                    card.setAttribute('onclick', `openModal('${item.key}')`);
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-gray-800">${item.local}</h3>
                        <p class="text-sm text-gray-600 mb-3">${item.unidade}</p>
                        <div class="flex justify-between items-center text-center px-2">
                            <div>
                                <span class="block text-2xl font-bold text-blue-600">${item.qtdInv}</span>
                                <span class="text-xs font-semibold text-gray-500">Invent√°rio</span>
                            </div>
                            <div>
                                <span class="block text-2xl font-bold text-orange-600">${item.qtdSis}</span>
                                <span class="text-xs font-semibold text-gray-500">Sistema</span>
                            </div>
                            <div>
                                <span class="block text-2xl font-bold ${diffClass}">${diffText}</span>
                                <span class="text-xs font-semibold text-gray-500">Diferen√ßa</span>
                            </div>
                        </div>
                    `;
                    cardsContainer.appendChild(card);
                }
            }
            
            // Mostra mensagem se n√£o houver discrep√¢ncias
            if (!hasDiscrepancy) {
                noDiscrepancyMsg.classList.remove('hidden');
            } else {
                noDiscrepancyMsg.classList.add('hidden');
            }

            // Atualiza T√≠tulos e Resumo
            const unitText = selectedUnit === 'all' ? 'Geral (Todas as Unidades)' : selectedUnit.toUpperCase();
            document.getElementById('report-title').textContent = `Relat√≥rio de Auditoria: ${unitText}`;
            
            document.getElementById('summary-inv').textContent = totalInv;
            document.getElementById('summary-sis').textContent = totalSis;
            const totalDiff = totalInv - totalSis;
            document.getElementById('summary-diff').textContent = `${totalDiff > 0 ? '+' : ''}${totalDiff}`;
        }


        // --- Fun√ß√µes do MODAL ---
        function openModal(compositeKey) {
            const details = discrepancyDetails.get(compositeKey);
            if (!details) return;

            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');

            // Preenche T√≠tulos
            document.getElementById('modal-title').textContent = `Detalhes de: ${details.local.toUpperCase()}`;
            document.getElementById('modal-subtitle').textContent = `Unidade: ${details.unidade.toUpperCase()}`;

            // Preenche Lista Invent√°rio
            const invList = document.getElementById('modal-inv-list');
            invList.innerHTML = '';
            document.getElementById('modal-inv-title').textContent = `Itens no Invent√°rio (${details.invItems.length})`;
            if (details.invItems.length === 0) {
                invList.innerHTML = '<li class="text-gray-500 italic">Nenhum item encontrado.</li>';
            } else {
                details.invItems.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    invList.appendChild(li);
                });
            }

            // Preenche Lista Sistema
            const sisList = document.getElementById('modal-sis-list');
            sisList.innerHTML = '';
            document.getElementById('modal-sis-title').textContent = `Itens no Sistema (${details.sisItems.length})`;
             if (details.sisItems.length === 0) {
                sisList.innerHTML = '<li class="text-gray-500 italic">Nenhum item encontrado.</li>';
            } else {
                details.sisItems.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    sisList.appendChild(li);
                });
            }

            // Exibe o Modal com anima√ß√£o
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('item-details-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250); // Aguarda a transi√ß√£o de opacidade terminar
        }


        // Fun√ß√£o para exportar CSV (modo √∫nico de auditoria)
        function exportCSV() {
            let csvContent = '';
            const selectedUnit = document.getElementById('unit-filter').value;
            let filename = `Auditoria_de_Quantidade_${selectedUnit === 'all' ? 'Geral' : selectedUnit}.csv`;

            // Filtra os dados que ser√£o exportados
            const filteredData = (selectedUnit === 'all') 
                ? auditData 
                : auditData.filter(item => item.unidade === selectedUnit);

            // Exporta Relat√≥rio SEM TOMBO
            const headers = ['Unidade', 'Local', 'Qtd_Inventario', 'Qtd_Sistema', 'Diferenca'];
            csvContent = headers.join(';') + '\n';
            
            filteredData.forEach(item => {
                const values = [
                    (item.unidade || '').replace(/;/g, ','),
                    (item.local || '').replace(/;/g, ','),
                    item.qtdInv,
                    item.qtdSis,
                    item.diff
                ];
                csvContent += values.join(';') + '\n';
            });

            // L√≥gica de Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                console.error("Download is not supported in this browser.");
            }
        }

        // Adiciona listener para atualizar a contagem
        function setupDataListeners() {
            const inventarioTextarea = document.getElementById('list-inventario');
            const sistemaTextarea = document.getElementById('list-sistema');
            
            const handleInput = () => {
                 // Apenas atualiza a contagem. O parse completo ser√° no "Analisar"
                 const invLines = inventarioTextarea.value.trim().split('\n').filter(Boolean).length;
                 const sisLines = sistemaTextarea.value.trim().split('\n').filter(Boolean).length;
                 
                 // Subtrai 1 se tiver mais que 0 (para o cabe√ßalho)
                 document.getElementById('count-inventario').textContent = `Total de Linhas no Invent√°rio: ${invLines > 0 ? invLines - 1 : 0}`;
                 document.getElementById('count-sistema').textContent = `Total de Linhas no Sistema: ${sisLines > 0 ? sisLines - 1 : 0}`;
            };
            
            inventarioTextarea.addEventListener('input', handleInput);
            sistemaTextarea.addEventListener('input', handleInput);
        }
        window.onload = setupDataListeners;

    </script>
</body>
</html>

